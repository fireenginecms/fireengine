(()=>{var e,t,s={16:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/keys")},41:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/includes")},86:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/filter")},128:(e,t,s)=>{"use strict";s.d(t,{Jk:()=>O,_m:()=>R});var r=s(497),n=s.n(r),i=s(405),a=s.n(i),o=s(718),l=s.n(o),c=s(691),d=s.n(c),u=s(471),p=s.n(u),g=s(668),f=s.n(g),m=s(16),h=s.n(m),E=s(240),v=s.n(E),I=s(86),y=s.n(I),_=s(982),b=s.n(_),w=s(335),N=s.n(w),F=s(464),A=s.n(F);function j(e,t){var s=h()(e);if(n()){var r=n()(e);t&&(r=y()(r).call(r,function(t){return a()(e,t).enumerable})),s.push.apply(s,r)}return s}function S(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?N()(s=j(Object(n),!0)).call(s,function(t){f()(e,t,n[t])}):l()?d()(e,l()(n)):N()(r=j(Object(n))).call(r,function(t){p()(e,t,a()(n,t))})}return e}const C=(e,t)=>process.env[`FIREENGINE_${e}`]||(t?process.env[t]:void 0),P=e=>{if(e)try{return JSON.parse(e)}catch(e){return void console.error("Error parsing JSON environment variable:",e)}},D=()=>{const e={},t=(()=>{const e={};process.env.FIREENGINE_ADMIN_TYPE&&(e.type=process.env.FIREENGINE_ADMIN_TYPE);const t=C("FIREBASE_PROJECT_ID","FIREBASE_PROJECT_ID");t&&(e.project_id=t),process.env.FIREENGINE_ADMIN_PRIVATE_KEY_ID&&(e.private_key_id=process.env.FIREENGINE_ADMIN_PRIVATE_KEY_ID);const s=C("ADMIN_PRIVATE_KEY")||C("FIREBASE_PRIVATE_KEY","FIREBASE_PRIVATE_KEY");s&&(e.private_key=s.replace(/\\n/g,"\n"));const r=C("ADMIN_CLIENT_EMAIL")||C("FIREBASE_CLIENT_EMAIL","FIREBASE_CLIENT_EMAIL");if(r&&(e.client_email=r),process.env.FIREENGINE_ADMIN_CLIENT_ID&&(e.client_id=process.env.FIREENGINE_ADMIN_CLIENT_ID),process.env.FIREENGINE_ADMIN_AUTH_URI&&(e.auth_uri=process.env.FIREENGINE_ADMIN_AUTH_URI),process.env.FIREENGINE_ADMIN_TOKEN_URI&&(e.token_uri=process.env.FIREENGINE_ADMIN_TOKEN_URI),process.env.FIREENGINE_ADMIN_AUTH_PROVIDER_X509_CERT_URL&&(e.auth_provider_x509_cert_url=process.env.FIREENGINE_ADMIN_AUTH_PROVIDER_X509_CERT_URL),process.env.FIREENGINE_ADMIN_CLIENT_X509_CERT_URL&&(e.client_x509_cert_url=process.env.FIREENGINE_ADMIN_CLIENT_X509_CERT_URL),process.env.FIREENGINE_ADMIN_UNIVERSE_DOMAIN&&(e.universe_domain=process.env.FIREENGINE_ADMIN_UNIVERSE_DOMAIN),process.env.FIREENGINE_ADMIN_CREDENTIALS_JSON)try{return JSON.parse(process.env.FIREENGINE_ADMIN_CREDENTIALS_JSON)}catch(e){console.error("Error parsing FIREENGINE_ADMIN_CREDENTIALS_JSON:",e)}return process.env.FIREENGINE_ADMIN_CREDENTIALS_FILE?process.env.FIREENGINE_ADMIN_CREDENTIALS_FILE:h()(e).length>0?e:void 0})();t&&(e.adminCredentials=t);const s=(()=>{const e={};process.env.FIREENGINE_WEBAPP_API_KEY&&(e.apiKey=process.env.FIREENGINE_WEBAPP_API_KEY),process.env.FIREENGINE_WEBAPP_AUTH_DOMAIN&&(e.authDomain=process.env.FIREENGINE_WEBAPP_AUTH_DOMAIN);const t=C("FIREBASE_PROJECT_ID","FIREBASE_PROJECT_ID");if(t&&(e.projectId=t),process.env.FIREENGINE_WEBAPP_STORAGE_BUCKET&&(e.storageBucket=process.env.FIREENGINE_WEBAPP_STORAGE_BUCKET),process.env.FIREENGINE_WEBAPP_MESSAGING_SENDER_ID&&(e.messagingSenderId=process.env.FIREENGINE_WEBAPP_MESSAGING_SENDER_ID),process.env.FIREENGINE_WEBAPP_APP_ID&&(e.appId=process.env.FIREENGINE_WEBAPP_APP_ID),process.env.FIREENGINE_WEBAPP_MEASUREMENT_ID&&(e.measurementId=process.env.FIREENGINE_WEBAPP_MEASUREMENT_ID),process.env.FIREENGINE_WEBAPP_CONFIG_JSON)try{return JSON.parse(process.env.FIREENGINE_WEBAPP_CONFIG_JSON)}catch(e){console.error("Error parsing FIREENGINE_WEBAPP_CONFIG_JSON:",e)}return process.env.FIREENGINE_WEBAPP_CONFIG_FILE?process.env.FIREENGINE_WEBAPP_CONFIG_FILE:h()(e).length>0?e:void 0})();s&&(e.webappConfig=s);const r=C("FIRESTORE_DATABASE")||C("FIRESTORE_DATABASE_ID","FIRESTORE_DATABASE_ID");r&&(e.firestoreDatabase=r),process.env.FIREENGINE_OWNER_EMAIL&&(e.ownerEmail=process.env.FIREENGINE_OWNER_EMAIL);const n=(e=>{var t;if(!e)return;const s=v()(t=e.toLowerCase()).call(t);return"true"===s||"1"===s||"yes"===s||"false"!==s&&"0"!==s&&"no"!==s&&void 0})(process.env.FIREENGINE_USE_FIRESTORE_ACCESS_RULES);void 0!==n&&(e.useFirestoreAccessRules=n),process.env.FIREENGINE_GOOGLE_MAPS_API_KEY&&(e.googleMapsApiKey=process.env.FIREENGINE_GOOGLE_MAPS_API_KEY);const i=P(process.env.FIREENGINE_GOOGLE_MAPS_OPTIONS);i&&(e.googleMapsOptions=i);const a=(e=>{var t,s;if(e)return y()(t=b()(s=e.split(",")).call(s,e=>v()(e).call(e))).call(t,e=>e.length>0)})(process.env.FIREENGINE_IGNORE_COLLECTIONS);a&&(e.ignoreCollections=a);const o=P(process.env.FIREENGINE_SCHEMA_OVERRIDES);o&&(e.schemaOverrides=o);const l=P(process.env.FIREENGINE_SIGNIN_METHODS);return l&&(e.signinMethods=l),process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE&&(e.storageMaxUploadSize=process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE),e},R=e=>{const t=D(),s=S({},e);return t.adminCredentials&&(s.adminCredentials=t.adminCredentials),t.webappConfig&&(s.webappConfig=S(S({},e.webappConfig),t.webappConfig)),void 0!==t.firestoreDatabase&&(s.firestoreDatabase=t.firestoreDatabase),void 0!==t.ownerEmail&&(s.ownerEmail=t.ownerEmail),void 0!==t.useFirestoreAccessRules&&(s.useFirestoreAccessRules=t.useFirestoreAccessRules),void 0!==t.googleMapsApiKey&&(s.googleMapsApiKey=t.googleMapsApiKey),void 0!==t.googleMapsOptions&&(s.googleMapsOptions=S(S({},e.googleMapsOptions),t.googleMapsOptions)),void 0!==t.ignoreCollections&&(s.ignoreCollections=t.ignoreCollections),void 0!==t.schemaOverrides&&(s.schemaOverrides=S(S({},e.schemaOverrides),t.schemaOverrides)),void 0!==t.signinMethods&&(s.signinMethods=t.signinMethods),void 0!==t.storageMaxUploadSize&&(s.storageMaxUploadSize=t.storageMaxUploadSize),s},O=()=>{const e=D(),t=h()(e);t.length>0?(console.log("FireEngine: Detected environment variables:"),N()(t).call(t,t=>{"adminCredentials"===t?console.log(`  - ${t}: [Firebase Admin SDK credentials loaded]`):"webappConfig"===t?console.log(`  - ${t}: [Firebase Web App config loaded]`):console.log(`  - ${t}: ${A()(e[t])}`)})):console.log("FireEngine: No FIREENGINE_ environment variables detected")}},139:(e,t,s)=>{"use strict";s.d(t,{_A:()=>l,xL:()=>c});var r=s(965),n=s(675),i=s.n(n);let a,o=null;const l=e=>(a=e,o=null,!0),c=()=>{if(!o){if(!i().apps.length)throw new Error("Firebase Admin SDK not initialized. This usually means fireengine() hasn't been called yet or Firebase credentials are missing. Make sure you call fireengine(config) with proper adminCredentials before using any Firebase services.");o=a?(0,r.getFirestore)(i().app(),a):(0,r.getFirestore)(i().app())}return o}},240:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/trim")},253:e=>{"use strict";e.exports=require("firebase/app")},304:e=>{"use strict";e.exports=require("firebase/auth")},316:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/entries")},323:e=>{e.exports='<!DOCTYPE html> <html lang="en"> <head> <base href="{fireenging-base-path}/"> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1"/> <title>FireEngine</title> <link rel="icon" href="data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><text y=\'0.9em\' font-size=\'90\'>ðŸ”¥</text></svg>"> </head> <body> <noscript>You need to enable JavaScript to run this app.</noscript> <div id="root"></div> <script> var fireengineConfig = {fireengine-config}; <\/script> <script src="admin.js"><\/script> </body> </html> '},335:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/for-each")},405:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor")},464:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/json/stringify")},471:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/define-property")},497:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols")},575:(e,t,s)=>{"use strict";s.d(t,{PADDLE_CONFIG:()=>r});const r={licenseApiUrl:(()=>{try{return"https://license.fireengine.dev"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_LICENSE_API_URL||"https://license.fireengine.dev"})(),clientToken:(()=>{try{return"live_2cb28d6b5be3b98a622666387b4"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_CLIENT_TOKEN||"MISSING_PADDLE_CLIENT_TOKEN"})(),environment:"undefined"!=typeof process?"production":"sandbox",prices:{pro_monthly:(()=>{try{return"pri_01k2men96wsraycwnkr2682pky"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_PRICE_PRO_MONTHLY||"MISSING_PADDLE_PRICE_MONTHLY"})(),pro_annual:(()=>{try{return"pri_01k2meq2g0ye64acqynetdsef2"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_PRICE_PRO_ANNUAL||"MISSING_PADDLE_PRICE_ANNUAL"})()},products:{pro:{name:"FireEngine Pro",description:"Complete solution for growing teams and organizations",features:["Unlimited users","Advanced authentication (SAML, OIDC, Phone)","Custom roles and permissions","Schema customization","Unlimited storage","Analytics and audit logs","API access and webhooks","Custom branding","Priority support"],pricing:{monthly:{amount:54,currency:"USD"},annual:{amount:49,currency:"USD",totalAmount:588}}}}}},615:(e,t,s)=>{"use strict";s.d(t,{installationService:()=>G});var r=s(497),n=s.n(r),i=s(86),a=s.n(i),o=s(405),l=s.n(o),c=s(335),d=s.n(c),u=s(718),p=s.n(u),g=s(691),f=s.n(g),m=s(471),h=s.n(m),E=s(668),v=s.n(E),I=s(16),y=s.n(I),_=s(464),b=s.n(_),w=s(41),N=s.n(w),F=s(316),A=s.n(F),j=s(875),S=s.n(j);const C=require("uuid"),P=require("os"),D=require("crypto");var R=s(139);var O=s(128);function T(e,t){var s=y()(e);if(n()){var r=n()(e);t&&(r=a()(r).call(r,function(t){return l()(e,t).enumerable})),s.push.apply(s,r)}return s}function M(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?d()(s=T(Object(n),!0)).call(s,function(t){v()(e,t,n[t])}):p()?f()(e,p()(n)):d()(r=T(Object(n))).call(r,function(t){h()(e,t,l()(n,t))})}return e}class ${constructor(){v()(this,"installationCache",null),v()(this,"licenseCache",null),v()(this,"config",null)}getDb(){return(0,R.xL)()}setConfig(e){this.config=(0,O._m)(e||{})}async getInstallation(){if(this.installationCache)return this.installationCache;const e=this.getDb().collection("_fireengineMeta").doc("installation"),t=await e.get();if(t.exists){const e=M(M({},t.data()),{},{createdAt:t.data().createdAt.toDate()});return this.installationCache=e,e}const s=await this.createInstallation();return this.installationCache=s,s}async createInstallation(){const e=(0,C.v4)(),t=this.generateServerFingerprint(),s=this.detectDomain(),r=this.detectEnvironment(s),n={installationId:e,domain:s,createdAt:new Date,serverFingerprint:t,ownerEmail:this.config?.ownerEmail||"",version:"1.0.5",environment:r},i=this.getDb().collection("_fireengineMeta").doc("installation");return await i.set(n),n}generateServerFingerprint(){const e={hostname:P.hostname(),platform:P.platform(),arch:P.arch(),networkInterfaces:y()(P.networkInterfaces()),cpus:P.cpus().length};return D.createHash("sha256").update(b()(e)).digest("hex").substring(0,16)}detectDomain(){return process.env.FIREENGINE_DOMAIN||P.hostname()}detectEnvironment(e){return N()(e).call(e,"localhost")||N()(e).call(e,"127.0.0.1")?"development":N()(e).call(e,"staging")||N()(e).call(e,"dev")||N()(e).call(e,"test")?"staging":"production"}async getLicenseBinding(){if(this.licenseCache)return this.licenseCache;const e=this.getDb().collection("_fireengineMeta").doc("license"),t=await e.get();if(t.exists){const e=M(M({},t.data()),{},{lastValidated:t.data().lastValidated.toDate(),validUntil:t.data().validUntil?.toDate(),gracePeriodEnd:t.data().gracePeriodEnd?.toDate()});return this.licenseCache=e,e}const s={installationId:(await this.getInstallation()).installationId,plan:"free",status:"active",lastValidated:new Date,features:{advancedAuth:!1,customRoles:!1,schemaOverrides:!1,apiAccess:!1,unlimitedUsers:!1,unlimitedStorage:!1}};return await this.updateLicenseBinding(s),s}async updateLicenseBinding(e){const t={};for(const[s,r]of A()(e))void 0!==r&&(t[s]=r);const s=this.getDb().collection("_fireengineMeta").doc("license");await s.set(t),this.licenseCache=e}async canTransferInstallation(){const e=await this.getInstallation(),t=await this.getLicenseBinding();return S()()-e.createdAt.getTime()<864e5||"inactive"===t.status}async validateInstallation(){try{const e=await this.getInstallation(),t=this.generateServerFingerprint();return e.serverFingerprint!==t&&console.warn("âš ï¸  Server fingerprint changed - this might indicate installation transfer"),{valid:!0}}catch(e){return console.error("Installation validation failed:",e),{valid:!1,reason:"validation_error"}}}async getInstallationSummary(){const e=await this.getInstallation(),t=await this.getLicenseBinding();return{installationId:e.installationId,domain:e.domain,environment:e.environment,createdAt:e.createdAt,version:e.version,plan:t.plan,status:t.status,lastValidated:t.lastValidated,validUntil:t.validUntil}}clearCache(){this.installationCache=null,this.licenseCache=null}}let L=null;const G={setConfig:e=>{L||(L=new $),L.setConfig(e)},getInstallation:async()=>(L||(L=new $),L.getInstallation()),getLicenseBinding:async()=>(L||(L=new $),L.getLicenseBinding()),updateLicenseBinding:async e=>(L||(L=new $),L.updateLicenseBinding(e)),canTransferInstallation:async()=>(L||(L=new $),L.canTransferInstallation()),validateInstallation:async()=>(L||(L=new $),L.validateInstallation()),getInstallationSummary:async()=>(L||(L=new $),L.getInstallationSummary()),clearCache:()=>(L||(L=new $),L.clearCache())}},668:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/helpers/defineProperty")},675:e=>{"use strict";e.exports=require("firebase-admin")},691:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/define-properties")},718:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors")},737:(e,t,s)=>{"use strict";s.d(t,{default:()=>Yt,getFirestoreDatabaseName:()=>zt});var r=s(875),n=s.n(r),i=s(41),a=s.n(i);const o=require("@babel/runtime-corejs3/core-js-stable/instance/starts-with");var l=s.n(o),c=s(464),d=s.n(c),u=s(928),p=s.n(u);const g=require("express");var f=s.n(g),m=s(323),h=s.n(m);const E=require("compose-middleware"),v=require("@babel/runtime-corejs3/core-js-stable/array/is-array");var I=s.n(v),y=s(335),_=s.n(y),b=s(86),w=s.n(b),N=s(675),F=s.n(N),A=s(16),j=s.n(A),S=s(497),C=s.n(S),P=s(405),D=s.n(P),R=s(718),O=s.n(R),T=s(691),M=s.n(T),$=s(471),L=s.n($),G=s(668),U=s.n(G);function x(e,t){var s=j()(e);if(C()){var r=C()(e);t&&(r=w()(r).call(r,function(t){return D()(e,t).enumerable})),s.push.apply(s,r)}return s}let q={useFirestoreAccessRules:!1};const k=()=>q,B=()=>process.env.FIREENGINE_OWNER_EMAIL||q.ownerEmail,V=require("@babel/runtime-corejs3/core-js-stable/map");var K=s.n(V),W=s(615);let H=function(e){return e.FREE="free",e.PRO="pro",e}({});H.FREE,H.PRO;class J{constructor(){U()(this,"validationCache",new(K())),U()(this,"CACHE_TTL",36e5)}async validateLicense(){try{const e=await W.installationService.getInstallation(),t=await W.installationService.getLicenseBinding(),s=this.validationCache.get(e.installationId);if(s&&n()()-s.timestamp<this.CACHE_TTL)return s.result;const r=this.validateLocalLicense(t);return this.cacheResult(e.installationId,r),r}catch(e){return console.error("License validation failed:",e),this.fallbackValidation()}}validateLocalLicense(e){return e.validUntil&&new Date>e.validUntil?{valid:!1,reason:"license_expired",plan:H.FREE,features:this.getFreePlanFeatures()}:e.gracePeriodEnd&&this.isInGracePeriod(e.gracePeriodEnd)?{valid:!0,plan:this.mapPlanString(e.plan),features:e.features||this.getFreePlanFeatures(),gracePeriodEnd:e.gracePeriodEnd,reason:"grace_period"}:{valid:"active"===e.status,plan:this.mapPlanString(e.plan),features:e.features||this.getFreePlanFeatures(),validUntil:e.validUntil}}isInGracePeriod(e){return!!e&&new Date<e}fallbackValidation(){return{valid:!0,plan:H.FREE,features:this.getFreePlanFeatures(),reason:"fallback_mode"}}cacheResult(e,t){this.validationCache.set(e,{result:t,timestamp:n()()})}getFreePlanFeatures(){return{advancedAuth:!1,customRoles:!1,schemaOverrides:!1,apiAccess:!1,unlimitedUsers:!1,unlimitedStorage:!1,analytics:!1,auditLogs:!1,prioritySupport:!1,customBranding:!1,whiteLabel:!1}}getProPlanFeatures(){return{advancedAuth:!0,customRoles:!0,schemaOverrides:!0,apiAccess:!0,unlimitedUsers:!0,unlimitedStorage:!0,analytics:!0,auditLogs:!0,prioritySupport:!0,customBranding:!0,whiteLabel:!0}}mapPlanString(e){return"pro"===e.toLowerCase()?H.PRO:H.FREE}clearCache(){this.validationCache.clear()}}let z=null;const Y={validateLicense:async()=>(z||(z=new J),z.validateLicense()),clearCache(){z&&z.clearCache()}},X=(0,g.Router)({strict:!0}),Z=X;X.get("/auth/auth-providers",async(e,t)=>{try{const e=F().auth(),l={providers:{saml:[],oidc:[]},tenants:[],availableProviders:[],detectedSigninMethods:[]};if("function"==typeof e.listProviderConfigs)try{const t=await e.listProviderConfigs({type:"saml"});t&&I()(t.providerConfigs)&&(l.providers.saml=t.providerConfigs);const s=await e.listProviderConfigs({type:"oidc"});s&&I()(s.providerConfigs)&&(l.providers.oidc=s.providerConfigs)}catch(e){console.error("Error fetching provider configs:",e)}const c=[];try{"function"==typeof e.createUser&&(c.push({type:"SIGNIN_METHOD_EMAIL",signInWithEmailLink:!1,title:"Email & Password"}),c.push({type:"SIGNIN_METHOD_EMAIL",signInWithEmailLink:!0,title:"Email Link (Passwordless)"}))}catch(e){console.log("Email authentication detection failed:",e.message)}try{const e=process.env.FIREENGINE_WEBAPP_CONFIG?JSON.parse(process.env.FIREENGINE_WEBAPP_CONFIG):null;e?.authDomain&&c.push({type:"SIGNIN_METHOD_GOOGLE",title:"Google"})}catch(e){console.log("Google provider detection failed:",e.message)}var s,r;l.providers.saml.length>0&&_()(s=l.providers.saml).call(s,e=>{c.push({type:"SIGNIN_METHOD_SAML",providerId:e.providerId,title:e.displayName||e.providerId})}),l.providers.oidc.length>0&&_()(r=l.providers.oidc).call(r,e=>{c.push({type:"SIGNIN_METHOD_OIDC",providerId:e.providerId,title:e.displayName||e.providerId})}),l.detectedSigninMethods=c;try{var n;const t=[];if("function"==typeof e.createUser&&t.push("password"),"function"==typeof e.listProviderConfigs)try{const s=await e.listProviderConfigs({type:"saml"}),r=await e.listProviderConfigs({type:"oidc"});var i,o;s&&I()(s.providerConfigs)&&_()(i=s.providerConfigs).call(i,e=>{e.providerId&&t.push(e.providerId)}),r&&I()(r.providerConfigs)&&_()(o=r.providerConfigs).call(o,e=>{e.providerId&&t.push(e.providerId)})}catch(e){console.log("Error getting SAML/OIDC providers, using defaults:",e.message)}_()(n=["google.com","facebook.com","twitter.com","github.com","microsoft.com","apple.com"]).call(n,e=>{a()(t).call(t,e)||t.push(e)}),l.availableProviders=t}catch(e){console.error("Error getting available providers:",e)}try{if("function"==typeof e.tenantManager){const t=e.tenantManager();if(t&&"function"==typeof t.listTenants){const e=await t.listTenants();e&&I()(e.tenants)&&(l.tenants=e.tenants)}}}catch(e){console.log("Tenant manager not available:",e.message)}return t.json(l)}catch(e){return console.error("Error fetching auth providers:",e),t.status(500).json({error:"Failed to fetch auth providers",message:e.message})}}),X.get("/auth/detected-signin-methods",async(e,t)=>{try{if(!F().apps||0===F().apps.length)return t.status(503).json({error:"Firebase Admin SDK not initialized",message:"Please configure Firebase Admin credentials"});const e=F().auth(),a=[],o=q.webappConfig;try{if("function"==typeof e.listProviderConfigs){const t=await e.listProviderConfigs({type:"saml"});var r;t?.providerConfigs&&t.providerConfigs.length>0&&_()(r=t.providerConfigs).call(r,e=>{a.push({type:"SIGNIN_METHOD_SAML",providerId:e.providerId,title:e.displayName||e.providerId,enabled:e.enabled,metadata:{issuer:e.idpConfig?.idpEntityId,ssoUrl:e.idpConfig?.ssoUrl,certificates:e.idpConfig?.idpCertificates,requestUri:e.spConfig?.callbackUri}})});const s=await e.listProviderConfigs({type:"oidc"});var i;s?.providerConfigs&&s.providerConfigs.length>0&&_()(i=s.providerConfigs).call(i,e=>{a.push({type:"SIGNIN_METHOD_OIDC",providerId:e.providerId,title:e.displayName||e.providerId,enabled:e.enabled,metadata:{issuer:e.issuer,clientId:e.clientId,responseType:e.responseType,scopes:["openid","email","profile"],redirectUri:`https://${o?.authDomain}/__/auth/handler`}})})}}catch(e){}try{if("function"==typeof e.createUser&&o?.authDomain){let e=!1,t=!1;try{const{initializeApp:r,getApps:i}=await Promise.resolve().then(s.t.bind(s,253,23)),{getAuth:a,createUserWithEmailAndPassword:l,sendSignInLinkToEmail:c,deleteUser:d}=await Promise.resolve().then(s.t.bind(s,304,23));let u;i();const p=`test-auth-detection-${n()()}`;try{u=r(o,p);const s=a(u),i=`test-auth-${n()()}@fireengine-test.invalid`,g="TestPassword123!";try{const t=await l(s,i,g);if(e=!0,t.user)try{await d(t.user)}catch(e){}}catch(t){"auth/operation-not-allowed"===t.code&&(e=!1)}try{await c(s,i,{url:`https://${o.authDomain}`,handleCodeInApp:!0}),t=!0}catch(e){"auth/operation-not-allowed"===e.code&&(t=!1)}}finally{if(u)try{await u.delete()}catch(e){}}}catch(s){e=!1,t=!1}e&&t?a.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!0,supportsEmailLink:!0,title:"Email Authentication"}):e?a.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!0,supportsEmailLink:!1,signInWithEmailLink:!1,title:"Email & Password"}):t&&a.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!1,supportsEmailLink:!0,signInWithEmailLink:!0,title:"Email Link (Passwordless)"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!0}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_PHONE",title:"Phone"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{const{initializeApp:t}=await Promise.resolve().then(s.t.bind(s,253,23)),{getAuth:r,GoogleAuthProvider:i,signInWithCredential:a,GoogleAuthProvider:l}=await Promise.resolve().then(s.t.bind(s,304,23));let c;const d=`test-google-detection-${n()()}`;try{c=t(o,d);const s=r(c);new i;try{const t=i.credential("fake_id_token","fake_access_token");await a(s,t),e=!1}catch(t){e="auth/operation-not-allowed"!==t.code&&("auth/invalid-credential"===t.code||"auth/argument-error"===t.code||"auth/invalid-id-token"===t.code)}}finally{if(c)try{await c.delete()}catch(e){}}}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_GOOGLE",title:"Google"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_MICROSOFT",title:"Microsoft"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_APPLE",title:"Apple"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_GITHUB",title:"GitHub"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_FACEBOOK",title:"Facebook"})}}catch(e){}let l=a;try{const e=await Y.validateLicense();await W.installationService.getLicenseBinding(),e.valid&&e.features?.advancedAuth||(l=w()(a).call(a,e=>"SIGNIN_METHOD_EMAIL"===e.type))}catch(e){l=w()(a).call(a,e=>"SIGNIN_METHOD_EMAIL"===e.type)}return t.json({detectedMethods:l,detectedAt:(new Date).toISOString()})}catch(e){return console.error("Error detecting signin methods:",e),t.status(500).json({error:"Failed to detect signin methods",message:e.message})}});var Q=s(240),ee=s.n(Q),te=s(316),se=s.n(te);const re=require("@babel/runtime-corejs3/core-js-stable/instance/some");var ne=s.n(re);const ie=require("@babel/runtime-corejs3/core-js-stable/object/values");var ae=s.n(ie);const oe=require("@babel/runtime-corejs3/core-js-stable/instance/bind");var le=s.n(oe);const ce=require("@babel/runtime-corejs3/core-js-stable/instance/reduce");var de=s.n(ce);const ue=require("@babel/runtime-corejs3/core-js-stable/instance/slice");var pe=s.n(ue);const ge=require("@babel/runtime-corejs3/core-js-stable/instance/find-index");var fe=s.n(ge);const me=require("@babel/runtime-corejs3/core-js-stable/instance/find");var he=s.n(me);const Ee=require("@babel/runtime-corejs3/core-js-stable/set");var ve=s.n(Ee);const Ie=require("@babel/runtime-corejs3/core-js-stable/promise");var ye=s.n(Ie),_e=s(982),be=s.n(_e);const we=require("@babel/runtime-corejs3/core-js-stable/instance/sort");var Ne=s.n(we);const Fe=require("@babel/runtime-corejs3/core-js-stable/instance/index-of");var Ae=s.n(Fe);const je=require("@babel/runtime-corejs3/core-js-stable/instance/values");var Se=s.n(je),Ce=s(965);function Pe(e,t){var s=j()(e);if(C()){var r=C()(e);t&&(r=w()(r).call(r,function(t){return D()(e,t).enumerable})),s.push.apply(s,r)}return s}function De(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?_()(s=Pe(Object(n),!0)).call(s,function(t){U()(e,t,n[t])}):O()?M()(e,O()(n)):_()(r=Pe(Object(n))).call(r,function(t){L()(e,t,D()(n,t))})}return e}let Re=null,Oe={},Te={},Me={},$e=[];const Le=e=>{var t;if(!e||!e.type)return e;const s={array:["validTypes","min","max"],string:["min","max","options"],number:["min","max"],assets:["min","max"],reference:["referencePath"],dropdown:["options"],editor:["min","max"],map:["fields"]},r=["name","type","title","required","width","default","validate",...s[e.type]||[]],n={};return _()(r).call(r,t=>{void 0!==e[t]&&(n[t]=e[t])}),_()(t=j()(e)).call(t,t=>{var i;a()(r).call(r,t)||n[t]||(ne()(i=ae()(s)).call(i,r=>{var n,i;return a()(r).call(r,t)&&!(null==(n=s[e.type])?void 0:le()(i=Function.call).call(i,a()(n),n))?.(t)})||(n[t]=e[t]))}),n},Ge=()=>{Re=null},Ue=e=>{if("_customFields"===e||"_fireengineMeta"===e)return!0;if(0===$e.length)return!1;if(a()($e).call($e,e))return!0;const t=e.split("/");if(t.length>1)for(let e=1;e<t.length;e+=2){const s=pe()(t).call(t,0,e).join("/");if(a()($e).call($e,s))return!0}return!1},xe=async(e=!1)=>{const t=await(async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(s.bind(s,737)),t=await e(),{getFirestore:r}=await Promise.resolve().then(s.t.bind(s,965,23)),n=await Promise.resolve().then(s.t.bind(s,675,23)),i=t?r(n.default.app(),t):r(n.default.app()),a=await i.collection("_fireengineMeta").doc("schemaOverrides").get();if(a.exists){const e=a.data();return e?.overrides||{}}return{}}catch(e){return console.warn("Failed to load GUI schema overrides:",e.message),{}}})();Te=t;const r=j()(Oe).length>0||j()(Te).length>0;if(Re&&!e&&((new Date).getTime()-Re.lastUpdated.getTime())/1e3<Re.ttl)return qe(Re.schema);try{const e=await ke();return Re={schema:e,lastUpdated:new Date,ttl:300},qe(e)}catch(e){return console.error("Error fetching schema from Firestore:",e),Re?qe(Re.schema):r?qe({}):{collections:{},meta:{},layers:{autoDetected:{},codeOverrides:{},guiOverrides:{}}}}},qe=e=>{var t,s;const r=JSON.parse(d()(e)),n=JSON.parse(d()(Oe)),i=JSON.parse(d()(Te)),a=JSON.parse(d()(e)),o=De({},Oe);_()(t=j()(Te)).call(t,e=>{if(o[e]){const t=o[e],s=Te[e];let r=[],n={};I()(t)?r=t:t&&"object"==typeof t&&(r=t.fields||[],n={title:t.title,titleTemplate:t.titleTemplate,ignoreFields:t.ignoreFields||[],includeFields:t.includeFields||[]});let i=[],a={};I()(s)?i=s:s&&"object"==typeof s&&(i=s.fields||[],a={title:s.title,titleTemplate:s.titleTemplate,ignoreFields:s.ignoreFields||[],includeFields:s.includeFields||[]});const l=[...r];_()(i).call(i,e=>{const t=fe()(l).call(l,t=>t.name===e.name);t>=0?l[t]=De(De({},l[t]),e):l.push(e)}),o[e]=De(De(De({},n),a),{},{fields:l})}else o[e]=Te[e]}),_()(s=j()(o)).call(s,e=>{Te[e];const t=o[e];let s=[],r={};I()(t)?s=t:t&&"object"==typeof t&&(s=t.fields||[],r={title:t.title,titleTemplate:t.titleTemplate,ignoreFields:t.ignoreFields||[],includeFields:t.includeFields||[]}),a[e]||(a[e]={fields:[]});const n=a[e]?.fields||[];let i=[];s.length>0?(_()(s).call(s,e=>{const t=he()(n).call(n,t=>t.name===e.name);if(t){const s=De(De({},t),e);if(e.validate&&"function"==typeof e.validate&&(s.validate=e.validate.toString()),"array"===s.type){const r=t.validTypes||[],n=e.validTypes||[];n.length>0?s.validTypes=[...new(ve())(n)]:r.length>0&&(s.validTypes=[...new(ve())(r)])}else delete s.validTypes;const r=Le(s);if(void 0!==e.width){const t=Number(e.width);isNaN(t)||(r.width=Math.max(.08333333,Math.min(1,t)))}i.push(r)}else if(e.type){const t=De({},e);e.validate&&"function"==typeof e.validate&&(t.validate=e.validate.toString());const s=Le(t);if(void 0!==s.width){const e=Number(s.width);isNaN(e)||(s.width=Math.max(.08333333,Math.min(1,e)))}i.push(s)}else console.warn(`Override field '${e.name}' has no type and no auto-detected field found. Skipping.`)}),_()(n).call(n,e=>{const t=ne()(s).call(s,t=>t.name===e.name);t||i.push(e)})):i=[...n],a[e]=De(De({},a[e]),{},{fields:i},r)}),j()(Me).length>0&&(a._customFields=Me);const l={},c={};for(const[e,t]of se()(a))"_customFields"===e||"_fireengineMeta"===e?c[e]=t:l[e]=t;return{collections:l,meta:c,layers:{autoDetected:r,codeOverrides:n,guiOverrides:i}}},ke=async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(s.bind(s,737)),t=await e(),r=t?(0,Ce.getFirestore)(F().app(),t):(0,Ce.getFirestore)(F().app()),n=await r.listCollections();if(0===n.length)return{};const i=w()(n).call(n,e=>!Ue(e.id)),a=await ye().all(be()(i).call(i,Be()));return Ke(a)}catch(e){throw console.error("Error fetching schema from Firestore:",e),e}},Be=e=>async t=>{try{let s;const r=["createdAt","created_at","dateCreated","timestamp","_createdAt"];for(const e of r)try{if(s=await t.orderBy(e,"asc").limit(1).get(),!s.empty)break}catch(e){continue}if(!s||s.empty){const s=await t.limit(5).get();if(s.empty)return ye().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[]}});const r={},n=s.docs[0]?.ref;for(const e of s.docs){const t=e._fieldsProto;if(t)for(const[e,s]of se()(t))if(r[e]){if(r[e].valueType!==s.valueType){const t={referenceValue:5,timestampValue:4,integerValue:3,doubleValue:3,stringValue:2,booleanValue:1,nullValue:0},n=t[r[e].valueType]||0;(t[s.valueType]||0)>n&&(r[e]=s)}}else r[e]=s}const i=j()(r).length>0?Ve(r):null,a=n?await n.listCollections():[],o=w()(a).call(a,s=>{const r=`${e?`${e}/`:""}${t.id}/${s.id}`;return!Ue(r)}),l=await ye().all(be()(o).call(o,Be(`${e?`${e}/`:""}${t.id}`)));return ye().resolve(De({[`${e?`${e}/`:""}${t.id}`]:i?{fields:i}:null},Ke(l)))}if(s.empty)return ye().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[]}});const n=s.docs[0]?._fieldsProto,i=s.docs[0]?.ref,a=i?await i.listCollections():[],o=w()(a).call(a,s=>{const r=`${e?`${e}/`:""}${t.id}/${s.id}`;return!Ue(r)}),l=await ye().all(be()(o).call(o,Be(`${e?`${e}/`:""}${t.id}`))),c=n?Ve(n):null;return ye().resolve(De({[`${e?`${e}/`:""}${t.id}`]:c?{fields:c}:null},Ke(l)))}catch(s){return console.error(`Error processing collection ${t.id}:`,s),ye().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[],error:s.message}})}},Ve=e=>{try{var t;const s=Ne()(t=j()(e)).call(t,(e,t)=>{const s=["id","name","title"],r=Ae()(s).call(s,e),n=Ae()(s).call(s,t);return-1!==r&&-1!==n?r-n:-1!==r?-1:-1!==n?1:e.localeCompare(t)});return be()(s).call(s,t=>{var s;let r;if("referenceValue"===e[t].valueType){const s=e[t].referenceValue;let n;if(a()(s).call(s,"databases/(default)/documents/")){const e=s.split("databases/(default)/documents/");n=e.length>1?e[e.length-1]:void 0}else if(a()(s).call(s,"documents/")){const e=s.split("documents/");n=e.length>1?e[e.length-1]:void 0}else a()(s).call(s,"/")&&(n=s);if(n){const e=n.split("/");r=w()(e).call(e,(e,t)=>t%2==0).join("/")}}const n=De(De(De({name:t,type:We(e[t].valueType)},"mapValue"===e[t].valueType&&{fields:Ve(e[t].mapValue.fields)}),"arrayValue"===e[t].valueType&&Se()(e[t].arrayValue)&&{validTypes:be()(s=Se()(e[t].arrayValue)).call(s,e=>We(e.valueType))}),r&&{referencePath:r});return Le(n)})}catch(e){return console.error("Error processing fields:",e),[]}},Ke=e=>{try{return de()(e).call(e,(e,t)=>De(De({},e),t),{})}catch(e){return console.error("Error combining collections:",e),{}}},We=e=>"geoPointValue"===e?"geoPoint":"referenceValue"===e?"reference":e.replace("Value","");function He(e,t){var s=j()(e);if(C()){var r=C()(e);t&&(r=w()(r).call(r,function(t){return D()(e,t).enumerable})),s.push.apply(s,r)}return s}const Je=async(e,t,s)=>{try{const r=e.headers.authorization;if(!r||!l()(r).call(r,"Bearer "))return t.status(401).json({error:"No valid authorization token provided"});const n=r.split("Bearer ")[1],i=await F().auth().verifyIdToken(n);e.user=function(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?_()(s=He(Object(n),!0)).call(s,function(t){U()(e,t,n[t])}):O()?M()(e,O()(n)):_()(r=He(Object(n))).call(r,function(t){L()(e,t,D()(n,t))})}return e}({uid:i.uid,email:i.email,email_verified:i.email_verified,role:i.role||i.customClaims?.role||""},i),s()}catch(e){return console.error("Authentication error:",e),t.status(401).json({error:"Invalid or expired token"})}},ze=(e,t)=>Boolean(t&&e===t),Ye=(e,t)=>e?ze(e.email||"",t)?"admin":e.role||"":"",Xe=(0,g.Router)({strict:!0}),Ze=Xe;Xe.get("/schema",Je,async(e,t)=>{try{const s=process.env.FIREENGINE_OWNER_EMAIL;if(!ze(e.user?.email||"",s)){const r=Ye(e.user,s);if(!r||""===ee()(r).call(r))return t.status(403).json({error:"Access denied",message:"User role required to access schema"})}const r="true"===e.query.refresh,n=await xe(r);return t.json(n)}catch(e){return console.error("Error fetching schema:",e),t.status(500).json({error:"Failed to fetch schema",message:e.message})}}),Xe.post("/schema/refresh",Je,async(e,t)=>{try{const s=process.env.FIREENGINE_OWNER_EMAIL;if(!ze(e.user?.email||"",s)){const r=Ye(e.user,s);if(!r||""===ee()(r).call(r))return t.status(403).json({error:"Access denied",message:"User role required to refresh schema"})}Ge();const r=await xe(!0);return t.json({success:!0,message:"Schema cache cleared and refreshed",schema:r})}catch(e){return console.error("Error refreshing schema:",e),t.status(500).json({error:"Failed to refresh schema",message:e.message})}}),Xe.post("/schema-overrides",Je,async(e,t)=>{try{const r=process.env.FIREENGINE_OWNER_EMAIL;if(!ze(e.user?.email||"",r)){const s=Ye(e.user,r);if(!s||""===ee()(s).call(s))return t.status(403).json({error:"Access denied",message:"User role required to save schema overrides"})}const{overrides:n}=e.body;if(!n||"object"!=typeof n)return t.status(400).json({error:"Invalid overrides data"});const{getFirestoreDatabaseName:i}=await Promise.resolve().then(s.bind(s,737)),a=await i(),o=a?(0,Ce.getFirestore)(F().app(),a):(0,Ce.getFirestore)(F().app());return await o.collection("_fireengineMeta").doc("schemaOverrides").set({overrides:n,updatedAt:F().firestore.FieldValue.serverTimestamp(),updatedBy:e.user?.uid||"system"}),(e=>{Te=e||{}})(n),Ge(),t.json({success:!0,message:"Schema overrides saved successfully"})}catch(e){return console.error("Error saving GUI schema overrides:",e),t.status(500).json({error:"Failed to save GUI schema overrides",message:e.message})}});const Qe=async(e,t,r,n)=>{if(!e)return!1;if(ze(e.email||"",n))return console.log("Owner access granted for:",e.email),!0;const i=Ye(e,n);if(!i||""===ee()(i).call(i))return console.log("Permission denied: User has no role assigned",{user:e.email,uid:e.uid,role:e.role}),!1;const a=await(async(e,t)=>{if(!e)return null;const r=Ye(e,t);if(!r)return null;const n=await(async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(s.bind(s,737)),t=await e(),r=t?(0,Ce.getFirestore)(N.app(),t):(0,Ce.getFirestore)(N.app()),n=await r.collection("_fireengineMeta").doc("roles").get(),i=[{id:"admin",name:"Admin",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!0,write:!0},settings:{read:!0,write:!0}},predefined:!0},{id:"editor",name:"Editor",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0},{id:"viewer",name:"Viewer",permissions:{content:{},assets:{read:!0,write:!1},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0}];if(n.exists){const e=n.data(),t=e?.customRoles||[];return[...i,...t]}return i}catch(e){return console.error("Error loading roles:",e),[{id:"admin",name:"Admin",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!0,write:!0},settings:{read:!0,write:!0}},predefined:!0},{id:"editor",name:"Editor",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0},{id:"viewer",name:"Viewer",permissions:{content:{},assets:{read:!0,write:!1},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0}]}})(),i=he()(n).call(n,e=>e.id===r);return i?.permissions||null})(e,n);if(!a&&"admin"===e.role)return!0;if(!a)return!1;if("system:users"===t||"system:assets"===t||"system:settings"===t){const e=a[t.replace("system:","")];return e?.[r]||!1}let o=a.content[t]?.[r]||!1;if(!o){const t=Ye(e,n);("admin"===t||"editor"===t||"viewer"===t&&"read"===r)&&(o=!0)}return o},et=e=>async(t,s,r)=>{try{const n=k(),i=B();if(!0===n.useFirestoreAccessRules)return r();if(!t.user)return s.status(401).json({error:"Authentication required"});if(!await Qe(t.user,e,"read",i))return s.status(403).json({error:"Insufficient permissions",message:`Read access denied for resource: ${e}`});r()}catch(e){return console.error("Permission check error:",e),s.status(500).json({error:"Internal server error"})}},tt=e=>async(t,s,r)=>{try{const n=k(),i=B();if(!0===n.useFirestoreAccessRules)return r();if(!t.user)return s.status(401).json({error:"Authentication required"});if(!await Qe(t.user,e,"write",i))return s.status(403).json({error:"Insufficient permissions",message:`Write access denied for resource: ${e}`});r()}catch(e){return console.error("Permission check error:",e),s.status(500).json({error:"Internal server error"})}},st=e=>async(t,s,r)=>{try{const n=k(),i=B();if(!0===n.useFirestoreAccessRules)return r();if(!t.user)return s.status(401).json({error:"Authentication required"});const a=t.query.collectionPath||t.body.collectionPath;if(!a||"string"!=typeof a)return s.status(400).json({error:"Collection path is required"});if(l()(a).call(a,"_fireengine"))return r();if(!await Qe(t.user,a,e,i))return s.status(403).json({error:"Insufficient permissions",message:`${e} access denied for collection: ${a}`});r()}catch(e){return console.error("Permission check error:",e),s.status(500).json({error:"Internal server error"})}},rt=(0,g.Router)({strict:!0}),nt=rt;rt.get("/users",Je,et("system:users"),async(e,t)=>{try{const e=await it();return t.json(e)}catch(e){return console.error("Error fetching users:",e),t.status(500).json({error:"Failed to fetch users",message:e.message})}}),rt.put("/users/:uid",Je,tt("system:users"),async(e,t)=>{try{const{uid:s}=e.params,{email:r,displayName:n,disabled:i,emailVerified:a,customClaims:o}=e.body,l={};void 0!==r&&(l.email=r),void 0!==n&&(l.displayName=n),void 0!==i&&(l.disabled=i),void 0!==a&&(l.emailVerified=a);const c=await F().auth().updateUser(s,l);if(void 0!==o){await F().auth().setCustomUserClaims(s,o);const e=await F().auth().getUser(s);return t.json(e)}return t.json(c)}catch(e){return console.error("Error updating user:",e),t.status(500).json({error:"Failed to update user",message:e.message})}}),rt.delete("/users/:uid",Je,tt("system:users"),async(e,t)=>{try{const{uid:s}=e.params;return await F().auth().deleteUser(s),t.json({success:!0,message:"User deleted successfully"})}catch(e){return console.error("Error deleting user:",e),t.status(500).json({error:"Failed to delete user",message:e.message})}}),rt.post("/users",Je,tt("system:users"),async(e,t)=>{try{const{email:s,password:r,displayName:n,emailVerified:i=!1,disabled:a=!1,customClaims:o}=e.body;if(!s)return t.status(400).json({error:"Email is required"});const l={email:s,emailVerified:i,disabled:a};r&&(l.password=r),n&&(l.displayName=n);const c=await F().auth().createUser(l);if(o&&j()(o).length>0){await F().auth().setCustomUserClaims(c.uid,o);const e=await F().auth().getUser(c.uid);return t.json(e)}return t.json(c)}catch(e){return console.error("Error creating user:",e),t.status(500).json({error:"Failed to create user",message:e.message})}});const it=async e=>{try{const t=await F().auth().listUsers(1e3,e),s=t.users||[];if(t.pageToken){const e=await it(t.pageToken);return[...s,...e]}return s}catch(e){throw console.error("Error in listAllUsers:",e),e}},at=require("@babel/runtime-corejs3/helpers/objectWithoutProperties");var ot=s.n(at);const lt=require("@babel/runtime-corejs3/core-js-stable/parse-int");var ct=s.n(lt);const dt=["id"];function ut(e,t){var s=j()(e);if(C()){var r=C()(e);t&&(r=w()(r).call(r,function(t){return D()(e,t).enumerable})),s.push.apply(s,r)}return s}function pt(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?_()(s=ut(Object(n),!0)).call(s,function(t){U()(e,t,n[t])}):O()?M()(e,O()(n)):_()(r=ut(Object(n))).call(r,function(t){L()(e,t,D()(n,t))})}return e}const gt=(0,g.Router)({strict:!0}),ft=gt,mt=e=>{if(null==e)return e;const{id:t}=e;return ot()(e,dt)},ht=(e,t)=>{if(null==e)return e;if(I()(e))return be()(e).call(e,e=>ht(e,t));if("object"==typeof e){if(e._path&&e._path.segments&&I()(e._path.segments)&&e.id){const s=e._path.segments;if(s.length>=2&&s.length%2==0)try{const e=pe()(s).call(s,0,-1).join("/"),r=s[s.length-1];return console.log(`Converting reference-like object to DocumentReference: ${e}/${r}`),t.collection(e).doc(r)}catch(t){return console.warn("Failed to convert reference-like object to DocumentReference:",t),e}}if(void 0!==e.latitude&&void 0!==e.longitude||void 0!==e._latitude&&void 0!==e._longitude)try{const t=void 0!==e.latitude?e.latitude:e._latitude,r=void 0!==e.longitude?e.longitude:e._longitude;console.log(`Converting GeoPoint-like object: lat=${t}, lng=${r}`);const{GeoPoint:n}=s(965);return new n(t,r)}catch(t){return console.warn("Failed to convert GeoPoint-like object:",t),e}if(void 0!==e.seconds&&void 0!==e.nanoseconds||void 0!==e._seconds&&void 0!==e._nanoseconds)try{const t=void 0!==e.seconds?e.seconds:e._seconds,r=void 0!==e.nanoseconds?e.nanoseconds:e._nanoseconds;console.log(`Converting Timestamp-like object: seconds=${t}, nanoseconds=${r}`);const{Timestamp:n}=s(965);return new n(t,r)}catch(t){return console.warn("Failed to convert Timestamp-like object:",t),e}if(e instanceof Date||"string"==typeof e&&!isNaN(Date.parse(e)))try{const t=e instanceof Date?e:new Date(e);console.log(`Converting Date to Timestamp: ${t.toISOString()}`);const{Timestamp:r}=s(965);return r.fromDate(t)}catch(t){return console.warn("Failed to convert Date to Timestamp:",t),e}const r={};for(const[s,n]of se()(e))r[s]=ht(n,t);return r}return e};gt.get("/firestore/documents",Je,st("read"),async(e,t)=>{console.log("Handling /api/firestore/documents request");try{const n=e.query.collectionPath,i=e.query.search||"",o=e.query.limit?ct()(e.query.limit.toString(),10):null,l=e.query.offset?ct()(e.query.offset.toString(),10):0;if(!n)return console.log("Missing collectionPath parameter in /documents request"),t.status(400).json({error:"Missing collectionPath parameter"});console.log(`Fetching documents for collection: ${n}, search: "${i}", limit: ${o}, offset: ${l}`);const c=await zt();console.log(`Using Firestore database: ${c||"default"}`);const d=c?(0,Ce.getFirestore)(F().app(),c):(0,Ce.getFirestore)(F().app());try{var s;const e=d.collection(n.toString()),c=await e.get();if(c.empty)return console.log(`Collection ${n} is empty or doesn't exist yet - returning empty response`),t.status(200).json({documents:[],totalCount:0,hasMore:!1});let u=be()(s=c.docs).call(s,e=>pt({id:e.id},e.data()));if(i&&ee()(i).call(i)){var r;const e=ee()(r=i.toLowerCase()).call(r);u=w()(u).call(u,t=>{var s;const r=["title","name","displayName","text","content","description","email","firstName","lastName","subject","body","message"];return ne()(r).call(r,s=>{const r=t[s];var n;return"string"==typeof r&&a()(n=r.toLowerCase()).call(n,e)})||a()(s=t.id.toLowerCase()).call(s,e)})}const p=u.length;let g=u;if(null!==o){const e=l||0,t=e+o;g=pe()(u).call(u,e,t)}const f=null!==o&&l+o<p;return console.log(`Successfully fetched ${g.length} of ${p} documents from ${n}${i?` (filtered by "${i}")`:""}`),t.status(200).json({documents:g,totalCount:p,hasMore:f,searchTerm:i||null})}catch(e){return console.log(`Collection ${n} could not be accessed (likely doesn't exist yet): ${e.message}`),console.log("Returning empty response for non-existent collection"),t.status(200).json({documents:[],totalCount:0,hasMore:!1})}}catch(e){return console.error("Error fetching documents:",e),t.status(500).json({error:"Failed to fetch documents",message:e.message||"Unknown error"})}}),gt.get("/firestore/document",Je,st("read"),async(e,t)=>{console.log("Handling /api/firestore/document request");try{const{collectionPath:s,documentId:r}=e.query;if(!s||!r)return t.status(400).json({error:"Missing required parameters"});console.log(`Fetching document: ${s}/${r}`);const n=await zt();console.log(`Using Firestore database: ${n||"default"}`);const i=(n?(0,Ce.getFirestore)(F().app(),n):(0,Ce.getFirestore)(F().app())).collection(s.toString()).doc(r.toString()),a=await i.get();return a.exists?t.json(pt({id:a.id},a.data())):t.status(404).json({error:"Document not found"})}catch(e){return console.error("Error fetching document:",e),t.status(500).json({error:"Failed to fetch document",message:e.message})}}),gt.post("/firestore/document",Je,st("write"),async(e,t)=>{console.log("Handling POST /api/firestore/document request");try{const{collectionPath:s,data:r,documentId:n}=e.body;if(!s||!r)return t.status(400).json({error:"Missing required parameters"});console.log(`Creating document in: ${s}${n?` with ID: ${n}`:""}`,r);const i=await Et(s,r);if(!i.isValid)return console.log("Validation failed:",i.errors),t.status(400).json({error:"Validation failed",errors:i.errors});const o=await zt();console.log(`Using Firestore database: ${o||"default"}`);const l=F().app().options.projectId,c=F().app().options.credential;console.log(`Using Firebase project: ${l}`),console.log(`Admin SDK initialized: ${F().apps.length>0}`),console.log(`Credential type: ${c?.constructor?.name}`);let d,u=null;if(c&&(c._certificate&&c._certificate.client_email?(u=c._certificate.client_email,console.log(`Service account email (method 1): ${u}`)):c.certificate&&c.certificate.client_email?(u=c.certificate.client_email,console.log(`Service account email (method 2): ${u}`)):c.clientEmail?(u=c.clientEmail,console.log(`Service account email (method 3): ${u}`)):c.client_email?(u=c.client_email,console.log(`Service account email (method 4): ${u}`)):(console.log(`Could not extract service account email. Credential keys: ${j()(c)}`),console.log(`Credential clientEmail property: ${c.clientEmail}`),console.log(`Credential client_email property: ${c.client_email}`))),u){console.log(`Service account project matches: ${a()(u).call(u,l)}`);const e=`firebase-adminsdk-.*@${l}\\.iam\\.gserviceaccount\\.com`,t=new RegExp(e).test(u);console.log(`Service account format is correct: ${t}`),t||(console.log(`Expected format: firebase-adminsdk-xxxxx@${l}.iam.gserviceaccount.com`),console.log(`Actual email: ${u}`))}if(o){console.log(`Connecting directly to named database: ${o}`);try{d=(0,Ce.getFirestore)(F().app(),o),console.log(`Successfully connected to database: ${o}`)}catch(e){throw console.log(`Failed to connect to database ${o}: ${e.message}`),new Error(`Unable to connect to Firestore database: ${o}`)}}else console.log("No database name provided, this shouldn't happen with auto-discovery"),d=(0,Ce.getFirestore)(F().app());try{const e=mt(r),i=ht(e,d);let a,o;return n?(console.log(`Attempting to set document with ID: ${s}/${n}`),a=d.collection(s).doc(n),await a.set(i),o=n,console.log(`Successfully set document: ${s}/${n}`)):(console.log(`Attempting to add document to collection: ${s}`),a=await d.collection(s).add(i),o=a.id,console.log(`Successfully created document: ${s}/${a.id}`)),t.json({id:o,success:!0})}catch(e){if(console.error(`Error adding document to ${s}:`,e),5===e.code||"NOT_FOUND"===e.code)return t.status(404).json({error:"Collection or database not found",message:"This might be due to Firestore security rules, invalid project configuration, or authentication issues",details:e.message});if(7===e.code||"PERMISSION_DENIED"===e.code)return t.status(403).json({error:"Permission denied",message:"Firestore security rules are blocking this write operation",details:e.message});throw e}}catch(e){return console.error("Error adding document:",e),t.status(500).json({error:"Failed to add document",message:e.message||"Unknown error",code:e.code||"UNKNOWN"})}});const Et=async(e,t)=>{const s={};try{const r=(await xe()).collections[e];if(!r||!r.fields)return{isValid:!0,errors:{}};for(const e of r.fields){const r=t[e.name];if(!e.required||null!=r&&""!==r){if(e.validate&&"string"==typeof e.validate)try{const t=new Function("value",`\n            const validate = ${e.validate};\n            return validate(value);\n          `)(r);null!=t&&!0!==t&&(s[e.name]=String(t))}catch(t){console.error(`Error executing validation for field ${e.name}:`,t),s[e.name]="Validation error"}else{const t=schema.meta._customFields||{};if(e.type&&t[e.type]&&t[e.type].validate)try{const n=t[e.type],i=new Function("value",`\n              const validate = ${n.validate};\n              return validate(value);\n            `)(r);!0!==i&&(s[e.name]=String(i))}catch(t){console.error(`Error executing custom field validation for ${e.name}:`,t),s[e.name]="Custom field validation error"}}if("array"===e.type&&null!=r){const t=I()(r)?r:[];e.min&&t.length<e.min&&(s[e.name]=`Minimum ${e.min} items required`),e.max&&t.length>e.max&&(s[e.name]=`Maximum ${e.max} items allowed`)}}else s[e.name]="This field is required"}return{isValid:0===j()(s).length,errors:s}}catch(e){return console.error("Error during validation:",e),{isValid:!0,errors:{}}}};gt.put("/firestore/document",Je,st("write"),async(e,t)=>{console.log("Handling PUT /api/firestore/document request");try{const{collectionPath:s,documentId:r,data:n}=e.body;if(!s||!r||!n)return t.status(400).json({error:"Missing required parameters"});console.log(`Updating document: ${s}/${r}`,n);const i=await Et(s,n);if(!i.isValid)return console.log("Validation failed:",i.errors),t.status(400).json({error:"Validation failed",errors:i.errors});const a=await zt();console.log(`Using Firestore database: ${a||"default"}`);const o=a?(0,Ce.getFirestore)(F().app(),a):(0,Ce.getFirestore)(F().app()),l=mt(n),c=ht(l,o),d=o.collection(s).doc(r);return await d.update(c),console.log(`Successfully updated document: ${s}/${r}`),t.json({id:r,success:!0})}catch(e){return console.error("Error updating document:",e),t.status(500).json({error:"Failed to update document",message:e.message})}}),gt.delete("/firestore/document",Je,st("write"),async(e,t)=>{console.log("Handling DELETE /api/firestore/document request");try{const{collectionPath:s,documentId:r}=e.query;if(!s||!r)return t.status(400).json({error:"Missing required parameters"});console.log(`Deleting document: ${s}/${r}`);const n=await zt();console.log(`Using Firestore database: ${n||"default"}`);const i=(n?(0,Ce.getFirestore)(F().app(),n):(0,Ce.getFirestore)(F().app())).collection(s.toString()).doc(r.toString());return await i.delete(),console.log(`Successfully deleted document: ${s}/${r}`),t.json({success:!0})}catch(e){return console.error("Error deleting document:",e),t.status(500).json({error:"Failed to delete document",message:e.message})}}),gt.get("/firestore/test-connection",Je,async(e,t)=>{console.log("Testing Firebase Admin SDK connection");try{const e=await zt();console.log(`Using Firestore database: ${e||"default"}`);const s=(e?(0,Ce.getFirestore)(F().app(),e):(0,Ce.getFirestore)(F().app())).collection("_test_connection");return await s.limit(1).get(),console.log("Firebase Admin SDK connection test successful"),t.json({success:!0,message:"Firebase Admin SDK connection is working",projectId:F().app().options.projectId||"unknown",credentialType:F().app().options.credential?.constructor?.name||"unknown"})}catch(e){return console.error("Firebase Admin SDK connection test failed:",e),t.status(500).json({success:!1,error:"Firebase connection failed",message:e.message||"Unknown error",code:e.code||"UNKNOWN",details:"This indicates an issue with Firebase Admin SDK credentials or project configuration"})}});const vt=require("firebase-admin/storage"),It=require("multer");var yt=s.n(It);const _t=require("stream"),bt=yt()({storage:yt().memoryStorage(),limits:{fileSize:52428800}}),wt=()=>{try{return(0,vt.getStorage)().bucket()}catch(e){throw console.error("Error getting storage bucket:",e),new Error("Storage not configured")}},Nt=[bt.array("files",10),async(e,t)=>{try{const{path:s=""}=e.body,r=e.files;if(!r||0===r.length)return t.status(400).json({success:!1,error:"No files provided"});const n=wt(),i=[];for(const e of r)try{const t=e.originalname,r=s?`${s}/${t}`:t;console.log(`Uploading file: ${r}`);const a=n.file(r),o=new _t.Readable;o.push(e.buffer),o.push(null),await new(ye())((t,s)=>{const r=a.createWriteStream({metadata:{contentType:e.mimetype}});r.on("error",s),r.on("finish",t),o.pipe(r)}),i.push({name:t,path:r,success:!0})}catch(t){console.error(`Error uploading ${e.originalname}:`,t),i.push({name:e.originalname,success:!1,error:t.message})}t.json({success:!0,results:i})}catch(e){console.error("Error uploading files:",e),t.status(500).json({success:!1,error:e.message||"Failed to upload files"})}}],Ft=(0,g.Router)();Ft.get("/storage/list",Je,et("system:assets"),async(e,t)=>{try{const{path:s=""}=e.query,r=wt();console.log(`Listing files in path: ${s}`);const[i]=await r.getFiles({prefix:s?`${s}/`:"",delimiter:"/"}),o={prefix:s?`${s}/`:"",delimiter:"/"},[,,l]=await r.getFiles(o),c=l?.prefixes||[],d=be()(c).call(c,e=>({name:e.replace(s?`${s}/`:"","").replace(/\/$/,""),fullPath:e.replace(/\/$/,""),isFolder:!0})),u=[];for(const e of i){const t=e.name.replace(s?`${s}/`:"","");if(!a()(t).call(t,"/"))try{const[s]=await e.getMetadata(),[r]=await e.getSignedUrl({action:"read",expires:n()()+36e5});u.push({name:t,fullPath:e.name,isFolder:!1,size:ct()(s.size||"0"),timeCreated:s.timeCreated,contentType:s.contentType,downloadURL:r})}catch(s){console.error(`Error getting metadata for ${e.name}:`,s),u.push({name:t,fullPath:e.name,isFolder:!1})}}const p=[...d,...u];t.json({success:!0,items:p})}catch(e){console.error("Error listing files:",e),t.status(500).json({success:!1,error:e.message||"Failed to list files"})}}),Ft.post("/storage/upload",Je,tt("system:assets"),...Nt),Ft.delete("/storage/file",Je,tt("system:assets"),async(e,t)=>{try{const{filePath:s}=e.body;if(!s)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Deleting file: ${s}`);const r=wt().file(s);await r.delete(),t.json({success:!0,message:"File deleted successfully"})}catch(e){console.error("Error deleting file:",e),t.status(500).json({success:!1,error:e.message||"Failed to delete file"})}}),Ft.get("/storage/download-url",Je,et("system:assets"),async(e,t)=>{try{const{filePath:s}=e.query;if(!s)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Getting download URL for: ${s}`);const r=wt().file(s),[i]=await r.getSignedUrl({action:"read",expires:n()()+36e5});t.json({success:!0,downloadURL:i})}catch(e){console.error("Error getting download URL:",e),t.status(500).json({success:!1,error:e.message||"Failed to get download URL"})}}),Ft.get("/storage/metadata",Je,et("system:assets"),async(e,t)=>{try{const{filePath:s}=e.query;if(!s)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Getting metadata for: ${s}`);const r=wt().file(s),[n]=await r.getMetadata();t.json({success:!0,metadata:{name:n.name,size:ct()(n.size||"0"),timeCreated:n.timeCreated,contentType:n.contentType,etag:n.etag}})}catch(e){console.error("Error getting file metadata:",e),t.status(500).json({success:!1,error:e.message||"Failed to get file metadata"})}}),Ft.post("/storage/folder",Je,tt("system:assets"),async(e,t)=>{try{const{folderPath:s}=e.body;if(!s)return t.status(400).json({success:!1,error:"Folder path is required"});console.log(`Creating folder: ${s}`);const r=wt(),n=`${s}/.fireengine-folder`,i=r.file(n);await i.save("",{metadata:{contentType:"text/plain"}}),t.json({success:!0,message:"Folder created successfully",folderPath:s})}catch(e){console.error("Error creating folder:",e),t.status(500).json({success:!1,error:e.message||"Failed to create folder"})}}),Ft.post("/storage/move",Je,tt("system:assets"),async(e,t)=>{try{const{sourcePath:s,destinationPath:r}=e.body;if(!s||!r)return t.status(400).json({success:!1,error:"Source path and destination path are required"});console.log(`Moving from: ${s} to: ${r}`);const n=wt(),i=n.file(s),[a]=await i.exists();if(a){const e=n.file(r);return await i.copy(e),await i.delete(),void t.json({success:!0,message:"File moved successfully",sourcePath:s,destinationPath:r})}const[o]=await n.getFiles({prefix:s+"/"});if(0===o.length)return t.status(404).json({success:!1,error:"Source file or folder not found"});console.log(`Moving folder with ${o.length} files`);let l=0;for(const e of o)try{const t=r+"/"+e.name.replace(s+"/",""),i=n.file(t);await e.copy(i),await e.delete(),l++}catch(t){console.error(`Error moving file ${e.name}:`,t)}t.json({success:!0,message:`Folder moved successfully (${l} files)`,sourcePath:s,destinationPath:r})}catch(e){console.error("Error moving file/folder:",e),t.status(500).json({success:!1,error:e.message||"Failed to move file/folder"})}}),Ft.post("/storage/move-bulk",Je,tt("system:assets"),async(e,t)=>{try{const{moves:s}=e.body;if(!s||!I()(s)||0===s.length)return t.status(400).json({success:!1,error:"Moves array is required"});console.log(`Moving ${s.length} files`);const r=wt(),n=[];for(const e of s)try{const{sourcePath:t,destinationPath:s}=e;if(!t||!s){n.push({sourcePath:t,destinationPath:s,success:!1,error:"Source path and destination path are required"});continue}const i=r.file(t),a=r.file(s),[o]=await i.exists();if(!o){n.push({sourcePath:t,destinationPath:s,success:!1,error:"Source file not found"});continue}await i.copy(a),await i.delete(),n.push({sourcePath:t,destinationPath:s,success:!0})}catch(t){console.error(`Error moving file ${e.sourcePath}:`,t),n.push({sourcePath:e.sourcePath,destinationPath:e.destinationPath,success:!1,error:t.message||"Failed to move file"})}const i=w()(n).call(n,e=>e.success).length,a=n.length-i;t.json({success:0===a,message:0===a?`All ${i} files moved successfully`:`${i} files moved successfully, ${a} failed`,results:n})}catch(e){console.error("Error moving files:",e),t.status(500).json({success:!1,error:e.message||"Failed to move files"})}});const At=Ft;var jt=s(575);function St(e,t){var s=j()(e);if(C()){var r=C()(e);t&&(r=w()(r).call(r,function(t){return D()(e,t).enumerable})),s.push.apply(s,r)}return s}function Ct(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?_()(s=St(Object(n),!0)).call(s,function(t){U()(e,t,n[t])}):O()?M()(e,O()(n)):_()(r=St(Object(n))).call(r,function(t){L()(e,t,D()(n,t))})}return e}const Pt=(0,g.Router)();Pt.post("/billing/create-checkout",Je,async(e,t)=>{try{const{priceId:s}=e.body;if(!s)return t.status(400).json({error:"Price ID is required"});const r=await W.installationService.getInstallation(),n=`${e.protocol}://${e.get("host")}/settings/account`,i=`${jt.PADDLE_CONFIG.licenseApiUrl}/checkout`,a={priceId:s,installationId:r.installationId,domain:r.domain,userEmail:e.user?.email,userDisplayName:e.user?.name||e.user?.displayName,environment:r.environment,version:r.version,returnUrl:n},o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Origin:`${e.protocol}://${e.get("host")}`},body:d()(a)});if(!o.ok){const e=await o.json();throw new Error(e.error||"Checkout worker request failed")}const l=await o.json();t.json({checkoutUrl:l.checkoutUrl,transactionId:l.transactionId,environment:l.environment,returnUrl:n})}catch(e){console.error("Checkout session creation failed:",e),t.status(500).json({error:"Failed to create checkout session",message:e instanceof Error?e.message:"Unknown error"})}}),Pt.post("/billing/checkout-success",Je,async(e,t)=>{try{const{sessionId:s,subscriptionId:r}=e.body;if(!s&&!r&&!e.body.provider)return t.status(400).json({error:"Session ID, Subscription ID, or provider is required"});const i=await W.installationService.getInstallation();let a=r;if(s&&!r)try{const t={sessionId:s,installationId:i.installationId,domain:i.domain,version:i.version},r=`${jt.PADDLE_CONFIG.licenseApiUrl}/session`,n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Origin:`${e.protocol}://${e.get("host")}`},body:d()(t)});n.ok?a=(await n.json()).subscriptionId:(console.warn("Could not retrieve subscription ID from session, using session ID as fallback"),a=s)}catch(e){console.warn("Error retrieving subscription ID from session:",e),a=s}if("paddle"===e.body.provider){const{transactionId:t,customerId:s}=e.body;a=!r||"{subscription_id}"===r||"{{subscription_id}}"===r||l()(r).call(r,"pending_")?t||`paddle_temp_${n()()}`:r}const o="paddle"===e.body.provider&&(l()(a).call(a,"paddle_temp_")||l()(a).call(a,"txn_")),c={installationId:i.installationId,subscriptionId:a,plan:o?"pro":"pending",status:"active",lastValidated:new Date,features:o?{unlimitedUsers:!0,schemaOverrides:!0,customRoles:!0,advancedAuth:!0}:{},checkoutSessionId:s,provider:e.body.provider||"paddle",transactionId:e.body.transactionId,customerId:e.body.customerId};await W.installationService.updateLicenseBinding(c),t.json({success:!0,message:"Subscription activated successfully!",subscriptionId:a})}catch(e){console.error("Checkout success handling failed:",e),t.status(500).json({error:"Failed to process successful checkout",message:e instanceof Error?e.message:"Unknown error"})}}),Pt.get("/billing/subscription",Je,async(e,t)=>{try{const e=await W.installationService.getLicenseBinding(),s=await W.installationService.getInstallation();let r=e;if(e.subscriptionId)try{const t={subscriptionId:e.subscriptionId,installationId:s.installationId,domain:s.domain,version:s.version},n=await fetch(jt.PADDLE_CONFIG.licenseApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(t)});if(n.ok){const t=await n.json();if(t.valid){const s=Ct(Ct({},e),{},{subscriptionId:t.subscriptionId||e.subscriptionId,plan:t.plan,status:"active",features:t.features||{},validUntil:t.validUntil?new Date(t.validUntil):null,gracePeriodEnd:t.gracePeriodEnd?new Date(t.gracePeriodEnd):null,lastValidated:new Date});t.subscriptionId&&(t.subscriptionId,e.subscriptionId),await W.installationService.updateLicenseBinding(s),r=s}else{const t=Ct(Ct({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await W.installationService.updateLicenseBinding(t),r=t}}else{const t=await n.text();console.error("Worker validation failed:",n.status,t);const s=Ct(Ct({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await W.installationService.updateLicenseBinding(s),r=s}}catch(t){console.error("Error validating license with worker:",t);const s=Ct(Ct({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await W.installationService.updateLicenseBinding(s),r=s}else r=Ct(Ct({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null});const n={subscription:r.subscriptionId?{id:r.subscriptionId,status:r.status,plan:r.plan,validUntil:r.validUntil,lastValidated:r.lastValidated}:null};t.json(n)}catch(e){console.error("Subscription status error:",e),t.status(500).json({error:"Failed to get subscription status"})}}),Pt.post("/billing/customer-portal",Je,async(e,t)=>{try{if(!e.user)return t.status(401).json({error:"Unauthorized"});const s=(await W.installationService.getLicenseBinding()).subscriptionId;if(!s)return console.error("No subscription ID in license data"),t.status(404).json({error:"No subscription ID found"});if(l()(s).call(s,"txn_"))return t.status(202).json({error:"Subscription still being created",message:"Your subscription is being set up. The billing portal will be available shortly. Please try again in a few minutes.",transactionId:s,retryAfter:300});const r={subscriptionId:s,returnUrl:`${e.protocol}://${e.get("host")}/settings/account`},n=await fetch(`${jt.PADDLE_CONFIG.licenseApiUrl}/customer-portal`,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(r)});if(!n.ok){const e=await n.json().catch(()=>({message:"Failed to create portal session"}));return console.error("Worker portal session error:",e),t.status(n.status).json({error:e.message||"Failed to create customer portal session"})}const i=await n.json();t.json(i)}catch(e){console.error("Customer portal error:",e),t.status(500).json({error:"Failed to access customer portal"})}});const Dt=Pt;function Rt(e,t){var s=j()(e);if(C()){var r=C()(e);t&&(r=w()(r).call(r,function(t){return D()(e,t).enumerable})),s.push.apply(s,r)}return s}function Ot(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?_()(s=Rt(Object(n),!0)).call(s,function(t){U()(e,t,n[t])}):O()?M()(e,O()(n)):_()(r=Rt(Object(n))).call(r,function(t){L()(e,t,D()(n,t))})}return e}const Tt=(0,g.Router)();Tt.get("/license/status",Je,async(e,t)=>{try{const e=await W.installationService.getInstallation(),s=await W.installationService.getLicenseBinding(),r=await Y.validateLicense();t.json({installation:{id:e.installationId,domain:e.domain,environment:e.environment,createdAt:e.createdAt,version:e.version},license:{plan:s.plan,status:s.status,validUntil:s.validUntil,lastValidated:s.lastValidated,subscriptionId:s.subscriptionId},validation:{valid:r.valid,reason:r.reason,checkedAt:new Date}})}catch(e){console.error("License status error:",e),t.status(500).json({error:"Failed to get license status"})}}),Tt.get("/installation/info",Je,async(e,t)=>{try{const e=await W.installationService.getInstallationSummary();t.json(e)}catch(e){console.error("Installation info error:",e),t.status(500).json({error:"Failed to get installation info"})}}),Tt.get("/license/debug",Je,async(e,t)=>{try{const e=await W.installationService.getInstallation(),s=await W.installationService.getLicenseBinding(),r=await Y.validateLicense(),n=e.ownerEmail&&process.env.FIREENGINE_OWNER_EMAIL===e.ownerEmail;t.json({debug:{database:{installation:{installationId:e.installationId,ownerEmail:e.ownerEmail,domain:e.domain,environment:e.environment},license:{subscriptionId:s.subscriptionId,plan:s.plan,status:s.status,validUntil:s.validUntil,lastValidated:s.lastValidated,features:s.features}},environment:{FIREENGINE_OWNER_EMAIL:process.env.FIREENGINE_OWNER_EMAIL,NODE_ENV:"production"},computed:{isOwner:n,ownerStatus:n?"OWNER EMAIL MATCH - ADMIN PERMISSIONS ONLY":"Not owner"},validation:{valid:r.valid,plan:r.plan,reason:r.reason,features:r.features}}})}catch(e){console.error("License debug error:",e),t.status(500).json({error:"Failed to get license debug info"})}}),Tt.post("/license/transfer-from-default",Je,async(e,t)=>{try{const{getFirestore:r}=await Promise.resolve().then(s.t.bind(s,965,23)),n=await Promise.resolve().then(s.t.bind(s,675,23));await W.installationService.getInstallation(),console.log("ðŸ”„ Attempting license transfer from default to configured database");const i=n.default.firestore().collection("_fireengineMeta").doc("license"),a=await i.get();if(!a.exists)return t.json({success:!1,message:"No license document found in default database"});const o=a.data();console.log("ðŸ“‹ Found license in default database:",o),await W.installationService.updateLicenseBinding(o),!0===e.body.deleteFromDefault&&(await i.delete(),console.log("ðŸ—‘ï¸ Deleted license from default database")),t.json({success:!0,message:"License transferred successfully",licenseData:o})}catch(e){console.error("License transfer error:",e),t.status(500).json({error:"Failed to transfer license"})}}),Tt.post("/license/validate-now",Je,async(e,t)=>{try{const{installationService:e}=await Promise.resolve().then(s.bind(s,615)),{PADDLE_CONFIG:r}=await Promise.resolve().then(s.bind(s,575)),n=await e.getInstallation(),i=await e.getLicenseBinding();if(!i.subscriptionId)return t.json({error:"No subscription ID found"});const a={subscriptionId:i.subscriptionId,installationId:n.installationId,domain:n.domain,version:n.version};console.log("ðŸ” Manual validation request:",a);const o=await fetch(r.licenseApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(a)}),l=await o.json();if(console.log("âœ… Manual validation result:",l),o.ok&&l.valid){const s=Ot(Ot({},i),{},{plan:l.plan,features:l.features||i.features,validUntil:l.validUntil?new Date(l.validUntil):i.validUntil,lastValidated:new Date});return await e.updateLicenseBinding(s),t.json({success:!0,before:i,after:s,validationResult:l})}t.json({success:!1,validationResult:l,responseStatus:o.status})}catch(e){console.error("âŒ Manual validation failed:",e),t.status(500).json({error:e.message})}}),Tt.post("/license/update-plan",Je,async(e,t)=>{try{const{plan:s,features:r,validUntil:n,gracePeriodEnd:i}=e.body;if(!s)return t.status(400).json({error:"Plan is required"});const a=await W.installationService.getLicenseBinding(),o=Ot(Ot({},a),{},{plan:s,features:r||a.features,validUntil:n?new Date(n):a.validUntil,gracePeriodEnd:i?new Date(i):a.gracePeriodEnd,lastValidated:new Date});await W.installationService.updateLicenseBinding(o),t.json({success:!0,message:"License plan updated successfully",plan:o.plan})}catch(e){console.error("License plan update error:",e),t.status(500).json({error:"Failed to update license plan"})}}),Tt.post("/license/clear-cache",Je,async(e,t)=>{try{return t.status(403).json({error:"Not allowed in production"})}catch(e){console.error("Clear cache error:",e),t.status(500).json({error:"Failed to clear cache"})}});const Mt=Tt,$t=(0,E.compose)([Z,Ze,nt,ft,At,Dt,Mt]);var Lt=s(896);const Gt=require("zlib");var Ut=s(128),xt=s(139);const qt=require("@babel/runtime-corejs3/core-js-stable/parse-float");var kt=s.n(qt);const Bt=require("@babel/runtime-corejs3/core-js-stable/instance/ends-with");var Vt=s.n(Bt);const Kt=e=>{var t;const s=ee()(t=e.toString()).call(t).toUpperCase(),r=kt()(s);return Vt()(s).call(s,"GB")?Math.round(1024*r*1024*1024):Vt()(s).call(s,"MB")?Math.round(1024*r*1024):Vt()(s).call(s,"KB")?Math.round(1024*r):(Vt()(s).call(s,"B"),Math.round(r))},Wt=e=>{const t=(e=>{const t=[],r=[],n=(e=>{const t=[];if(!e)return t.push("Firebase Admin SDK credentials are required"),{isValid:!1,errors:t};if("object"==typeof e){var r,n;const s=["project_id","private_key","client_email"],i=w()(s).call(s,t=>!e[t]);i.length>0&&t.push(`Missing required Admin SDK fields: ${i.join(", ")}`),e.private_key&&!a()(r=e.private_key).call(r,"BEGIN PRIVATE KEY")&&t.push("Invalid private key format - should be a PEM private key"),e.client_email&&!a()(n=e.client_email).call(n,"@")&&t.push("Invalid client_email format")}else if("string"==typeof e){Vt()(e).call(e,".json")||t.push("Admin credentials file path should point to a .json file");try{const r=s(896);if(r.existsSync(e))try{const s=r.readFileSync(e,"utf8"),n=JSON.parse(s),i=["project_id","private_key","client_email"],a=w()(i).call(i,e=>!n[e]);a.length>0&&t.push(`Admin credentials file is missing required fields: ${a.join(", ")}`)}catch(e){t.push("Admin credentials file contains invalid JSON")}else t.push(`Admin credentials file does not exist: ${e}`)}catch(e){t.push("Unable to verify admin credentials file existence")}}else t.push("Admin credentials should be an object or file path string");return{isValid:0===t.length,errors:t}})(e.adminCredentials),i=n.isValid;i||(t.push(...n.errors),r.push("Firebase Admin SDK credentials"));const o=(e=>{const t=[];if(!e)return t.push("Firebase Web App configuration is required"),{isValid:!1,errors:t};if("object"==typeof e){var r,n;const s=["apiKey","authDomain"],i=w()(s).call(s,t=>!e[t]);i.length>0&&t.push(`Missing required Web App config fields: ${i.join(", ")}`),e.apiKey&&(!l()(r=e.apiKey).call(r,"AIza")||e.apiKey.length<30)&&t.push("Invalid API key format"),e.authDomain&&!a()(n=e.authDomain).call(n,".")&&t.push("Invalid auth domain format")}else if("string"==typeof e){Vt()(e).call(e,".json")||t.push("Web app config file path should point to a .json file");try{const r=s(896);if(r.existsSync(e))try{var i,o;const s=r.readFileSync(e,"utf8"),n=JSON.parse(s),c=["apiKey","authDomain"],d=w()(c).call(c,e=>!n[e]);d.length>0&&t.push(`Web app config file is missing required fields: ${d.join(", ")}`),n.apiKey&&(!l()(i=n.apiKey).call(i,"AIza")||n.apiKey.length<30)&&t.push("Invalid API key format in config file"),n.authDomain&&!a()(o=n.authDomain).call(o,".")&&t.push("Invalid auth domain format in config file")}catch(e){t.push("Web app config file contains invalid JSON")}else t.push(`Web app config file does not exist: ${e}`)}catch(e){t.push("Unable to verify web app config file existence")}}else t.push("Web app config should be an object or file path string");return{isValid:0===t.length,errors:t}})(e.webappConfig,e.adminCredentials),c=o.isValid;c||(t.push(...o.errors),r.push("Firebase Web App configuration"));const d=(e=>{const t=[];return e?(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)||t.push("Invalid owner email format"),{isValid:0===t.length,errors:t}):(t.push("Owner email is required for initial admin access"),{isValid:!1,errors:t})})(e.ownerEmail||""),u=d.isValid;u||(t.push(...d.errors),r.push("Owner email address"));const p=i&&c&&u,g=(e=>{const t={};if(console.log("ðŸ” Debug - Config validation:",{hasAdminCredentials:!!e.adminCredentials,adminCredentialsType:typeof e.adminCredentials,hasWebappConfig:!!e.webappConfig,webappConfigType:typeof e.webappConfig,webappConfigKeys:e.webappConfig?j()(e.webappConfig):[],hasOwnerEmail:!!e.ownerEmail}),e.adminCredentials){if(e.adminCredentials){const r=[];if("string"==typeof e.adminCredentials)try{const t=s(896),n=s(928).resolve(e.adminCredentials),i=t.readFileSync(n,"utf8"),a=JSON.parse(i);console.log("ðŸ” Debug - Loaded admin credentials fields:",{hasProjectId:!!a.project_id,hasClientEmail:!!a.client_email,hasPrivateKey:!!a.private_key,firebaseProjectIdEnv:!!process.env.FIREENGINE_FIREBASE_PROJECT_ID}),a.project_id||process.env.FIREENGINE_FIREBASE_PROJECT_ID||r.push("FIREENGINE_FIREBASE_PROJECT_ID (or project_id in credentials file)"),a.client_email||r.push("FIREENGINE_FIREBASE_CLIENT_EMAIL"),a.private_key||r.push("FIREENGINE_FIREBASE_PRIVATE_KEY")}catch(e){console.log("ðŸ” Debug - Error loading admin credentials file for validation:",e.message),r.push("FIREENGINE_ADMIN_CREDENTIALS_FILE (invalid or missing file)")}else"object"==typeof e.adminCredentials&&(console.log("ðŸ” Debug - Admin credentials object fields:",{hasProjectId:!!e.adminCredentials.project_id,hasClientEmail:!!e.adminCredentials.client_email,hasPrivateKey:!!e.adminCredentials.private_key,firebaseProjectIdEnv:!!process.env.FIREENGINE_FIREBASE_PROJECT_ID}),e.adminCredentials.project_id||process.env.FIREENGINE_FIREBASE_PROJECT_ID||r.push("FIREENGINE_FIREBASE_PROJECT_ID (or project_id in credentials file)"),e.adminCredentials.client_email||r.push("FIREENGINE_FIREBASE_CLIENT_EMAIL"),e.adminCredentials.private_key||r.push("FIREENGINE_FIREBASE_PRIVATE_KEY"));console.log("ðŸ” Debug - Admin credentials missing:",r),r.length>0&&(t.adminCredentials=r)}}else t.adminCredentials=["FIREENGINE_ADMIN_CREDENTIALS_FILE (path to JSON file)","OR individual variables:","  - FIREENGINE_FIREBASE_PROJECT_ID","  - FIREENGINE_FIREBASE_CLIENT_EMAIL","  - FIREENGINE_FIREBASE_PRIVATE_KEY"];if(e.webappConfig){if(e.webappConfig){const r=[];if("string"==typeof e.webappConfig)try{const t=s(896),n=s(928).resolve(e.webappConfig),i=t.readFileSync(n,"utf8"),a=JSON.parse(i);console.log("ðŸ” Debug - Loaded webapp config fields:",{hasApiKey:!!a.apiKey,hasAuthDomain:!!a.authDomain,hasProjectId:!!a.projectId,apiKeyValue:a.apiKey?a.apiKey.substring(0,10)+"...":null,authDomainValue:a.authDomain}),a.apiKey||r.push("FIREENGINE_WEBAPP_API_KEY"),a.authDomain||r.push("FIREENGINE_WEBAPP_AUTH_DOMAIN")}catch(e){console.log("ðŸ” Debug - Error loading webapp config file for validation:",e.message),r.push("FIREENGINE_WEBAPP_CONFIG_FILE (invalid or missing file)")}else"object"==typeof e.webappConfig&&(console.log("ðŸ” Debug - Webapp config object fields:",{hasApiKey:!!e.webappConfig.apiKey,hasAuthDomain:!!e.webappConfig.authDomain,hasProjectId:!!e.webappConfig.projectId,apiKeyValue:e.webappConfig.apiKey?e.webappConfig.apiKey.substring(0,10)+"...":null,authDomainValue:e.webappConfig.authDomain}),e.webappConfig.apiKey||r.push("FIREENGINE_WEBAPP_API_KEY"),e.webappConfig.authDomain||r.push("FIREENGINE_WEBAPP_AUTH_DOMAIN"));console.log("ðŸ” Debug - Webapp config missing:",r),r.length>0&&(t.webappConfig=r)}}else t.webappConfig=["FIREENGINE_WEBAPP_CONFIG_FILE (path to JSON file)","OR individual variables:","  - FIREENGINE_WEBAPP_API_KEY","  - FIREENGINE_WEBAPP_AUTH_DOMAIN"];return e.ownerEmail||(t.ownerEmail=["FIREENGINE_OWNER_EMAIL"]),j()(t).length>0?t:void 0})(e);return{isValid:p,missingItems:r,configStatus:{adminCredentials:i,webappConfig:c,ownerEmail:u},errors:t,missingEnvVars:g}})(e);return{isConfigured:t.isValid,configStatus:t.configStatus,missingItems:t.missingItems,errors:t.errors,missingEnvVars:t.missingEnvVars,canProceed:t.configStatus.adminCredentials&&t.configStatus.webappConfig}};let Ht,Jt=!1;const zt=async()=>{if(Ht)return Ht;if(!Jt){Jt=!0;try{const e=await(async()=>{try{return}catch(e){return}})();return Ht=e,e}catch(e){return}}return Ht},Yt=(e={})=>{const t=f()(),r=(0,Ut._m)(e);(0,Ut.Jk)();const i=Wt(r);if(r.adminCredentials&&!F().apps.length)try{let e;if("string"==typeof r.adminCredentials){const t=s(896),n=s(928).resolve(r.adminCredentials);if(console.log("ðŸ“‚ Loading admin credentials from file:",n),!t.existsSync(n))throw new Error(`Admin credentials file not found: ${n}`);const i=t.readFileSync(n,"utf8");e=JSON.parse(i),console.log("âœ… Successfully loaded admin credentials from file")}else e=r.adminCredentials,console.log("âœ… Using admin credentials from config object");if(e&&!e.project_id){const t=r.webappConfig?.projectId||process.env.FIREENGINE_FIREBASE_PROJECT_ID;if(!t)throw new Error("project_id is required in admin credentials or FIREENGINE_FIREBASE_PROJECT_ID environment variable");e.project_id=t,console.log("ðŸ“ Added project_id to admin credentials:",t)}const t={credential:e?F().credential.cert(e):F().credential.applicationDefault(),projectId:r.webappConfig?.projectId,storageBucket:r.webappConfig?.storageBucket};F().initializeApp(t),(0,xt._A)(r.firestoreDatabase),console.log("âœ… Firebase Admin SDK initialized successfully")}catch(e){console.error("âŒ Error initializing Firebase Admin SDK:",e),console.log("ðŸ“‹ Configuration validation will handle incomplete setup")}else r.adminCredentials||(console.log("âš ï¸  Firebase Admin SDK not initialized - admin credentials not configured"),i.isConfigured||(console.log("ðŸ“‹ Missing items:",i.missingItems.join(", ")),console.log("ðŸš€ Onboarding page will be shown to configure the system")));Ht=r.firestoreDatabase;const o=(e=>{const t=5368709120,s=t;if(void 0!==e){const s="string"==typeof e?Kt(e):e;if(s>0&&s<=t)return s;if(s>t)return t}const r=process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE;if(r)try{const e=Kt(r);if(e>0&&e<=t)return e;if(e>t)return t}catch(e){}const n=(()=>{const e=process.env.NODE_OPTIONS;if(!e)return;const t=e.match(/--max-old-space-size[=\s](\d+)/);return t&&t[1]?ct()(t[1],10):void 0})();if(n&&n>0){const e=Math.round(1024*n*1024*.8);if(e<t)return e}return s})(r.storageMaxUploadSize);var c,u;return(e=>{q=function(e){for(var t=1;t<arguments.length;t++){var s,r,n=null!=arguments[t]?arguments[t]:{};t%2?_()(s=x(Object(n),!0)).call(s,function(t){U()(e,t,n[t])}):O()?M()(e,O()(n)):_()(r=x(Object(n))).call(r,function(t){L()(e,t,D()(n,t))})}return e}({},e)})({ownerEmail:r.ownerEmail,useFirestoreAccessRules:!0===r.useFirestoreAccessRules,webappConfig:r.webappConfig,storageMaxUploadSizeBytes:o}),W.installationService.setConfig(r),r.schemaOverrides&&(c=r.schemaOverrides,Oe=c||{}),r.customFields&&(e=>{var t;const s=e?de()(t=se()(e)).call(t,(e,[t,s])=>(e[t]=De(De({},s),{},{name:s.name||t,render:"function"==typeof s.render?s.render.toString():s.render,renderInput:"function"==typeof s.renderInput?s.renderInput.toString():s.renderInput,renderOutput:"function"==typeof s.renderOutput?s.renderOutput.toString():s.renderOutput,validate:s.validate&&"function"==typeof s.validate?s.validate.toString():s.validate}),e),{}):{};Me=s})(r.customFields),r.ignoreCollections&&(u=r.ignoreCollections,$e=u||[]),t.use(f().json()),t.use(f().urlencoded({extended:!0})),t.use("/api",$t),t.get("/admin.js*",(e,t)=>{const s=p().join(__dirname,"admin/index.js");try{var r;const n=(0,Lt.statSync)(s),i=`"${n.size}-${n.mtime.getTime()}"`;if(e.headers["if-none-match"]===i)return t.status(304).end();if(e.headers["accept-encoding"]&&a()(r=e.headers["accept-encoding"]).call(r,"gzip")){t.set({"Content-Type":"application/javascript","Content-Encoding":"gzip","Cache-Control":"public, max-age=31536000, immutable",ETag:i,Vary:"Accept-Encoding"});const e=(0,Lt.createReadStream)(s),r=(0,Gt.createGzip)({level:6});e.pipe(r).pipe(t)}else t.set({"Content-Type":"application/javascript","Cache-Control":"public, max-age=31536000, immutable",ETag:i}),t.sendFile(s)}catch(e){console.error("Error serving admin.js:",e),t.status(500).send("Error loading admin script")}}),t.get("/locales/*.json",(e,t)=>{t.sendFile(p().join(__dirname,`locales/${e.originalUrl.split("/").pop()}`))}),t.get("*",async(e,t,i)=>{var a;if(l()(a=e.path).call(a,"/api/"))return i();const c=Wt(r),u=(()=>{try{const e=p().resolve(__dirname,"build-timestamp.json");if((0,Lt.existsSync)(e)){const t=(0,Lt.readFileSync)(e,"utf8"),{timestamp:s}=JSON.parse(t);return s.toString()}}catch(e){console.warn("Could not read build timestamp:",e.message)}return n()().toString()})();let g=r.webappConfig;if("string"==typeof g)try{const e=s(896),t=s(928).resolve(g);if(console.log("ðŸ“‚ Loading webapp config from file:",t),e.existsSync(t)){const s=e.readFileSync(t,"utf8");g=JSON.parse(s),console.log("âœ… Successfully loaded webapp config from file")}else console.error(`âš ï¸ Webapp config file not found: ${t}`),g=null}catch(e){console.error("âŒ Error loading webapp config file:",e),g=null}const f={webappConfig:g,basePath:e.baseUrl||"",googleMapsApiKey:r.googleMapsApiKey||"",googleMapsOptions:r.googleMapsOptions||{},ignoreCollections:r.ignoreCollections||[],useFirestoreAccessRules:!0===r.useFirestoreAccessRules,ownerEmail:r.ownerEmail||null,storageMaxUploadSizeBytes:o,isConfigured:c.isConfigured,configStatus:c.configStatus,missingItems:c.missingItems,configErrors:c.errors,missingEnvVars:c.missingEnvVars},m=h().replace("{fireenging-base-path}",e.baseUrl).replace('src="admin.js"',`src="admin.js?v=${u}"`).replace("{fireengine-config}",d()(f));t.send(m)}),t}},875:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/date/now")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")},965:e=>{"use strict";e.exports=require("firebase-admin/firestore")},982:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/map")}},r={};function n(e){var t=r[e];if(void 0!==t)return t.exports;var i=r[e]={exports:{}};return s[e](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(s,r){if(1&r&&(s=this(s)),8&r)return s;if("object"==typeof s&&s){if(4&r&&s.__esModule)return s;if(16&r&&"function"==typeof s.then)return s}var i=Object.create(null);n.r(i);var a={};e=e||[null,t({}),t([]),t(t)];for(var o=2&r&&s;("object"==typeof o||"function"==typeof o)&&!~e.indexOf(o);o=t(o))Object.getOwnPropertyNames(o).forEach(e=>a[e]=()=>s[e]);return a.default=()=>s,n.d(i,a),i},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i=n(737);module.exports=i.default})();