(()=>{var e,t,r={16:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/keys")},41:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/includes")},86:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/filter")},107:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=107,e.exports=t},128:(e,t,r)=>{"use strict";r.d(t,{Jk:()=>R,_m:()=>O});var s=r(497),n=r.n(s),i=r(405),o=r.n(i),a=r(718),c=r.n(a),l=r(691),d=r.n(l),u=r(471),p=r.n(u),g=r(668),m=r.n(g),f=r(16),h=r.n(f),v=r(240),E=r.n(v),y=r(86),I=r.n(y),b=r(982),_=r.n(b),w=r(335),N=r.n(w),j=r(464),F=r.n(j);function A(e,t){var r=h()(e);if(n()){var s=n()(e);t&&(s=I()(s).call(s,function(t){return o()(e,t).enumerable})),r.push.apply(r,s)}return r}function S(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?N()(r=A(Object(n),!0)).call(r,function(t){m()(e,t,n[t])}):c()?d()(e,c()(n)):N()(s=A(Object(n))).call(s,function(t){p()(e,t,o()(n,t))})}return e}const P=(e,t)=>process.env[`FIREENGINE_${e}`]||(t?process.env[t]:void 0),C=e=>{if(e)try{return JSON.parse(e)}catch(e){return void console.error("Error parsing JSON environment variable:",e)}},D=()=>{const e={},t=(()=>{const e={};process.env.FIREENGINE_ADMIN_TYPE&&(e.type=process.env.FIREENGINE_ADMIN_TYPE);const t=P("ADMIN_PROJECT_ID")||P("FIREBASE_PROJECT_ID","FIREBASE_PROJECT_ID");t&&(e.project_id=t),process.env.FIREENGINE_ADMIN_PRIVATE_KEY_ID&&(e.private_key_id=process.env.FIREENGINE_ADMIN_PRIVATE_KEY_ID);const s=P("ADMIN_PRIVATE_KEY")||P("FIREBASE_PRIVATE_KEY","FIREBASE_PRIVATE_KEY");s&&(e.private_key=s.replace(/\\n/g,"\n"));const n=P("ADMIN_CLIENT_EMAIL")||P("FIREBASE_CLIENT_EMAIL","FIREBASE_CLIENT_EMAIL");if(n&&(e.client_email=n),process.env.FIREENGINE_ADMIN_CLIENT_ID&&(e.client_id=process.env.FIREENGINE_ADMIN_CLIENT_ID),process.env.FIREENGINE_ADMIN_AUTH_URI&&(e.auth_uri=process.env.FIREENGINE_ADMIN_AUTH_URI),process.env.FIREENGINE_ADMIN_TOKEN_URI&&(e.token_uri=process.env.FIREENGINE_ADMIN_TOKEN_URI),process.env.FIREENGINE_ADMIN_AUTH_PROVIDER_X509_CERT_URL&&(e.auth_provider_x509_cert_url=process.env.FIREENGINE_ADMIN_AUTH_PROVIDER_X509_CERT_URL),process.env.FIREENGINE_ADMIN_CLIENT_X509_CERT_URL&&(e.client_x509_cert_url=process.env.FIREENGINE_ADMIN_CLIENT_X509_CERT_URL),process.env.FIREENGINE_ADMIN_UNIVERSE_DOMAIN&&(e.universe_domain=process.env.FIREENGINE_ADMIN_UNIVERSE_DOMAIN),process.env.FIREENGINE_ADMIN_CREDENTIALS_JSON)try{return JSON.parse(process.env.FIREENGINE_ADMIN_CREDENTIALS_JSON)}catch(e){console.error("Error parsing FIREENGINE_ADMIN_CREDENTIALS_JSON:",e)}if(process.env.FIREENGINE_ADMIN_CREDENTIALS_FILE)try{return r(107)(process.env.FIREENGINE_ADMIN_CREDENTIALS_FILE)}catch(e){console.error("Error loading admin credentials file:",e)}return h()(e).length>0?e:void 0})();t&&(e.adminCredentials=t);const s=(()=>{const e={};process.env.FIREENGINE_WEBAPP_API_KEY&&(e.apiKey=process.env.FIREENGINE_WEBAPP_API_KEY),process.env.FIREENGINE_WEBAPP_AUTH_DOMAIN&&(e.authDomain=process.env.FIREENGINE_WEBAPP_AUTH_DOMAIN);const t=P("WEBAPP_PROJECT_ID")||P("FIREBASE_PROJECT_ID","FIREBASE_PROJECT_ID");if(t&&(e.projectId=t),process.env.FIREENGINE_WEBAPP_STORAGE_BUCKET&&(e.storageBucket=process.env.FIREENGINE_WEBAPP_STORAGE_BUCKET),process.env.FIREENGINE_WEBAPP_MESSAGING_SENDER_ID&&(e.messagingSenderId=process.env.FIREENGINE_WEBAPP_MESSAGING_SENDER_ID),process.env.FIREENGINE_WEBAPP_APP_ID&&(e.appId=process.env.FIREENGINE_WEBAPP_APP_ID),process.env.FIREENGINE_WEBAPP_MEASUREMENT_ID&&(e.measurementId=process.env.FIREENGINE_WEBAPP_MEASUREMENT_ID),process.env.FIREENGINE_WEBAPP_CONFIG_JSON)try{return JSON.parse(process.env.FIREENGINE_WEBAPP_CONFIG_JSON)}catch(e){console.error("Error parsing FIREENGINE_WEBAPP_CONFIG_JSON:",e)}if(process.env.FIREENGINE_WEBAPP_CONFIG_FILE)try{return r(107)(process.env.FIREENGINE_WEBAPP_CONFIG_FILE)}catch(e){console.error("Error loading webapp config file:",e)}return h()(e).length>0?e:void 0})();s&&(e.webappConfig=s);const n=P("FIRESTORE_DATABASE")||P("FIRESTORE_DATABASE_ID","FIRESTORE_DATABASE_ID");n&&(e.firestoreDatabase=n),process.env.FIREENGINE_OWNER_EMAIL&&(e.ownerEmail=process.env.FIREENGINE_OWNER_EMAIL);const i=(e=>{var t;if(!e)return;const r=E()(t=e.toLowerCase()).call(t);return"true"===r||"1"===r||"yes"===r||"false"!==r&&"0"!==r&&"no"!==r&&void 0})(process.env.FIREENGINE_USE_FIRESTORE_ACCESS_RULES);void 0!==i&&(e.useFirestoreAccessRules=i),process.env.FIREENGINE_GOOGLE_MAPS_API_KEY&&(e.googleMapsApiKey=process.env.FIREENGINE_GOOGLE_MAPS_API_KEY);const o=C(process.env.FIREENGINE_GOOGLE_MAPS_OPTIONS);o&&(e.googleMapsOptions=o);const a=(e=>{var t,r;if(e)return I()(t=_()(r=e.split(",")).call(r,e=>E()(e).call(e))).call(t,e=>e.length>0)})(process.env.FIREENGINE_IGNORE_COLLECTIONS);a&&(e.ignoreCollections=a);const c=C(process.env.FIREENGINE_SCHEMA_OVERRIDES);c&&(e.schemaOverrides=c);const l=C(process.env.FIREENGINE_SIGNIN_METHODS);return l&&(e.signinMethods=l),process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE&&(e.storageMaxUploadSize=process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE),e},O=e=>{const t=D(),r=S({},e);return t.adminCredentials&&(r.adminCredentials=t.adminCredentials),t.webappConfig&&(r.webappConfig=S(S({},e.webappConfig),t.webappConfig)),void 0!==t.firestoreDatabase&&(r.firestoreDatabase=t.firestoreDatabase),void 0!==t.ownerEmail&&(r.ownerEmail=t.ownerEmail),void 0!==t.useFirestoreAccessRules&&(r.useFirestoreAccessRules=t.useFirestoreAccessRules),void 0!==t.googleMapsApiKey&&(r.googleMapsApiKey=t.googleMapsApiKey),void 0!==t.googleMapsOptions&&(r.googleMapsOptions=S(S({},e.googleMapsOptions),t.googleMapsOptions)),void 0!==t.ignoreCollections&&(r.ignoreCollections=t.ignoreCollections),void 0!==t.schemaOverrides&&(r.schemaOverrides=S(S({},e.schemaOverrides),t.schemaOverrides)),void 0!==t.signinMethods&&(r.signinMethods=t.signinMethods),void 0!==t.storageMaxUploadSize&&(r.storageMaxUploadSize=t.storageMaxUploadSize),r},R=()=>{const e=D(),t=h()(e);t.length>0?(console.log("FireEngine: Detected environment variables:"),N()(t).call(t,t=>{"adminCredentials"===t?console.log(`  - ${t}: [Firebase Admin SDK credentials loaded]`):"webappConfig"===t?console.log(`  - ${t}: [Firebase Web App config loaded]`):console.log(`  - ${t}: ${F()(e[t])}`)})):console.log("FireEngine: No FIREENGINE_ environment variables detected")}},139:(e,t,r)=>{"use strict";r.d(t,{_A:()=>c,xL:()=>l});var s=r(965),n=r(675),i=r.n(n);let o,a=null;const c=e=>(o=e,a=null,!0),l=()=>{if(!a){if(!i().apps.length)throw new Error("Firebase Admin SDK not initialized. This usually means fireengine() hasn't been called yet or Firebase credentials are missing. Make sure you call fireengine(config) with proper adminCredentials before using any Firebase services.");a=o?(0,s.getFirestore)(i().app(),o):(0,s.getFirestore)(i().app())}return a}},240:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/trim")},253:e=>{"use strict";e.exports=require("firebase/app")},304:e=>{"use strict";e.exports=require("firebase/auth")},316:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/entries")},323:e=>{e.exports='<!DOCTYPE html> <html lang="en"> <head> <base href="{fireenging-base-path}/"> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1"/> <title>FireEngine</title> <link rel="icon" href="data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><text y=\'0.9em\' font-size=\'90\'>ðŸ”¥</text></svg>"> </head> <body> <noscript>You need to enable JavaScript to run this app.</noscript> <div id="root"></div> <script> var fireengineConfig = {fireengine-config}; <\/script> <script src="admin.js"><\/script> </body> </html> '},335:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/for-each")},405:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor")},464:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/json/stringify")},471:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/define-property")},497:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols")},575:(e,t,r)=>{"use strict";r.d(t,{PADDLE_CONFIG:()=>s});const s={licenseApiUrl:(()=>{try{return"https://license.fireengine.dev"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_LICENSE_API_URL||"https://license.fireengine.dev"})(),clientToken:(()=>{try{return"live_2cb28d6b5be3b98a622666387b4"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_CLIENT_TOKEN||"MISSING_PADDLE_CLIENT_TOKEN"})(),environment:"undefined"!=typeof process?"production":"sandbox",prices:{pro_monthly:(()=>{try{return"pri_01k2men96wsraycwnkr2682pky"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_PRICE_PRO_MONTHLY||"MISSING_PADDLE_PRICE_MONTHLY"})(),pro_annual:(()=>{try{return"pri_01k2meq2g0ye64acqynetdsef2"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_PRICE_PRO_ANNUAL||"MISSING_PADDLE_PRICE_ANNUAL"})()},products:{pro:{name:"FireEngine Pro",description:"Complete solution for growing teams and organizations",features:["Unlimited users","Advanced authentication (SAML, OIDC, Phone)","Custom roles and permissions","Schema customization","Unlimited storage","Analytics and audit logs","API access and webhooks","Custom branding","Priority support"],pricing:{monthly:{amount:54,currency:"USD"},annual:{amount:49,currency:"USD",totalAmount:588}}}}}},599:(e,t,r)=>{"use strict";r.d(t,{default:()=>Yt,getFirestoreDatabaseName:()=>Jt});var s=r(875),n=r.n(s),i=r(41),o=r.n(i);const a=require("@babel/runtime-corejs3/core-js-stable/instance/starts-with");var c=r.n(a),l=r(464),d=r.n(l);const u=require("path");var p=r.n(u);const g=require("express");var m=r.n(g),f=r(323),h=r.n(f);const v=require("compose-middleware"),E=require("@babel/runtime-corejs3/core-js-stable/array/is-array");var y=r.n(E),I=r(335),b=r.n(I),_=r(86),w=r.n(_),N=r(675),j=r.n(N),F=r(16),A=r.n(F),S=r(497),P=r.n(S),C=r(405),D=r.n(C),O=r(718),R=r.n(O),T=r(691),M=r.n(T),$=r(471),L=r.n($),U=r(668),G=r.n(U);function q(e,t){var r=A()(e);if(P()){var s=P()(e);t&&(s=w()(s).call(s,function(t){return D()(e,t).enumerable})),r.push.apply(r,s)}return r}let x={useFirestoreAccessRules:!1};const k=()=>x,V=()=>process.env.FIREENGINE_OWNER_EMAIL||x.ownerEmail,B=require("@babel/runtime-corejs3/core-js-stable/map");var K=r.n(B),W=r(615);let H=function(e){return e.FREE="free",e.PRO="pro",e}({});H.FREE,H.PRO;class z{constructor(){G()(this,"validationCache",new(K())),G()(this,"CACHE_TTL",36e5)}async validateLicense(){try{const e=await W.installationService.getInstallation(),t=await W.installationService.getLicenseBinding(),r=this.validationCache.get(e.installationId);if(r&&n()()-r.timestamp<this.CACHE_TTL)return r.result;const s=this.validateLocalLicense(t);return this.cacheResult(e.installationId,s),s}catch(e){return console.error("License validation failed:",e),this.fallbackValidation()}}validateLocalLicense(e){return e.validUntil&&new Date>e.validUntil?{valid:!1,reason:"license_expired",plan:H.FREE,features:this.getFreePlanFeatures()}:e.gracePeriodEnd&&this.isInGracePeriod(e.gracePeriodEnd)?{valid:!0,plan:this.mapPlanString(e.plan),features:e.features||this.getFreePlanFeatures(),gracePeriodEnd:e.gracePeriodEnd,reason:"grace_period"}:{valid:"active"===e.status,plan:this.mapPlanString(e.plan),features:e.features||this.getFreePlanFeatures(),validUntil:e.validUntil}}isInGracePeriod(e){return!!e&&new Date<e}fallbackValidation(){return{valid:!0,plan:H.FREE,features:this.getFreePlanFeatures(),reason:"fallback_mode"}}cacheResult(e,t){this.validationCache.set(e,{result:t,timestamp:n()()})}getFreePlanFeatures(){return{advancedAuth:!1,customRoles:!1,schemaOverrides:!1,apiAccess:!1,unlimitedUsers:!1,unlimitedStorage:!1,analytics:!1,auditLogs:!1,prioritySupport:!1,customBranding:!1,whiteLabel:!1}}getProPlanFeatures(){return{advancedAuth:!0,customRoles:!0,schemaOverrides:!0,apiAccess:!0,unlimitedUsers:!0,unlimitedStorage:!0,analytics:!0,auditLogs:!0,prioritySupport:!0,customBranding:!0,whiteLabel:!0}}mapPlanString(e){return"pro"===e.toLowerCase()?H.PRO:H.FREE}clearCache(){this.validationCache.clear()}}let J=null;const Y={validateLicense:async()=>(J||(J=new z),J.validateLicense()),clearCache(){J&&J.clearCache()}},X=(0,g.Router)({strict:!0}),Z=X;X.get("/auth/auth-providers",async(e,t)=>{try{const e=j().auth(),c={providers:{saml:[],oidc:[]},tenants:[],availableProviders:[],detectedSigninMethods:[]};if("function"==typeof e.listProviderConfigs)try{const t=await e.listProviderConfigs({type:"saml"});t&&y()(t.providerConfigs)&&(c.providers.saml=t.providerConfigs);const r=await e.listProviderConfigs({type:"oidc"});r&&y()(r.providerConfigs)&&(c.providers.oidc=r.providerConfigs)}catch(e){console.error("Error fetching provider configs:",e)}const l=[];try{"function"==typeof e.createUser&&(l.push({type:"SIGNIN_METHOD_EMAIL",signInWithEmailLink:!1,title:"Email & Password"}),l.push({type:"SIGNIN_METHOD_EMAIL",signInWithEmailLink:!0,title:"Email Link (Passwordless)"}))}catch(e){console.log("Email authentication detection failed:",e.message)}try{const e=process.env.FIREENGINE_WEBAPP_CONFIG?JSON.parse(process.env.FIREENGINE_WEBAPP_CONFIG):null;e?.authDomain&&l.push({type:"SIGNIN_METHOD_GOOGLE",title:"Google"})}catch(e){console.log("Google provider detection failed:",e.message)}var r,s;c.providers.saml.length>0&&b()(r=c.providers.saml).call(r,e=>{l.push({type:"SIGNIN_METHOD_SAML",providerId:e.providerId,title:e.displayName||e.providerId})}),c.providers.oidc.length>0&&b()(s=c.providers.oidc).call(s,e=>{l.push({type:"SIGNIN_METHOD_OIDC",providerId:e.providerId,title:e.displayName||e.providerId})}),c.detectedSigninMethods=l;try{var n;const t=[];if("function"==typeof e.createUser&&t.push("password"),"function"==typeof e.listProviderConfigs)try{const r=await e.listProviderConfigs({type:"saml"}),s=await e.listProviderConfigs({type:"oidc"});var i,a;r&&y()(r.providerConfigs)&&b()(i=r.providerConfigs).call(i,e=>{e.providerId&&t.push(e.providerId)}),s&&y()(s.providerConfigs)&&b()(a=s.providerConfigs).call(a,e=>{e.providerId&&t.push(e.providerId)})}catch(e){console.log("Error getting SAML/OIDC providers, using defaults:",e.message)}b()(n=["google.com","facebook.com","twitter.com","github.com","microsoft.com","apple.com"]).call(n,e=>{o()(t).call(t,e)||t.push(e)}),c.availableProviders=t}catch(e){console.error("Error getting available providers:",e)}try{if("function"==typeof e.tenantManager){const t=e.tenantManager();if(t&&"function"==typeof t.listTenants){const e=await t.listTenants();e&&y()(e.tenants)&&(c.tenants=e.tenants)}}}catch(e){console.log("Tenant manager not available:",e.message)}return t.json(c)}catch(e){return console.error("Error fetching auth providers:",e),t.status(500).json({error:"Failed to fetch auth providers",message:e.message})}}),X.get("/auth/detected-signin-methods",async(e,t)=>{try{const e=j().auth(),o=[],a=x.webappConfig;try{if("function"==typeof e.listProviderConfigs){const t=await e.listProviderConfigs({type:"saml"});var s;t?.providerConfigs&&t.providerConfigs.length>0&&b()(s=t.providerConfigs).call(s,e=>{o.push({type:"SIGNIN_METHOD_SAML",providerId:e.providerId,title:e.displayName||e.providerId,enabled:e.enabled,metadata:{issuer:e.idpConfig?.idpEntityId,ssoUrl:e.idpConfig?.ssoUrl,certificates:e.idpConfig?.idpCertificates,requestUri:e.spConfig?.callbackUri}})});const r=await e.listProviderConfigs({type:"oidc"});var i;r?.providerConfigs&&r.providerConfigs.length>0&&b()(i=r.providerConfigs).call(i,e=>{o.push({type:"SIGNIN_METHOD_OIDC",providerId:e.providerId,title:e.displayName||e.providerId,enabled:e.enabled,metadata:{issuer:e.issuer,clientId:e.clientId,responseType:e.responseType,scopes:["openid","email","profile"],redirectUri:`https://${a?.authDomain}/__/auth/handler`}})})}}catch(e){}try{if("function"==typeof e.createUser&&a?.authDomain){let e=!1,t=!1;try{const{initializeApp:s,getApps:i}=await Promise.resolve().then(r.t.bind(r,253,23)),{getAuth:o,createUserWithEmailAndPassword:c,sendSignInLinkToEmail:l,deleteUser:d}=await Promise.resolve().then(r.t.bind(r,304,23));let u;i();const p=`test-auth-detection-${n()()}`;try{u=s(a,p);const r=o(u),i=`test-auth-${n()()}@fireengine-test.invalid`,g="TestPassword123!";try{const t=await c(r,i,g);if(e=!0,t.user)try{await d(t.user)}catch(e){}}catch(t){"auth/operation-not-allowed"===t.code&&(e=!1)}try{await l(r,i,{url:`https://${a.authDomain}`,handleCodeInApp:!0}),t=!0}catch(e){"auth/operation-not-allowed"===e.code&&(t=!1)}}finally{if(u)try{await u.delete()}catch(e){}}}catch(r){e=!1,t=!1}e&&t?o.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!0,supportsEmailLink:!0,title:"Email Authentication"}):e?o.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!0,supportsEmailLink:!1,signInWithEmailLink:!1,title:"Email & Password"}):t&&o.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!1,supportsEmailLink:!0,signInWithEmailLink:!0,title:"Email Link (Passwordless)"})}}catch(e){}try{let e=!1;if(a?.authDomain&&a?.apiKey){try{e=!0}catch(t){e=!1}e&&o.push({type:"SIGNIN_METHOD_PHONE",title:"Phone"})}}catch(e){}try{let e=!1;if(a?.authDomain&&a?.apiKey){try{const{initializeApp:t}=await Promise.resolve().then(r.t.bind(r,253,23)),{getAuth:s,GoogleAuthProvider:i,signInWithCredential:o,GoogleAuthProvider:c}=await Promise.resolve().then(r.t.bind(r,304,23));let l;const d=`test-google-detection-${n()()}`;try{l=t(a,d);const r=s(l);new i;try{const t=i.credential("fake_id_token","fake_access_token");await o(r,t),e=!1}catch(t){e="auth/operation-not-allowed"!==t.code&&("auth/invalid-credential"===t.code||"auth/argument-error"===t.code||"auth/invalid-id-token"===t.code)}}finally{if(l)try{await l.delete()}catch(e){}}}catch(t){e=!1}e&&o.push({type:"SIGNIN_METHOD_GOOGLE",title:"Google"})}}catch(e){}try{let e=!1;if(a?.authDomain&&a?.apiKey){try{e=!1}catch(t){e=!1}e&&o.push({type:"SIGNIN_METHOD_MICROSOFT",title:"Microsoft"})}}catch(e){}try{let e=!1;if(a?.authDomain&&a?.apiKey){try{e=!1}catch(t){e=!1}e&&o.push({type:"SIGNIN_METHOD_APPLE",title:"Apple"})}}catch(e){}try{let e=!1;if(a?.authDomain&&a?.apiKey){try{e=!1}catch(t){e=!1}e&&o.push({type:"SIGNIN_METHOD_GITHUB",title:"GitHub"})}}catch(e){}try{let e=!1;if(a?.authDomain&&a?.apiKey){try{e=!1}catch(t){e=!1}e&&o.push({type:"SIGNIN_METHOD_FACEBOOK",title:"Facebook"})}}catch(e){}let c=o;try{const e=await Y.validateLicense();await W.installationService.getLicenseBinding(),e.valid&&e.features?.advancedAuth||(c=w()(o).call(o,e=>"SIGNIN_METHOD_EMAIL"===e.type))}catch(e){c=w()(o).call(o,e=>"SIGNIN_METHOD_EMAIL"===e.type)}return t.json({detectedMethods:c,detectedAt:(new Date).toISOString()})}catch(e){return console.error("Error detecting signin methods:",e),t.status(500).json({error:"Failed to detect signin methods",message:e.message})}});var Q=r(240),ee=r.n(Q),te=r(316),re=r.n(te);const se=require("@babel/runtime-corejs3/core-js-stable/instance/some");var ne=r.n(se);const ie=require("@babel/runtime-corejs3/core-js-stable/object/values");var oe=r.n(ie);const ae=require("@babel/runtime-corejs3/core-js-stable/instance/bind");var ce=r.n(ae);const le=require("@babel/runtime-corejs3/core-js-stable/instance/reduce");var de=r.n(le);const ue=require("@babel/runtime-corejs3/core-js-stable/instance/slice");var pe=r.n(ue);const ge=require("@babel/runtime-corejs3/core-js-stable/instance/find-index");var me=r.n(ge);const fe=require("@babel/runtime-corejs3/core-js-stable/instance/find");var he=r.n(fe);const ve=require("@babel/runtime-corejs3/core-js-stable/set");var Ee=r.n(ve);const ye=require("@babel/runtime-corejs3/core-js-stable/promise");var Ie=r.n(ye),be=r(982),_e=r.n(be);const we=require("@babel/runtime-corejs3/core-js-stable/instance/sort");var Ne=r.n(we);const je=require("@babel/runtime-corejs3/core-js-stable/instance/index-of");var Fe=r.n(je);const Ae=require("@babel/runtime-corejs3/core-js-stable/instance/values");var Se=r.n(Ae),Pe=r(965);function Ce(e,t){var r=A()(e);if(P()){var s=P()(e);t&&(s=w()(s).call(s,function(t){return D()(e,t).enumerable})),r.push.apply(r,s)}return r}function De(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?b()(r=Ce(Object(n),!0)).call(r,function(t){G()(e,t,n[t])}):R()?M()(e,R()(n)):b()(s=Ce(Object(n))).call(s,function(t){L()(e,t,D()(n,t))})}return e}let Oe=null,Re={},Te={},Me={},$e=[];const Le=e=>{var t;if(!e||!e.type)return e;const r={array:["validTypes","min","max"],string:["min","max","options"],number:["min","max"],assets:["min","max"],reference:["referencePath"],dropdown:["options"],editor:["min","max"],map:["fields"]},s=["name","type","title","required","width","default","validate",...r[e.type]||[]],n={};return b()(s).call(s,t=>{void 0!==e[t]&&(n[t]=e[t])}),b()(t=A()(e)).call(t,t=>{var i;o()(s).call(s,t)||n[t]||(ne()(i=oe()(r)).call(i,s=>{var n,i;return o()(s).call(s,t)&&!(null==(n=r[e.type])?void 0:ce()(i=Function.call).call(i,o()(n),n))?.(t)})||(n[t]=e[t]))}),n},Ue=()=>{Oe=null},Ge=e=>{if("_customFields"===e||"_fireengineMeta"===e)return!0;if(0===$e.length)return!1;if(o()($e).call($e,e))return!0;const t=e.split("/");if(t.length>1)for(let e=1;e<t.length;e+=2){const r=pe()(t).call(t,0,e).join("/");if(o()($e).call($e,r))return!0}return!1},qe=async(e=!1)=>{const t=await(async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(r.bind(r,599)),t=await e(),{getFirestore:s}=await Promise.resolve().then(r.t.bind(r,965,23)),n=await Promise.resolve().then(r.t.bind(r,675,23)),i=t?s(n.default.app(),t):s(n.default.app()),o=await i.collection("_fireengineMeta").doc("schemaOverrides").get();if(o.exists){const e=o.data();return e?.overrides||{}}return{}}catch(e){return console.warn("Failed to load GUI schema overrides:",e.message),{}}})();Te=t;const s=A()(Re).length>0||A()(Te).length>0;if(Oe&&!e&&((new Date).getTime()-Oe.lastUpdated.getTime())/1e3<Oe.ttl)return xe(Oe.schema);try{const e=await ke();return Oe={schema:e,lastUpdated:new Date,ttl:300},xe(e)}catch(e){return console.error("Error fetching schema from Firestore:",e),Oe?xe(Oe.schema):s?xe({}):{collections:{},meta:{},layers:{autoDetected:{},codeOverrides:{},guiOverrides:{}}}}},xe=e=>{var t,r;const s=JSON.parse(d()(e)),n=JSON.parse(d()(Re)),i=JSON.parse(d()(Te)),o=JSON.parse(d()(e)),a=De({},Re);b()(t=A()(Te)).call(t,e=>{if(a[e]){const t=a[e],r=Te[e];let s=[],n={};y()(t)?s=t:t&&"object"==typeof t&&(s=t.fields||[],n={title:t.title,titleTemplate:t.titleTemplate,ignoreFields:t.ignoreFields||[],includeFields:t.includeFields||[]});let i=[],o={};y()(r)?i=r:r&&"object"==typeof r&&(i=r.fields||[],o={title:r.title,titleTemplate:r.titleTemplate,ignoreFields:r.ignoreFields||[],includeFields:r.includeFields||[]});const c=[...s];b()(i).call(i,e=>{const t=me()(c).call(c,t=>t.name===e.name);t>=0?c[t]=De(De({},c[t]),e):c.push(e)}),a[e]=De(De(De({},n),o),{},{fields:c})}else a[e]=Te[e]}),b()(r=A()(a)).call(r,e=>{Te[e];const t=a[e];let r=[],s={};y()(t)?r=t:t&&"object"==typeof t&&(r=t.fields||[],s={title:t.title,titleTemplate:t.titleTemplate,ignoreFields:t.ignoreFields||[],includeFields:t.includeFields||[]}),o[e]||(o[e]={fields:[]});const n=o[e]?.fields||[];let i=[];r.length>0?(b()(r).call(r,e=>{const t=he()(n).call(n,t=>t.name===e.name);if(t){const r=De(De({},t),e);if(e.validate&&"function"==typeof e.validate&&(r.validate=e.validate.toString()),"array"===r.type){const s=t.validTypes||[],n=e.validTypes||[];n.length>0?r.validTypes=[...new(Ee())(n)]:s.length>0&&(r.validTypes=[...new(Ee())(s)])}else delete r.validTypes;const s=Le(r);if(void 0!==e.width){const t=Number(e.width);isNaN(t)||(s.width=Math.max(.08333333,Math.min(1,t)))}i.push(s)}else if(e.type){const t=De({},e);e.validate&&"function"==typeof e.validate&&(t.validate=e.validate.toString());const r=Le(t);if(void 0!==r.width){const e=Number(r.width);isNaN(e)||(r.width=Math.max(.08333333,Math.min(1,e)))}i.push(r)}else console.warn(`Override field '${e.name}' has no type and no auto-detected field found. Skipping.`)}),b()(n).call(n,e=>{const t=ne()(r).call(r,t=>t.name===e.name);t||i.push(e)})):i=[...n],o[e]=De(De({},o[e]),{},{fields:i},s)}),A()(Me).length>0&&(o._customFields=Me);const c={},l={};for(const[e,t]of re()(o))"_customFields"===e||"_fireengineMeta"===e?l[e]=t:c[e]=t;return{collections:c,meta:l,layers:{autoDetected:s,codeOverrides:n,guiOverrides:i}}},ke=async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(r.bind(r,599)),t=await e(),s=t?(0,Pe.getFirestore)(j().app(),t):(0,Pe.getFirestore)(j().app()),n=await s.listCollections();if(0===n.length)return{};const i=w()(n).call(n,e=>!Ge(e.id)),o=await Ie().all(_e()(i).call(i,Ve()));return Ke(o)}catch(e){throw console.error("Error fetching schema from Firestore:",e),e}},Ve=e=>async t=>{try{let r;const s=["createdAt","created_at","dateCreated","timestamp","_createdAt"];for(const e of s)try{if(r=await t.orderBy(e,"asc").limit(1).get(),!r.empty)break}catch(e){continue}if(!r||r.empty){const r=await t.limit(5).get();if(r.empty)return Ie().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[]}});const s={},n=r.docs[0]?.ref;for(const e of r.docs){const t=e._fieldsProto;if(t)for(const[e,r]of re()(t))if(s[e]){if(s[e].valueType!==r.valueType){const t={referenceValue:5,timestampValue:4,integerValue:3,doubleValue:3,stringValue:2,booleanValue:1,nullValue:0},n=t[s[e].valueType]||0;(t[r.valueType]||0)>n&&(s[e]=r)}}else s[e]=r}const i=A()(s).length>0?Be(s):null,o=n?await n.listCollections():[],a=w()(o).call(o,r=>{const s=`${e?`${e}/`:""}${t.id}/${r.id}`;return!Ge(s)}),c=await Ie().all(_e()(a).call(a,Ve(`${e?`${e}/`:""}${t.id}`)));return Ie().resolve(De({[`${e?`${e}/`:""}${t.id}`]:i?{fields:i}:null},Ke(c)))}if(r.empty)return Ie().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[]}});const n=r.docs[0]?._fieldsProto,i=r.docs[0]?.ref,o=i?await i.listCollections():[],a=w()(o).call(o,r=>{const s=`${e?`${e}/`:""}${t.id}/${r.id}`;return!Ge(s)}),c=await Ie().all(_e()(a).call(a,Ve(`${e?`${e}/`:""}${t.id}`))),l=n?Be(n):null;return Ie().resolve(De({[`${e?`${e}/`:""}${t.id}`]:l?{fields:l}:null},Ke(c)))}catch(r){return console.error(`Error processing collection ${t.id}:`,r),Ie().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[],error:r.message}})}},Be=e=>{try{var t;const r=Ne()(t=A()(e)).call(t,(e,t)=>{const r=["id","name","title"],s=Fe()(r).call(r,e),n=Fe()(r).call(r,t);return-1!==s&&-1!==n?s-n:-1!==s?-1:-1!==n?1:e.localeCompare(t)});return _e()(r).call(r,t=>{var r;let s;if("referenceValue"===e[t].valueType){const r=e[t].referenceValue;let n;if(o()(r).call(r,"databases/(default)/documents/")){const e=r.split("databases/(default)/documents/");n=e.length>1?e[e.length-1]:void 0}else if(o()(r).call(r,"documents/")){const e=r.split("documents/");n=e.length>1?e[e.length-1]:void 0}else o()(r).call(r,"/")&&(n=r);if(n){const e=n.split("/");s=w()(e).call(e,(e,t)=>t%2==0).join("/")}}const n=De(De(De({name:t,type:We(e[t].valueType)},"mapValue"===e[t].valueType&&{fields:Be(e[t].mapValue.fields)}),"arrayValue"===e[t].valueType&&Se()(e[t].arrayValue)&&{validTypes:_e()(r=Se()(e[t].arrayValue)).call(r,e=>We(e.valueType))}),s&&{referencePath:s});return Le(n)})}catch(e){return console.error("Error processing fields:",e),[]}},Ke=e=>{try{return de()(e).call(e,(e,t)=>De(De({},e),t),{})}catch(e){return console.error("Error combining collections:",e),{}}},We=e=>"geoPointValue"===e?"geoPoint":"referenceValue"===e?"reference":e.replace("Value","");function He(e,t){var r=A()(e);if(P()){var s=P()(e);t&&(s=w()(s).call(s,function(t){return D()(e,t).enumerable})),r.push.apply(r,s)}return r}const ze=async(e,t,r)=>{try{const s=e.headers.authorization;if(!s||!c()(s).call(s,"Bearer "))return t.status(401).json({error:"No valid authorization token provided"});const n=s.split("Bearer ")[1],i=await j().auth().verifyIdToken(n);e.user=function(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?b()(r=He(Object(n),!0)).call(r,function(t){G()(e,t,n[t])}):R()?M()(e,R()(n)):b()(s=He(Object(n))).call(s,function(t){L()(e,t,D()(n,t))})}return e}({uid:i.uid,email:i.email,email_verified:i.email_verified,role:i.role||i.customClaims?.role||""},i),r()}catch(e){return console.error("Authentication error:",e),t.status(401).json({error:"Invalid or expired token"})}},Je=(e,t)=>Boolean(t&&e===t),Ye=(e,t)=>e?Je(e.email||"",t)?"admin":e.role||"":"",Xe=(0,g.Router)({strict:!0}),Ze=Xe;Xe.get("/schema",ze,async(e,t)=>{try{const r=process.env.FIREENGINE_OWNER_EMAIL;if(!Je(e.user?.email||"",r)){const s=Ye(e.user,r);if(!s||""===ee()(s).call(s))return t.status(403).json({error:"Access denied",message:"User role required to access schema"})}const s="true"===e.query.refresh,n=await qe(s);return t.json(n)}catch(e){return console.error("Error fetching schema:",e),t.status(500).json({error:"Failed to fetch schema",message:e.message})}}),Xe.post("/schema/refresh",ze,async(e,t)=>{try{const r=process.env.FIREENGINE_OWNER_EMAIL;if(!Je(e.user?.email||"",r)){const s=Ye(e.user,r);if(!s||""===ee()(s).call(s))return t.status(403).json({error:"Access denied",message:"User role required to refresh schema"})}Ue();const s=await qe(!0);return t.json({success:!0,message:"Schema cache cleared and refreshed",schema:s})}catch(e){return console.error("Error refreshing schema:",e),t.status(500).json({error:"Failed to refresh schema",message:e.message})}}),Xe.post("/schema-overrides",ze,async(e,t)=>{try{const s=process.env.FIREENGINE_OWNER_EMAIL;if(!Je(e.user?.email||"",s)){const r=Ye(e.user,s);if(!r||""===ee()(r).call(r))return t.status(403).json({error:"Access denied",message:"User role required to save schema overrides"})}const{overrides:n}=e.body;if(!n||"object"!=typeof n)return t.status(400).json({error:"Invalid overrides data"});const{getFirestoreDatabaseName:i}=await Promise.resolve().then(r.bind(r,599)),o=await i(),a=o?(0,Pe.getFirestore)(j().app(),o):(0,Pe.getFirestore)(j().app());return await a.collection("_fireengineMeta").doc("schemaOverrides").set({overrides:n,updatedAt:j().firestore.FieldValue.serverTimestamp(),updatedBy:e.user?.uid||"system"}),(e=>{Te=e||{}})(n),Ue(),t.json({success:!0,message:"Schema overrides saved successfully"})}catch(e){return console.error("Error saving GUI schema overrides:",e),t.status(500).json({error:"Failed to save GUI schema overrides",message:e.message})}});const Qe=async(e,t,s,n)=>{if(!e)return!1;if(Je(e.email||"",n))return console.log("Owner access granted for:",e.email),!0;const i=Ye(e,n);if(!i||""===ee()(i).call(i))return console.log("Permission denied: User has no role assigned",{user:e.email,uid:e.uid,role:e.role}),!1;const o=await(async(e,t)=>{if(!e)return null;const s=Ye(e,t);if(!s)return null;const n=await(async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(r.bind(r,599)),t=await e(),s=t?(0,Pe.getFirestore)(N.app(),t):(0,Pe.getFirestore)(N.app()),n=await s.collection("_fireengineMeta").doc("roles").get(),i=[{id:"admin",name:"Admin",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!0,write:!0},settings:{read:!0,write:!0}},predefined:!0},{id:"editor",name:"Editor",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0},{id:"viewer",name:"Viewer",permissions:{content:{},assets:{read:!0,write:!1},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0}];if(n.exists){const e=n.data(),t=e?.customRoles||[];return[...i,...t]}return i}catch(e){return console.error("Error loading roles:",e),[{id:"admin",name:"Admin",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!0,write:!0},settings:{read:!0,write:!0}},predefined:!0},{id:"editor",name:"Editor",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0},{id:"viewer",name:"Viewer",permissions:{content:{},assets:{read:!0,write:!1},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0}]}})(),i=he()(n).call(n,e=>e.id===s);return i?.permissions||null})(e,n);if(!o&&"admin"===e.role)return!0;if(!o)return!1;if("system:users"===t||"system:assets"===t||"system:settings"===t){const e=o[t.replace("system:","")];return e?.[s]||!1}let a=o.content[t]?.[s]||!1;if(!a){const t=Ye(e,n);("admin"===t||"editor"===t||"viewer"===t&&"read"===s)&&(a=!0)}return a},et=e=>async(t,r,s)=>{try{const n=k(),i=V();if(!0===n.useFirestoreAccessRules)return s();if(!t.user)return r.status(401).json({error:"Authentication required"});if(!await Qe(t.user,e,"read",i))return r.status(403).json({error:"Insufficient permissions",message:`Read access denied for resource: ${e}`});s()}catch(e){return console.error("Permission check error:",e),r.status(500).json({error:"Internal server error"})}},tt=e=>async(t,r,s)=>{try{const n=k(),i=V();if(!0===n.useFirestoreAccessRules)return s();if(!t.user)return r.status(401).json({error:"Authentication required"});if(!await Qe(t.user,e,"write",i))return r.status(403).json({error:"Insufficient permissions",message:`Write access denied for resource: ${e}`});s()}catch(e){return console.error("Permission check error:",e),r.status(500).json({error:"Internal server error"})}},rt=e=>async(t,r,s)=>{try{const n=k(),i=V();if(!0===n.useFirestoreAccessRules)return s();if(!t.user)return r.status(401).json({error:"Authentication required"});const o=t.query.collectionPath||t.body.collectionPath;if(!o||"string"!=typeof o)return r.status(400).json({error:"Collection path is required"});if(c()(o).call(o,"_fireengine"))return s();if(!await Qe(t.user,o,e,i))return r.status(403).json({error:"Insufficient permissions",message:`${e} access denied for collection: ${o}`});s()}catch(e){return console.error("Permission check error:",e),r.status(500).json({error:"Internal server error"})}},st=(0,g.Router)({strict:!0}),nt=st;st.get("/users",ze,et("system:users"),async(e,t)=>{try{const e=await it();return t.json(e)}catch(e){return console.error("Error fetching users:",e),t.status(500).json({error:"Failed to fetch users",message:e.message})}}),st.put("/users/:uid",ze,tt("system:users"),async(e,t)=>{try{const{uid:r}=e.params,{email:s,displayName:n,disabled:i,emailVerified:o,customClaims:a}=e.body,c={};void 0!==s&&(c.email=s),void 0!==n&&(c.displayName=n),void 0!==i&&(c.disabled=i),void 0!==o&&(c.emailVerified=o);const l=await j().auth().updateUser(r,c);if(void 0!==a){await j().auth().setCustomUserClaims(r,a);const e=await j().auth().getUser(r);return t.json(e)}return t.json(l)}catch(e){return console.error("Error updating user:",e),t.status(500).json({error:"Failed to update user",message:e.message})}}),st.delete("/users/:uid",ze,tt("system:users"),async(e,t)=>{try{const{uid:r}=e.params;return await j().auth().deleteUser(r),t.json({success:!0,message:"User deleted successfully"})}catch(e){return console.error("Error deleting user:",e),t.status(500).json({error:"Failed to delete user",message:e.message})}}),st.post("/users",ze,tt("system:users"),async(e,t)=>{try{const{email:r,password:s,displayName:n,emailVerified:i=!1,disabled:o=!1,customClaims:a}=e.body;if(!r)return t.status(400).json({error:"Email is required"});const c={email:r,emailVerified:i,disabled:o};s&&(c.password=s),n&&(c.displayName=n);const l=await j().auth().createUser(c);if(a&&A()(a).length>0){await j().auth().setCustomUserClaims(l.uid,a);const e=await j().auth().getUser(l.uid);return t.json(e)}return t.json(l)}catch(e){return console.error("Error creating user:",e),t.status(500).json({error:"Failed to create user",message:e.message})}});const it=async e=>{try{const t=await j().auth().listUsers(1e3,e),r=t.users||[];if(t.pageToken){const e=await it(t.pageToken);return[...r,...e]}return r}catch(e){throw console.error("Error in listAllUsers:",e),e}},ot=require("@babel/runtime-corejs3/helpers/objectWithoutProperties");var at=r.n(ot);const ct=require("@babel/runtime-corejs3/core-js-stable/parse-int");var lt=r.n(ct);const dt=["id"];function ut(e,t){var r=A()(e);if(P()){var s=P()(e);t&&(s=w()(s).call(s,function(t){return D()(e,t).enumerable})),r.push.apply(r,s)}return r}function pt(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?b()(r=ut(Object(n),!0)).call(r,function(t){G()(e,t,n[t])}):R()?M()(e,R()(n)):b()(s=ut(Object(n))).call(s,function(t){L()(e,t,D()(n,t))})}return e}const gt=(0,g.Router)({strict:!0}),mt=gt,ft=e=>{if(null==e)return e;const{id:t}=e;return at()(e,dt)},ht=(e,t)=>{if(null==e)return e;if(y()(e))return _e()(e).call(e,e=>ht(e,t));if("object"==typeof e){if(e._path&&e._path.segments&&y()(e._path.segments)&&e.id){const r=e._path.segments;if(r.length>=2&&r.length%2==0)try{const e=pe()(r).call(r,0,-1).join("/"),s=r[r.length-1];return console.log(`Converting reference-like object to DocumentReference: ${e}/${s}`),t.collection(e).doc(s)}catch(t){return console.warn("Failed to convert reference-like object to DocumentReference:",t),e}}if(void 0!==e.latitude&&void 0!==e.longitude||void 0!==e._latitude&&void 0!==e._longitude)try{const t=void 0!==e.latitude?e.latitude:e._latitude,s=void 0!==e.longitude?e.longitude:e._longitude;console.log(`Converting GeoPoint-like object: lat=${t}, lng=${s}`);const{GeoPoint:n}=r(965);return new n(t,s)}catch(t){return console.warn("Failed to convert GeoPoint-like object:",t),e}if(void 0!==e.seconds&&void 0!==e.nanoseconds||void 0!==e._seconds&&void 0!==e._nanoseconds)try{const t=void 0!==e.seconds?e.seconds:e._seconds,s=void 0!==e.nanoseconds?e.nanoseconds:e._nanoseconds;console.log(`Converting Timestamp-like object: seconds=${t}, nanoseconds=${s}`);const{Timestamp:n}=r(965);return new n(t,s)}catch(t){return console.warn("Failed to convert Timestamp-like object:",t),e}if(e instanceof Date||"string"==typeof e&&!isNaN(Date.parse(e)))try{const t=e instanceof Date?e:new Date(e);console.log(`Converting Date to Timestamp: ${t.toISOString()}`);const{Timestamp:s}=r(965);return s.fromDate(t)}catch(t){return console.warn("Failed to convert Date to Timestamp:",t),e}const s={};for(const[r,n]of re()(e))s[r]=ht(n,t);return s}return e};gt.get("/firestore/documents",ze,rt("read"),async(e,t)=>{console.log("Handling /api/firestore/documents request");try{const n=e.query.collectionPath,i=e.query.search||"",a=e.query.limit?lt()(e.query.limit.toString(),10):null,c=e.query.offset?lt()(e.query.offset.toString(),10):0;if(!n)return console.log("Missing collectionPath parameter in /documents request"),t.status(400).json({error:"Missing collectionPath parameter"});console.log(`Fetching documents for collection: ${n}, search: "${i}", limit: ${a}, offset: ${c}`);const l=await Jt();console.log(`Using Firestore database: ${l||"default"}`);const d=l?(0,Pe.getFirestore)(j().app(),l):(0,Pe.getFirestore)(j().app());try{var r;const e=d.collection(n.toString()),l=await e.get();if(l.empty)return console.log(`Collection ${n} is empty or doesn't exist yet - returning empty response`),t.status(200).json({documents:[],totalCount:0,hasMore:!1});let u=_e()(r=l.docs).call(r,e=>pt({id:e.id},e.data()));if(i&&ee()(i).call(i)){var s;const e=ee()(s=i.toLowerCase()).call(s);u=w()(u).call(u,t=>{var r;const s=["title","name","displayName","text","content","description","email","firstName","lastName","subject","body","message"];return ne()(s).call(s,r=>{const s=t[r];var n;return"string"==typeof s&&o()(n=s.toLowerCase()).call(n,e)})||o()(r=t.id.toLowerCase()).call(r,e)})}const p=u.length;let g=u;if(null!==a){const e=c||0,t=e+a;g=pe()(u).call(u,e,t)}const m=null!==a&&c+a<p;return console.log(`Successfully fetched ${g.length} of ${p} documents from ${n}${i?` (filtered by "${i}")`:""}`),t.status(200).json({documents:g,totalCount:p,hasMore:m,searchTerm:i||null})}catch(e){return console.log(`Collection ${n} could not be accessed (likely doesn't exist yet): ${e.message}`),console.log("Returning empty response for non-existent collection"),t.status(200).json({documents:[],totalCount:0,hasMore:!1})}}catch(e){return console.error("Error fetching documents:",e),t.status(500).json({error:"Failed to fetch documents",message:e.message||"Unknown error"})}}),gt.get("/firestore/document",ze,rt("read"),async(e,t)=>{console.log("Handling /api/firestore/document request");try{const{collectionPath:r,documentId:s}=e.query;if(!r||!s)return t.status(400).json({error:"Missing required parameters"});console.log(`Fetching document: ${r}/${s}`);const n=await Jt();console.log(`Using Firestore database: ${n||"default"}`);const i=(n?(0,Pe.getFirestore)(j().app(),n):(0,Pe.getFirestore)(j().app())).collection(r.toString()).doc(s.toString()),o=await i.get();return o.exists?t.json(pt({id:o.id},o.data())):t.status(404).json({error:"Document not found"})}catch(e){return console.error("Error fetching document:",e),t.status(500).json({error:"Failed to fetch document",message:e.message})}}),gt.post("/firestore/document",ze,rt("write"),async(e,t)=>{console.log("Handling POST /api/firestore/document request");try{const{collectionPath:r,data:s,documentId:n}=e.body;if(!r||!s)return t.status(400).json({error:"Missing required parameters"});console.log(`Creating document in: ${r}${n?` with ID: ${n}`:""}`,s);const i=await vt(r,s);if(!i.isValid)return console.log("Validation failed:",i.errors),t.status(400).json({error:"Validation failed",errors:i.errors});const a=await Jt();console.log(`Using Firestore database: ${a||"default"}`);const c=j().app().options.projectId,l=j().app().options.credential;console.log(`Using Firebase project: ${c}`),console.log(`Admin SDK initialized: ${j().apps.length>0}`),console.log(`Credential type: ${l?.constructor?.name}`);let d,u=null;if(l&&(l._certificate&&l._certificate.client_email?(u=l._certificate.client_email,console.log(`Service account email (method 1): ${u}`)):l.certificate&&l.certificate.client_email?(u=l.certificate.client_email,console.log(`Service account email (method 2): ${u}`)):l.clientEmail?(u=l.clientEmail,console.log(`Service account email (method 3): ${u}`)):l.client_email?(u=l.client_email,console.log(`Service account email (method 4): ${u}`)):(console.log(`Could not extract service account email. Credential keys: ${A()(l)}`),console.log(`Credential clientEmail property: ${l.clientEmail}`),console.log(`Credential client_email property: ${l.client_email}`))),u){console.log(`Service account project matches: ${o()(u).call(u,c)}`);const e=`firebase-adminsdk-.*@${c}\\.iam\\.gserviceaccount\\.com`,t=new RegExp(e).test(u);console.log(`Service account format is correct: ${t}`),t||(console.log(`Expected format: firebase-adminsdk-xxxxx@${c}.iam.gserviceaccount.com`),console.log(`Actual email: ${u}`))}if(a){console.log(`Connecting directly to named database: ${a}`);try{d=(0,Pe.getFirestore)(j().app(),a),console.log(`Successfully connected to database: ${a}`)}catch(e){throw console.log(`Failed to connect to database ${a}: ${e.message}`),new Error(`Unable to connect to Firestore database: ${a}`)}}else console.log("No database name provided, this shouldn't happen with auto-discovery"),d=(0,Pe.getFirestore)(j().app());try{const e=ft(s),i=ht(e,d);let o,a;return n?(console.log(`Attempting to set document with ID: ${r}/${n}`),o=d.collection(r).doc(n),await o.set(i),a=n,console.log(`Successfully set document: ${r}/${n}`)):(console.log(`Attempting to add document to collection: ${r}`),o=await d.collection(r).add(i),a=o.id,console.log(`Successfully created document: ${r}/${o.id}`)),t.json({id:a,success:!0})}catch(e){if(console.error(`Error adding document to ${r}:`,e),5===e.code||"NOT_FOUND"===e.code)return t.status(404).json({error:"Collection or database not found",message:"This might be due to Firestore security rules, invalid project configuration, or authentication issues",details:e.message});if(7===e.code||"PERMISSION_DENIED"===e.code)return t.status(403).json({error:"Permission denied",message:"Firestore security rules are blocking this write operation",details:e.message});throw e}}catch(e){return console.error("Error adding document:",e),t.status(500).json({error:"Failed to add document",message:e.message||"Unknown error",code:e.code||"UNKNOWN"})}});const vt=async(e,t)=>{const r={};try{const s=(await qe()).collections[e];if(!s||!s.fields)return{isValid:!0,errors:{}};for(const e of s.fields){const s=t[e.name];if(!e.required||null!=s&&""!==s){if(e.validate&&"string"==typeof e.validate)try{const t=new Function("value",`\n            const validate = ${e.validate};\n            return validate(value);\n          `)(s);null!=t&&!0!==t&&(r[e.name]=String(t))}catch(t){console.error(`Error executing validation for field ${e.name}:`,t),r[e.name]="Validation error"}else{const t=schema.meta._customFields||{};if(e.type&&t[e.type]&&t[e.type].validate)try{const n=t[e.type],i=new Function("value",`\n              const validate = ${n.validate};\n              return validate(value);\n            `)(s);!0!==i&&(r[e.name]=String(i))}catch(t){console.error(`Error executing custom field validation for ${e.name}:`,t),r[e.name]="Custom field validation error"}}if("array"===e.type&&null!=s){const t=y()(s)?s:[];e.min&&t.length<e.min&&(r[e.name]=`Minimum ${e.min} items required`),e.max&&t.length>e.max&&(r[e.name]=`Maximum ${e.max} items allowed`)}}else r[e.name]="This field is required"}return{isValid:0===A()(r).length,errors:r}}catch(e){return console.error("Error during validation:",e),{isValid:!0,errors:{}}}};gt.put("/firestore/document",ze,rt("write"),async(e,t)=>{console.log("Handling PUT /api/firestore/document request");try{const{collectionPath:r,documentId:s,data:n}=e.body;if(!r||!s||!n)return t.status(400).json({error:"Missing required parameters"});console.log(`Updating document: ${r}/${s}`,n);const i=await vt(r,n);if(!i.isValid)return console.log("Validation failed:",i.errors),t.status(400).json({error:"Validation failed",errors:i.errors});const o=await Jt();console.log(`Using Firestore database: ${o||"default"}`);const a=o?(0,Pe.getFirestore)(j().app(),o):(0,Pe.getFirestore)(j().app()),c=ft(n),l=ht(c,a),d=a.collection(r).doc(s);return await d.update(l),console.log(`Successfully updated document: ${r}/${s}`),t.json({id:s,success:!0})}catch(e){return console.error("Error updating document:",e),t.status(500).json({error:"Failed to update document",message:e.message})}}),gt.delete("/firestore/document",ze,rt("write"),async(e,t)=>{console.log("Handling DELETE /api/firestore/document request");try{const{collectionPath:r,documentId:s}=e.query;if(!r||!s)return t.status(400).json({error:"Missing required parameters"});console.log(`Deleting document: ${r}/${s}`);const n=await Jt();console.log(`Using Firestore database: ${n||"default"}`);const i=(n?(0,Pe.getFirestore)(j().app(),n):(0,Pe.getFirestore)(j().app())).collection(r.toString()).doc(s.toString());return await i.delete(),console.log(`Successfully deleted document: ${r}/${s}`),t.json({success:!0})}catch(e){return console.error("Error deleting document:",e),t.status(500).json({error:"Failed to delete document",message:e.message})}}),gt.get("/firestore/test-connection",ze,async(e,t)=>{console.log("Testing Firebase Admin SDK connection");try{const e=await Jt();console.log(`Using Firestore database: ${e||"default"}`);const r=(e?(0,Pe.getFirestore)(j().app(),e):(0,Pe.getFirestore)(j().app())).collection("_test_connection");return await r.limit(1).get(),console.log("Firebase Admin SDK connection test successful"),t.json({success:!0,message:"Firebase Admin SDK connection is working",projectId:j().app().options.projectId||"unknown",credentialType:j().app().options.credential?.constructor?.name||"unknown"})}catch(e){return console.error("Firebase Admin SDK connection test failed:",e),t.status(500).json({success:!1,error:"Firebase connection failed",message:e.message||"Unknown error",code:e.code||"UNKNOWN",details:"This indicates an issue with Firebase Admin SDK credentials or project configuration"})}});const Et=require("firebase-admin/storage"),yt=require("multer");var It=r.n(yt);const bt=require("stream"),_t=It()({storage:It().memoryStorage(),limits:{fileSize:52428800}}),wt=()=>{try{return(0,Et.getStorage)().bucket()}catch(e){throw console.error("Error getting storage bucket:",e),new Error("Storage not configured")}},Nt=[_t.array("files",10),async(e,t)=>{try{const{path:r=""}=e.body,s=e.files;if(!s||0===s.length)return t.status(400).json({success:!1,error:"No files provided"});const n=wt(),i=[];for(const e of s)try{const t=e.originalname,s=r?`${r}/${t}`:t;console.log(`Uploading file: ${s}`);const o=n.file(s),a=new bt.Readable;a.push(e.buffer),a.push(null),await new(Ie())((t,r)=>{const s=o.createWriteStream({metadata:{contentType:e.mimetype}});s.on("error",r),s.on("finish",t),a.pipe(s)}),i.push({name:t,path:s,success:!0})}catch(t){console.error(`Error uploading ${e.originalname}:`,t),i.push({name:e.originalname,success:!1,error:t.message})}t.json({success:!0,results:i})}catch(e){console.error("Error uploading files:",e),t.status(500).json({success:!1,error:e.message||"Failed to upload files"})}}],jt=(0,g.Router)();jt.get("/storage/list",ze,et("system:assets"),async(e,t)=>{try{const{path:r=""}=e.query,s=wt();console.log(`Listing files in path: ${r}`);const[i]=await s.getFiles({prefix:r?`${r}/`:"",delimiter:"/"}),a={prefix:r?`${r}/`:"",delimiter:"/"},[,,c]=await s.getFiles(a),l=c?.prefixes||[],d=_e()(l).call(l,e=>({name:e.replace(r?`${r}/`:"","").replace(/\/$/,""),fullPath:e.replace(/\/$/,""),isFolder:!0})),u=[];for(const e of i){const t=e.name.replace(r?`${r}/`:"","");if(!o()(t).call(t,"/"))try{const[r]=await e.getMetadata(),[s]=await e.getSignedUrl({action:"read",expires:n()()+36e5});u.push({name:t,fullPath:e.name,isFolder:!1,size:lt()(r.size||"0"),timeCreated:r.timeCreated,contentType:r.contentType,downloadURL:s})}catch(r){console.error(`Error getting metadata for ${e.name}:`,r),u.push({name:t,fullPath:e.name,isFolder:!1})}}const p=[...d,...u];t.json({success:!0,items:p})}catch(e){console.error("Error listing files:",e),t.status(500).json({success:!1,error:e.message||"Failed to list files"})}}),jt.post("/storage/upload",ze,tt("system:assets"),...Nt),jt.delete("/storage/file",ze,tt("system:assets"),async(e,t)=>{try{const{filePath:r}=e.body;if(!r)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Deleting file: ${r}`);const s=wt().file(r);await s.delete(),t.json({success:!0,message:"File deleted successfully"})}catch(e){console.error("Error deleting file:",e),t.status(500).json({success:!1,error:e.message||"Failed to delete file"})}}),jt.get("/storage/download-url",ze,et("system:assets"),async(e,t)=>{try{const{filePath:r}=e.query;if(!r)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Getting download URL for: ${r}`);const s=wt().file(r),[i]=await s.getSignedUrl({action:"read",expires:n()()+36e5});t.json({success:!0,downloadURL:i})}catch(e){console.error("Error getting download URL:",e),t.status(500).json({success:!1,error:e.message||"Failed to get download URL"})}}),jt.get("/storage/metadata",ze,et("system:assets"),async(e,t)=>{try{const{filePath:r}=e.query;if(!r)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Getting metadata for: ${r}`);const s=wt().file(r),[n]=await s.getMetadata();t.json({success:!0,metadata:{name:n.name,size:lt()(n.size||"0"),timeCreated:n.timeCreated,contentType:n.contentType,etag:n.etag}})}catch(e){console.error("Error getting file metadata:",e),t.status(500).json({success:!1,error:e.message||"Failed to get file metadata"})}}),jt.post("/storage/folder",ze,tt("system:assets"),async(e,t)=>{try{const{folderPath:r}=e.body;if(!r)return t.status(400).json({success:!1,error:"Folder path is required"});console.log(`Creating folder: ${r}`);const s=wt(),n=`${r}/.fireengine-folder`,i=s.file(n);await i.save("",{metadata:{contentType:"text/plain"}}),t.json({success:!0,message:"Folder created successfully",folderPath:r})}catch(e){console.error("Error creating folder:",e),t.status(500).json({success:!1,error:e.message||"Failed to create folder"})}}),jt.post("/storage/move",ze,tt("system:assets"),async(e,t)=>{try{const{sourcePath:r,destinationPath:s}=e.body;if(!r||!s)return t.status(400).json({success:!1,error:"Source path and destination path are required"});console.log(`Moving from: ${r} to: ${s}`);const n=wt(),i=n.file(r),[o]=await i.exists();if(o){const e=n.file(s);return await i.copy(e),await i.delete(),void t.json({success:!0,message:"File moved successfully",sourcePath:r,destinationPath:s})}const[a]=await n.getFiles({prefix:r+"/"});if(0===a.length)return t.status(404).json({success:!1,error:"Source file or folder not found"});console.log(`Moving folder with ${a.length} files`);let c=0;for(const e of a)try{const t=s+"/"+e.name.replace(r+"/",""),i=n.file(t);await e.copy(i),await e.delete(),c++}catch(t){console.error(`Error moving file ${e.name}:`,t)}t.json({success:!0,message:`Folder moved successfully (${c} files)`,sourcePath:r,destinationPath:s})}catch(e){console.error("Error moving file/folder:",e),t.status(500).json({success:!1,error:e.message||"Failed to move file/folder"})}}),jt.post("/storage/move-bulk",ze,tt("system:assets"),async(e,t)=>{try{const{moves:r}=e.body;if(!r||!y()(r)||0===r.length)return t.status(400).json({success:!1,error:"Moves array is required"});console.log(`Moving ${r.length} files`);const s=wt(),n=[];for(const e of r)try{const{sourcePath:t,destinationPath:r}=e;if(!t||!r){n.push({sourcePath:t,destinationPath:r,success:!1,error:"Source path and destination path are required"});continue}const i=s.file(t),o=s.file(r),[a]=await i.exists();if(!a){n.push({sourcePath:t,destinationPath:r,success:!1,error:"Source file not found"});continue}await i.copy(o),await i.delete(),n.push({sourcePath:t,destinationPath:r,success:!0})}catch(t){console.error(`Error moving file ${e.sourcePath}:`,t),n.push({sourcePath:e.sourcePath,destinationPath:e.destinationPath,success:!1,error:t.message||"Failed to move file"})}const i=w()(n).call(n,e=>e.success).length,o=n.length-i;t.json({success:0===o,message:0===o?`All ${i} files moved successfully`:`${i} files moved successfully, ${o} failed`,results:n})}catch(e){console.error("Error moving files:",e),t.status(500).json({success:!1,error:e.message||"Failed to move files"})}});const Ft=jt;var At=r(575);function St(e,t){var r=A()(e);if(P()){var s=P()(e);t&&(s=w()(s).call(s,function(t){return D()(e,t).enumerable})),r.push.apply(r,s)}return r}function Pt(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?b()(r=St(Object(n),!0)).call(r,function(t){G()(e,t,n[t])}):R()?M()(e,R()(n)):b()(s=St(Object(n))).call(s,function(t){L()(e,t,D()(n,t))})}return e}const Ct=(0,g.Router)();Ct.post("/billing/create-checkout",ze,async(e,t)=>{try{const{priceId:r}=e.body;if(!r)return t.status(400).json({error:"Price ID is required"});const s=await W.installationService.getInstallation(),n=`${e.protocol}://${e.get("host")}/settings/account`,i=`${At.PADDLE_CONFIG.licenseApiUrl}/checkout`,o={priceId:r,installationId:s.installationId,domain:s.domain,userEmail:e.user?.email,userDisplayName:e.user?.name||e.user?.displayName,environment:s.environment,version:s.version,returnUrl:n},a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Origin:`${e.protocol}://${e.get("host")}`},body:d()(o)});if(!a.ok){const e=await a.json();throw new Error(e.error||"Checkout worker request failed")}const c=await a.json();t.json({checkoutUrl:c.checkoutUrl,transactionId:c.transactionId,environment:c.environment,returnUrl:n})}catch(e){console.error("Checkout session creation failed:",e),t.status(500).json({error:"Failed to create checkout session",message:e instanceof Error?e.message:"Unknown error"})}}),Ct.post("/billing/checkout-success",ze,async(e,t)=>{try{const{sessionId:r,subscriptionId:s}=e.body;if(!r&&!s&&!e.body.provider)return t.status(400).json({error:"Session ID, Subscription ID, or provider is required"});const i=await W.installationService.getInstallation();let o=s;if(r&&!s)try{const t={sessionId:r,installationId:i.installationId,domain:i.domain,version:i.version},s=`${At.PADDLE_CONFIG.licenseApiUrl}/session`,n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Origin:`${e.protocol}://${e.get("host")}`},body:d()(t)});n.ok?o=(await n.json()).subscriptionId:(console.warn("Could not retrieve subscription ID from session, using session ID as fallback"),o=r)}catch(e){console.warn("Error retrieving subscription ID from session:",e),o=r}if("paddle"===e.body.provider){const{transactionId:t,customerId:r}=e.body;o=!s||"{subscription_id}"===s||"{{subscription_id}}"===s||c()(s).call(s,"pending_")?t||`paddle_temp_${n()()}`:s}const a="paddle"===e.body.provider&&(c()(o).call(o,"paddle_temp_")||c()(o).call(o,"txn_")),l={installationId:i.installationId,subscriptionId:o,plan:a?"pro":"pending",status:"active",lastValidated:new Date,features:a?{unlimitedUsers:!0,schemaOverrides:!0,customRoles:!0,advancedAuth:!0}:{},checkoutSessionId:r,provider:e.body.provider||"paddle",transactionId:e.body.transactionId,customerId:e.body.customerId};await W.installationService.updateLicenseBinding(l),t.json({success:!0,message:"Subscription activated successfully!",subscriptionId:o})}catch(e){console.error("Checkout success handling failed:",e),t.status(500).json({error:"Failed to process successful checkout",message:e instanceof Error?e.message:"Unknown error"})}}),Ct.get("/billing/subscription",ze,async(e,t)=>{try{const e=await W.installationService.getLicenseBinding(),r=await W.installationService.getInstallation();let s=e;if(e.subscriptionId)try{const t={subscriptionId:e.subscriptionId,installationId:r.installationId,domain:r.domain,version:r.version},n=await fetch(At.PADDLE_CONFIG.licenseApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(t)});if(n.ok){const t=await n.json();if(t.valid){const r=Pt(Pt({},e),{},{subscriptionId:t.subscriptionId||e.subscriptionId,plan:t.plan,status:"active",features:t.features||{},validUntil:t.validUntil?new Date(t.validUntil):null,gracePeriodEnd:t.gracePeriodEnd?new Date(t.gracePeriodEnd):null,lastValidated:new Date});t.subscriptionId&&(t.subscriptionId,e.subscriptionId),await W.installationService.updateLicenseBinding(r),s=r}else{const t=Pt(Pt({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await W.installationService.updateLicenseBinding(t),s=t}}else{const t=await n.text();console.error("Worker validation failed:",n.status,t);const r=Pt(Pt({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await W.installationService.updateLicenseBinding(r),s=r}}catch(t){console.error("Error validating license with worker:",t);const r=Pt(Pt({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await W.installationService.updateLicenseBinding(r),s=r}else s=Pt(Pt({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null});const n={subscription:s.subscriptionId?{id:s.subscriptionId,status:s.status,plan:s.plan,validUntil:s.validUntil,lastValidated:s.lastValidated}:null};t.json(n)}catch(e){console.error("Subscription status error:",e),t.status(500).json({error:"Failed to get subscription status"})}}),Ct.post("/billing/customer-portal",ze,async(e,t)=>{try{if(!e.user)return t.status(401).json({error:"Unauthorized"});const r=(await W.installationService.getLicenseBinding()).subscriptionId;if(!r)return console.error("No subscription ID in license data"),t.status(404).json({error:"No subscription ID found"});if(c()(r).call(r,"txn_"))return t.status(202).json({error:"Subscription still being created",message:"Your subscription is being set up. The billing portal will be available shortly. Please try again in a few minutes.",transactionId:r,retryAfter:300});const s={subscriptionId:r,returnUrl:`${e.protocol}://${e.get("host")}/settings/account`},n=await fetch(`${At.PADDLE_CONFIG.licenseApiUrl}/customer-portal`,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(s)});if(!n.ok){const e=await n.json().catch(()=>({message:"Failed to create portal session"}));return console.error("Worker portal session error:",e),t.status(n.status).json({error:e.message||"Failed to create customer portal session"})}const i=await n.json();t.json(i)}catch(e){console.error("Customer portal error:",e),t.status(500).json({error:"Failed to access customer portal"})}});const Dt=Ct;function Ot(e,t){var r=A()(e);if(P()){var s=P()(e);t&&(s=w()(s).call(s,function(t){return D()(e,t).enumerable})),r.push.apply(r,s)}return r}function Rt(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?b()(r=Ot(Object(n),!0)).call(r,function(t){G()(e,t,n[t])}):R()?M()(e,R()(n)):b()(s=Ot(Object(n))).call(s,function(t){L()(e,t,D()(n,t))})}return e}const Tt=(0,g.Router)();Tt.get("/license/status",ze,async(e,t)=>{try{const e=await W.installationService.getInstallation(),r=await W.installationService.getLicenseBinding(),s=await Y.validateLicense();t.json({installation:{id:e.installationId,domain:e.domain,environment:e.environment,createdAt:e.createdAt,version:e.version},license:{plan:r.plan,status:r.status,validUntil:r.validUntil,lastValidated:r.lastValidated,subscriptionId:r.subscriptionId},validation:{valid:s.valid,reason:s.reason,checkedAt:new Date}})}catch(e){console.error("License status error:",e),t.status(500).json({error:"Failed to get license status"})}}),Tt.get("/installation/info",ze,async(e,t)=>{try{const e=await W.installationService.getInstallationSummary();t.json(e)}catch(e){console.error("Installation info error:",e),t.status(500).json({error:"Failed to get installation info"})}}),Tt.get("/license/debug",ze,async(e,t)=>{try{const e=await W.installationService.getInstallation(),r=await W.installationService.getLicenseBinding(),s=await Y.validateLicense(),n=e.ownerEmail&&process.env.FIREENGINE_OWNER_EMAIL===e.ownerEmail;t.json({debug:{database:{installation:{installationId:e.installationId,ownerEmail:e.ownerEmail,domain:e.domain,environment:e.environment},license:{subscriptionId:r.subscriptionId,plan:r.plan,status:r.status,validUntil:r.validUntil,lastValidated:r.lastValidated,features:r.features}},environment:{FIREENGINE_OWNER_EMAIL:process.env.FIREENGINE_OWNER_EMAIL,NODE_ENV:"production"},computed:{isOwner:n,ownerStatus:n?"OWNER EMAIL MATCH - ADMIN PERMISSIONS ONLY":"Not owner"},validation:{valid:s.valid,plan:s.plan,reason:s.reason,features:s.features}}})}catch(e){console.error("License debug error:",e),t.status(500).json({error:"Failed to get license debug info"})}}),Tt.post("/license/transfer-from-default",ze,async(e,t)=>{try{const{getFirestore:s}=await Promise.resolve().then(r.t.bind(r,965,23)),n=await Promise.resolve().then(r.t.bind(r,675,23));await W.installationService.getInstallation(),console.log("ðŸ”„ Attempting license transfer from default to configured database");const i=n.default.firestore().collection("_fireengineMeta").doc("license"),o=await i.get();if(!o.exists)return t.json({success:!1,message:"No license document found in default database"});const a=o.data();console.log("ðŸ“‹ Found license in default database:",a),await W.installationService.updateLicenseBinding(a),!0===e.body.deleteFromDefault&&(await i.delete(),console.log("ðŸ—‘ï¸ Deleted license from default database")),t.json({success:!0,message:"License transferred successfully",licenseData:a})}catch(e){console.error("License transfer error:",e),t.status(500).json({error:"Failed to transfer license"})}}),Tt.post("/license/validate-now",ze,async(e,t)=>{try{const{installationService:e}=await Promise.resolve().then(r.bind(r,615)),{PADDLE_CONFIG:s}=await Promise.resolve().then(r.bind(r,575)),n=await e.getInstallation(),i=await e.getLicenseBinding();if(!i.subscriptionId)return t.json({error:"No subscription ID found"});const o={subscriptionId:i.subscriptionId,installationId:n.installationId,domain:n.domain,version:n.version};console.log("ðŸ” Manual validation request:",o);const a=await fetch(s.licenseApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(o)}),c=await a.json();if(console.log("âœ… Manual validation result:",c),a.ok&&c.valid){const r=Rt(Rt({},i),{},{plan:c.plan,features:c.features||i.features,validUntil:c.validUntil?new Date(c.validUntil):i.validUntil,lastValidated:new Date});return await e.updateLicenseBinding(r),t.json({success:!0,before:i,after:r,validationResult:c})}t.json({success:!1,validationResult:c,responseStatus:a.status})}catch(e){console.error("âŒ Manual validation failed:",e),t.status(500).json({error:e.message})}}),Tt.post("/license/update-plan",ze,async(e,t)=>{try{const{plan:r,features:s,validUntil:n,gracePeriodEnd:i}=e.body;if(!r)return t.status(400).json({error:"Plan is required"});const o=await W.installationService.getLicenseBinding(),a=Rt(Rt({},o),{},{plan:r,features:s||o.features,validUntil:n?new Date(n):o.validUntil,gracePeriodEnd:i?new Date(i):o.gracePeriodEnd,lastValidated:new Date});await W.installationService.updateLicenseBinding(a),t.json({success:!0,message:"License plan updated successfully",plan:a.plan})}catch(e){console.error("License plan update error:",e),t.status(500).json({error:"Failed to update license plan"})}}),Tt.post("/license/clear-cache",ze,async(e,t)=>{try{return t.status(403).json({error:"Not allowed in production"})}catch(e){console.error("Clear cache error:",e),t.status(500).json({error:"Failed to clear cache"})}});const Mt=Tt,$t=(0,v.compose)([Z,Ze,nt,mt,Ft,Dt,Mt]);var Lt=r(896);const Ut=require("zlib");var Gt=r(128),qt=r(139);const xt=require("@babel/runtime-corejs3/core-js-stable/parse-float");var kt=r.n(xt);const Vt=require("@babel/runtime-corejs3/core-js-stable/instance/ends-with");var Bt=r.n(Vt);const Kt=e=>{var t;const r=ee()(t=e.toString()).call(t).toUpperCase(),s=kt()(r);return Bt()(r).call(r,"GB")?Math.round(1024*s*1024*1024):Bt()(r).call(r,"MB")?Math.round(1024*s*1024):Bt()(r).call(r,"KB")?Math.round(1024*s):(Bt()(r).call(r,"B"),Math.round(s))},Wt=e=>{const t=(e=>{const t=[],s=[],n=(e=>{const t=[];if(!e)return t.push("Firebase Admin SDK credentials are required"),{isValid:!1,errors:t};if("object"==typeof e){var s,n;const r=["project_id","private_key","client_email"],i=w()(r).call(r,t=>!e[t]);i.length>0&&t.push(`Missing required Admin SDK fields: ${i.join(", ")}`),e.private_key&&!o()(s=e.private_key).call(s,"BEGIN PRIVATE KEY")&&t.push("Invalid private key format - should be a PEM private key"),e.client_email&&!o()(n=e.client_email).call(n,"@")&&t.push("Invalid client_email format")}else if("string"==typeof e){Bt()(e).call(e,".json")||t.push("Admin credentials file path should point to a .json file");try{const s=r(896);if(s.existsSync(e))try{const r=s.readFileSync(e,"utf8"),n=JSON.parse(r),i=["project_id","private_key","client_email"],o=w()(i).call(i,e=>!n[e]);o.length>0&&t.push(`Admin credentials file is missing required fields: ${o.join(", ")}`)}catch(e){t.push("Admin credentials file contains invalid JSON")}else t.push(`Admin credentials file does not exist: ${e}`)}catch(e){t.push("Unable to verify admin credentials file existence")}}else t.push("Admin credentials should be an object or file path string");return{isValid:0===t.length,errors:t}})(e.adminCredentials),i=n.isValid;i||(t.push(...n.errors),s.push("Firebase Admin SDK credentials"));const a=(e=>{var t,r;const s=[];if(!e)return s.push("Firebase Web App configuration is required"),{isValid:!1,errors:s};if("object"!=typeof e)return s.push("Web app config should be an object"),{isValid:!1,errors:s};const n=["apiKey","authDomain","projectId"],i=w()(n).call(n,t=>!e[t]);return i.length>0&&s.push(`Missing required Web App config fields: ${i.join(", ")}`),e.apiKey&&(!c()(t=e.apiKey).call(t,"AIza")||e.apiKey.length<30)&&s.push("Invalid API key format"),e.authDomain&&!o()(r=e.authDomain).call(r,".")&&s.push("Invalid auth domain format"),e.projectId&&e.projectId.length<3&&s.push("Invalid project ID format"),{isValid:0===s.length,errors:s}})(e.webappConfig),l=a.isValid;l||(t.push(...a.errors),s.push("Firebase Web App configuration"));const d=(e=>{const t=[];return e?(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)||t.push("Invalid owner email format"),{isValid:0===t.length,errors:t}):(t.push("Owner email is required for initial admin access"),{isValid:!1,errors:t})})(e.ownerEmail||""),u=d.isValid;return u||(t.push(...d.errors),s.push("Owner email address")),{isValid:i&&l&&u,missingItems:s,configStatus:{adminCredentials:i,webappConfig:l,ownerEmail:u},errors:t}})(e);return{isConfigured:t.isValid,configStatus:t.configStatus,missingItems:t.missingItems,errors:t.errors,canProceed:t.configStatus.adminCredentials&&t.configStatus.webappConfig}};let Ht,zt=!1;const Jt=async()=>{if(Ht)return Ht;if(!zt){zt=!0;try{const e=await(async()=>{try{return}catch(e){return}})();return Ht=e,e}catch(e){return}}return Ht},Yt=(e={})=>{const t=m()(),s=(0,Gt._m)(e);(0,Gt.Jk)();const i=Wt(s);if(!i.isConfigured||j().apps.length&&!s.adminCredentials)i.isConfigured||(console.log("âš ï¸  Firebase Admin SDK not initialized - incomplete configuration detected"),console.log("ðŸ“‹ Missing items:",i.missingItems.join(", ")),console.log("ðŸš€ Onboarding page will be shown to configure the system"));else try{let e;e="string"==typeof s.adminCredentials?r(107)(s.adminCredentials):s.adminCredentials;const t={credential:e?j().credential.cert(e):j().credential.applicationDefault(),projectId:s.webappConfig?.projectId,storageBucket:s.webappConfig?.storageBucket};j().initializeApp(t),(0,qt._A)(s.firestoreDatabase),console.log("âœ… Firebase Admin SDK initialized successfully")}catch(e){console.error("âŒ Error initializing Firebase Admin SDK:",e),console.log("ðŸ“‹ Configuration validation will handle incomplete setup")}Ht=s.firestoreDatabase;const a=(e=>{const t=5368709120,r=t;if(void 0!==e){const r="string"==typeof e?Kt(e):e;if(r>0&&r<=t)return r;if(r>t)return t}const s=process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE;if(s)try{const e=Kt(s);if(e>0&&e<=t)return e;if(e>t)return t}catch(e){}const n=(()=>{const e=process.env.NODE_OPTIONS;if(!e)return;const t=e.match(/--max-old-space-size[=\s](\d+)/);return t&&t[1]?lt()(t[1],10):void 0})();if(n&&n>0){const e=Math.round(1024*n*1024*.8);if(e<t)return e}return r})(s.storageMaxUploadSize);var l,u;return(e=>{x=function(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?b()(r=q(Object(n),!0)).call(r,function(t){G()(e,t,n[t])}):R()?M()(e,R()(n)):b()(s=q(Object(n))).call(s,function(t){L()(e,t,D()(n,t))})}return e}({},e)})({ownerEmail:s.ownerEmail,useFirestoreAccessRules:!0===s.useFirestoreAccessRules,webappConfig:s.webappConfig,storageMaxUploadSizeBytes:a}),W.installationService.setConfig(s),s.schemaOverrides&&(l=s.schemaOverrides,Re=l||{}),s.customFields&&(e=>{var t;const r=e?de()(t=re()(e)).call(t,(e,[t,r])=>(e[t]=De(De({},r),{},{name:r.name||t,render:"function"==typeof r.render?r.render.toString():r.render,renderInput:"function"==typeof r.renderInput?r.renderInput.toString():r.renderInput,renderOutput:"function"==typeof r.renderOutput?r.renderOutput.toString():r.renderOutput,validate:r.validate&&"function"==typeof r.validate?r.validate.toString():r.validate}),e),{}):{};Me=r})(s.customFields),s.ignoreCollections&&(u=s.ignoreCollections,$e=u||[]),t.use(m().json()),t.use(m().urlencoded({extended:!0})),t.use("/api",$t),t.get("/admin.js*",(e,t)=>{const r=p().join(__dirname,"admin/index.js");try{var s;const n=(0,Lt.statSync)(r),i=`"${n.size}-${n.mtime.getTime()}"`;if(e.headers["if-none-match"]===i)return t.status(304).end();if(e.headers["accept-encoding"]&&o()(s=e.headers["accept-encoding"]).call(s,"gzip")){t.set({"Content-Type":"application/javascript","Content-Encoding":"gzip","Cache-Control":"public, max-age=31536000, immutable",ETag:i,Vary:"Accept-Encoding"});const e=(0,Lt.createReadStream)(r),s=(0,Ut.createGzip)({level:6});e.pipe(s).pipe(t)}else t.set({"Content-Type":"application/javascript","Cache-Control":"public, max-age=31536000, immutable",ETag:i}),t.sendFile(r)}catch(e){console.error("Error serving admin.js:",e),t.status(500).send("Error loading admin script")}}),t.get("/locales/*.json",(e,t)=>{t.sendFile(p().join(__dirname,`locales/${e.originalUrl.split("/").pop()}`))}),t.get("*",async(e,t,r)=>{var i;if(c()(i=e.path).call(i,"/api/"))return r();const o=Wt(s),l=(()=>{try{const e=p().resolve(__dirname,"build-timestamp.json");if((0,Lt.existsSync)(e)){const t=(0,Lt.readFileSync)(e,"utf8"),{timestamp:r}=JSON.parse(t);return r.toString()}}catch(e){console.warn("Could not read build timestamp:",e.message)}return n()().toString()})(),u={webappConfig:s.webappConfig,basePath:e.baseUrl||"",googleMapsApiKey:s.googleMapsApiKey||"",googleMapsOptions:s.googleMapsOptions||{},ignoreCollections:s.ignoreCollections||[],useFirestoreAccessRules:!0===s.useFirestoreAccessRules,ownerEmail:s.ownerEmail||null,storageMaxUploadSizeBytes:a,isConfigured:o.isConfigured,configStatus:o.configStatus,missingItems:o.missingItems,configErrors:o.errors},g=h().replace("{fireenging-base-path}",e.baseUrl).replace('src="admin.js"',`src="admin.js?v=${l}"`).replace("{fireengine-config}",d()(u));t.send(g)}),t}},615:(e,t,r)=>{"use strict";r.d(t,{installationService:()=>U});var s=r(497),n=r.n(s),i=r(86),o=r.n(i),a=r(405),c=r.n(a),l=r(335),d=r.n(l),u=r(718),p=r.n(u),g=r(691),m=r.n(g),f=r(471),h=r.n(f),v=r(668),E=r.n(v),y=r(16),I=r.n(y),b=r(464),_=r.n(b),w=r(41),N=r.n(w),j=r(316),F=r.n(j),A=r(875),S=r.n(A);const P=require("uuid"),C=require("os"),D=require("crypto");var O=r(139);var R=r(128);function T(e,t){var r=I()(e);if(n()){var s=n()(e);t&&(s=o()(s).call(s,function(t){return c()(e,t).enumerable})),r.push.apply(r,s)}return r}function M(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?d()(r=T(Object(n),!0)).call(r,function(t){E()(e,t,n[t])}):p()?m()(e,p()(n)):d()(s=T(Object(n))).call(s,function(t){h()(e,t,c()(n,t))})}return e}class ${constructor(){E()(this,"installationCache",null),E()(this,"licenseCache",null),E()(this,"config",null)}getDb(){return(0,O.xL)()}setConfig(e){this.config=(0,R._m)(e||{})}async getInstallation(){if(this.installationCache)return this.installationCache;const e=this.getDb().collection("_fireengineMeta").doc("installation"),t=await e.get();if(t.exists){const e=M(M({},t.data()),{},{createdAt:t.data().createdAt.toDate()});return this.installationCache=e,e}const r=await this.createInstallation();return this.installationCache=r,r}async createInstallation(){const e=(0,P.v4)(),t=this.generateServerFingerprint(),r=this.detectDomain(),s=this.detectEnvironment(r),n={installationId:e,domain:r,createdAt:new Date,serverFingerprint:t,ownerEmail:this.config?.ownerEmail||"",version:"1.0.4",environment:s},i=this.getDb().collection("_fireengineMeta").doc("installation");return await i.set(n),n}generateServerFingerprint(){const e={hostname:C.hostname(),platform:C.platform(),arch:C.arch(),networkInterfaces:I()(C.networkInterfaces()),cpus:C.cpus().length};return D.createHash("sha256").update(_()(e)).digest("hex").substring(0,16)}detectDomain(){return process.env.FIREENGINE_DOMAIN||C.hostname()}detectEnvironment(e){return N()(e).call(e,"localhost")||N()(e).call(e,"127.0.0.1")?"development":N()(e).call(e,"staging")||N()(e).call(e,"dev")||N()(e).call(e,"test")?"staging":"production"}async getLicenseBinding(){if(this.licenseCache)return this.licenseCache;const e=this.getDb().collection("_fireengineMeta").doc("license"),t=await e.get();if(t.exists){const e=M(M({},t.data()),{},{lastValidated:t.data().lastValidated.toDate(),validUntil:t.data().validUntil?.toDate(),gracePeriodEnd:t.data().gracePeriodEnd?.toDate()});return this.licenseCache=e,e}const r={installationId:(await this.getInstallation()).installationId,plan:"free",status:"active",lastValidated:new Date,features:{advancedAuth:!1,customRoles:!1,schemaOverrides:!1,apiAccess:!1,unlimitedUsers:!1,unlimitedStorage:!1}};return await this.updateLicenseBinding(r),r}async updateLicenseBinding(e){const t={};for(const[r,s]of F()(e))void 0!==s&&(t[r]=s);const r=this.getDb().collection("_fireengineMeta").doc("license");await r.set(t),this.licenseCache=e}async canTransferInstallation(){const e=await this.getInstallation(),t=await this.getLicenseBinding();return S()()-e.createdAt.getTime()<864e5||"inactive"===t.status}async validateInstallation(){try{const e=await this.getInstallation(),t=this.generateServerFingerprint();return e.serverFingerprint!==t&&console.warn("âš ï¸  Server fingerprint changed - this might indicate installation transfer"),{valid:!0}}catch(e){return console.error("Installation validation failed:",e),{valid:!1,reason:"validation_error"}}}async getInstallationSummary(){const e=await this.getInstallation(),t=await this.getLicenseBinding();return{installationId:e.installationId,domain:e.domain,environment:e.environment,createdAt:e.createdAt,version:e.version,plan:t.plan,status:t.status,lastValidated:t.lastValidated,validUntil:t.validUntil}}clearCache(){this.installationCache=null,this.licenseCache=null}}let L=null;const U={setConfig:e=>{L||(L=new $),L.setConfig(e)},getInstallation:async()=>(L||(L=new $),L.getInstallation()),getLicenseBinding:async()=>(L||(L=new $),L.getLicenseBinding()),updateLicenseBinding:async e=>(L||(L=new $),L.updateLicenseBinding(e)),canTransferInstallation:async()=>(L||(L=new $),L.canTransferInstallation()),validateInstallation:async()=>(L||(L=new $),L.validateInstallation()),getInstallationSummary:async()=>(L||(L=new $),L.getInstallationSummary()),clearCache:()=>(L||(L=new $),L.clearCache())}},668:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/helpers/defineProperty")},675:e=>{"use strict";e.exports=require("firebase-admin")},691:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/define-properties")},718:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors")},875:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/date/now")},896:e=>{"use strict";e.exports=require("fs")},965:e=>{"use strict";e.exports=require("firebase-admin/firestore")},982:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/map")}},s={};function n(e){var t=s[e];if(void 0!==t)return t.exports;var i=s[e]={exports:{}};return r[e](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(r,s){if(1&s&&(r=this(r)),8&s)return r;if("object"==typeof r&&r){if(4&s&&r.__esModule)return r;if(16&s&&"function"==typeof r.then)return r}var i=Object.create(null);n.r(i);var o={};e=e||[null,t({}),t([]),t(t)];for(var a=2&s&&r;("object"==typeof a||"function"==typeof a)&&!~e.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach(e=>o[e]=()=>r[e]);return o.default=()=>r,n.d(i,o),i},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i=n(599);module.exports=i.default})();