(()=>{var e,t,r={16:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/keys")},41:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/includes")},86:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/filter")},128:(e,t,r)=>{"use strict";r.d(t,{Jk:()=>R,_m:()=>C});var s=r(668),n=r.n(s),i=r(16),a=r.n(i),o=r(240),c=r.n(o),l=r(86),d=r.n(l),u=r(982),p=r.n(u),f=r(497),m=r.n(f),g=r(405),h=r.n(g),E=r(335),v=r.n(E),I=r(718),y=r.n(I),_=r(691),b=r.n(_),N=r(471),w=r.n(N);function F(e,t){var r=a()(e);if(m()){var s=m()(e);t&&(s=d()(s).call(s,function(t){return h()(e,t).enumerable})),r.push.apply(r,s)}return r}function A(e){for(var t=1;t<arguments.length;t++){var r,s,i=null!=arguments[t]?arguments[t]:{};t%2?v()(r=F(Object(i),!0)).call(r,function(t){n()(e,t,i[t])}):y()?b()(e,y()(i)):v()(s=F(Object(i))).call(s,function(t){w()(e,t,h()(i,t))})}return e}const j=(e,t)=>process.env[`FIREENGINE_${e}`]||(t?process.env[t]:void 0),P=e=>{if(e)try{return JSON.parse(e)}catch(e){return void console.error("Error parsing JSON environment variable:",e)}},S=()=>{const e={},t=(()=>{const e={};process.env.FIREENGINE_ADMIN_TYPE&&(e.type=process.env.FIREENGINE_ADMIN_TYPE);const t=j("FIREBASE_PROJECT_ID","FIREBASE_PROJECT_ID");t&&(e.project_id=t),process.env.FIREENGINE_ADMIN_PRIVATE_KEY_ID&&(e.private_key_id=process.env.FIREENGINE_ADMIN_PRIVATE_KEY_ID);const r=j("ADMIN_PRIVATE_KEY")||j("FIREBASE_PRIVATE_KEY","FIREBASE_PRIVATE_KEY");r&&(e.private_key=r.replace(/\\n/g,"\n"));const s=j("ADMIN_CLIENT_EMAIL")||j("FIREBASE_CLIENT_EMAIL","FIREBASE_CLIENT_EMAIL");if(s&&(e.client_email=s),process.env.FIREENGINE_ADMIN_CLIENT_ID&&(e.client_id=process.env.FIREENGINE_ADMIN_CLIENT_ID),process.env.FIREENGINE_ADMIN_AUTH_URI&&(e.auth_uri=process.env.FIREENGINE_ADMIN_AUTH_URI),process.env.FIREENGINE_ADMIN_TOKEN_URI&&(e.token_uri=process.env.FIREENGINE_ADMIN_TOKEN_URI),process.env.FIREENGINE_ADMIN_AUTH_PROVIDER_X509_CERT_URL&&(e.auth_provider_x509_cert_url=process.env.FIREENGINE_ADMIN_AUTH_PROVIDER_X509_CERT_URL),process.env.FIREENGINE_ADMIN_CLIENT_X509_CERT_URL&&(e.client_x509_cert_url=process.env.FIREENGINE_ADMIN_CLIENT_X509_CERT_URL),process.env.FIREENGINE_ADMIN_UNIVERSE_DOMAIN&&(e.universe_domain=process.env.FIREENGINE_ADMIN_UNIVERSE_DOMAIN),process.env.FIREENGINE_ADMIN_CREDENTIALS_JSON)try{return JSON.parse(process.env.FIREENGINE_ADMIN_CREDENTIALS_JSON)}catch(e){console.error("Error parsing FIREENGINE_ADMIN_CREDENTIALS_JSON:",e)}return process.env.FIREENGINE_ADMIN_CREDENTIALS_FILE?process.env.FIREENGINE_ADMIN_CREDENTIALS_FILE:a()(e).length>0?e:void 0})();t&&(e.adminCredentials=t);const r=(()=>{const e={};process.env.FIREENGINE_WEBAPP_API_KEY&&(e.apiKey=process.env.FIREENGINE_WEBAPP_API_KEY),process.env.FIREENGINE_WEBAPP_AUTH_DOMAIN&&(e.authDomain=process.env.FIREENGINE_WEBAPP_AUTH_DOMAIN);const t=j("FIREBASE_PROJECT_ID","FIREBASE_PROJECT_ID");if(t&&(e.projectId=t),process.env.FIREENGINE_WEBAPP_STORAGE_BUCKET&&(e.storageBucket=process.env.FIREENGINE_WEBAPP_STORAGE_BUCKET),process.env.FIREENGINE_WEBAPP_MESSAGING_SENDER_ID&&(e.messagingSenderId=process.env.FIREENGINE_WEBAPP_MESSAGING_SENDER_ID),process.env.FIREENGINE_WEBAPP_APP_ID&&(e.appId=process.env.FIREENGINE_WEBAPP_APP_ID),process.env.FIREENGINE_WEBAPP_MEASUREMENT_ID&&(e.measurementId=process.env.FIREENGINE_WEBAPP_MEASUREMENT_ID),process.env.FIREENGINE_WEBAPP_CONFIG_JSON)try{return JSON.parse(process.env.FIREENGINE_WEBAPP_CONFIG_JSON)}catch(e){console.error("Error parsing FIREENGINE_WEBAPP_CONFIG_JSON:",e)}return process.env.FIREENGINE_WEBAPP_CONFIG_FILE?process.env.FIREENGINE_WEBAPP_CONFIG_FILE:a()(e).length>0?e:void 0})();r&&(e.webappConfig=r);const s=j("FIRESTORE_DATABASE")||j("FIRESTORE_DATABASE_ID","FIRESTORE_DATABASE_ID");s&&(e.firestoreDatabase=s),process.env.FIREENGINE_OWNER_EMAIL&&(e.ownerEmail=process.env.FIREENGINE_OWNER_EMAIL);const n=(e=>{var t;if(!e)return;const r=c()(t=e.toLowerCase()).call(t);return"true"===r||"1"===r||"yes"===r||"false"!==r&&"0"!==r&&"no"!==r&&void 0})(process.env.FIREENGINE_USE_FIRESTORE_ACCESS_RULES);void 0!==n&&(e.useFirestoreAccessRules=n),process.env.FIREENGINE_GOOGLE_MAPS_API_KEY&&(e.googleMapsApiKey=process.env.FIREENGINE_GOOGLE_MAPS_API_KEY);const i=P(process.env.FIREENGINE_GOOGLE_MAPS_OPTIONS);i&&(e.googleMapsOptions=i);const o=(e=>{var t,r;if(e)return d()(t=p()(r=e.split(",")).call(r,e=>c()(e).call(e))).call(t,e=>e.length>0)})(process.env.FIREENGINE_IGNORE_COLLECTIONS);o&&(e.ignoreCollections=o);const l=P(process.env.FIREENGINE_SCHEMA_OVERRIDES);l&&(e.schemaOverrides=l);const u=P(process.env.FIREENGINE_SIGNIN_METHODS);return u&&(e.signinMethods=u),process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE&&(e.storageMaxUploadSize=process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE),e},C=e=>{const t=S(),r=A({},e);return t.adminCredentials&&(r.adminCredentials=t.adminCredentials),t.webappConfig&&(r.webappConfig=A(A({},e.webappConfig),t.webappConfig)),void 0!==t.firestoreDatabase&&(r.firestoreDatabase=t.firestoreDatabase),void 0!==t.ownerEmail&&(r.ownerEmail=t.ownerEmail),void 0!==t.useFirestoreAccessRules&&(r.useFirestoreAccessRules=t.useFirestoreAccessRules),void 0!==t.googleMapsApiKey&&(r.googleMapsApiKey=t.googleMapsApiKey),void 0!==t.googleMapsOptions&&(r.googleMapsOptions=A(A({},e.googleMapsOptions),t.googleMapsOptions)),void 0!==t.ignoreCollections&&(r.ignoreCollections=t.ignoreCollections),void 0!==t.schemaOverrides&&(r.schemaOverrides=A(A({},e.schemaOverrides),t.schemaOverrides)),void 0!==t.signinMethods&&(r.signinMethods=t.signinMethods),void 0!==t.storageMaxUploadSize&&(r.storageMaxUploadSize=t.storageMaxUploadSize),r},R=()=>{const e=S();a()(e)}},139:(e,t,r)=>{"use strict";r.d(t,{_A:()=>c,xL:()=>l});var s=r(965),n=r(675),i=r.n(n);let a,o=null;const c=e=>(a=e,o=null,!0),l=()=>{if(!o){if(!i().apps.length)throw new Error("Firebase Admin SDK not initialized. This usually means fireengine() hasn't been called yet or Firebase credentials are missing. Make sure you call fireengine(config) with proper adminCredentials before using any Firebase services.");o=a?(0,s.getFirestore)(i().app(),a):(0,s.getFirestore)(i().app())}return o}},240:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/trim")},253:e=>{"use strict";e.exports=require("firebase/app")},301:(e,t,r)=>{"use strict";r.d(t,{default:()=>Yt,getFirestoreDatabaseName:()=>zt});var s=r(875),n=r.n(s),i=r(41),a=r.n(i);const o=require("@babel/runtime-corejs3/core-js-stable/instance/starts-with");var c=r.n(o),l=r(464),d=r.n(l),u=r(928),p=r.n(u);const f=require("express");var m=r.n(f),g=r(323),h=r.n(g);const E=require("compose-middleware"),v=require("@babel/runtime-corejs3/core-js-stable/array/is-array");var I=r.n(v),y=r(335),_=r.n(y),b=r(86),N=r.n(b),w=r(675),F=r.n(w),A=r(16),j=r.n(A),P=r(497),S=r.n(P),C=r(405),R=r.n(C),D=r(718),O=r.n(D),T=r(691),M=r.n(T),L=r(471),G=r.n(L),U=r(668),q=r.n(U);function $(e,t){var r=j()(e);if(S()){var s=S()(e);t&&(s=N()(s).call(s,function(t){return R()(e,t).enumerable})),r.push.apply(r,s)}return r}let B={useFirestoreAccessRules:!1};const k=()=>B,x=()=>process.env.FIREENGINE_OWNER_EMAIL||B.ownerEmail,V=require("@babel/runtime-corejs3/core-js-stable/map");var W=r.n(V),K=r(615);let J=function(e){return e.FREE="free",e.PRO="pro",e}({});J.FREE,J.PRO;class H{constructor(){q()(this,"validationCache",new(W())),q()(this,"CACHE_TTL",36e5)}async validateLicense(){try{const e=await K.installationService.getInstallation(),t=await K.installationService.getLicenseBinding(),r=this.validationCache.get(e.installationId);if(r&&n()()-r.timestamp<this.CACHE_TTL)return r.result;const s=this.validateLocalLicense(t);return this.cacheResult(e.installationId,s),s}catch(e){return console.error("License validation failed:",e),this.fallbackValidation()}}validateLocalLicense(e){return e.validUntil&&new Date>e.validUntil?{valid:!1,reason:"license_expired",plan:J.FREE,features:this.getFreePlanFeatures()}:e.gracePeriodEnd&&this.isInGracePeriod(e.gracePeriodEnd)?{valid:!0,plan:this.mapPlanString(e.plan),features:e.features||this.getFreePlanFeatures(),gracePeriodEnd:e.gracePeriodEnd,reason:"grace_period"}:{valid:"active"===e.status,plan:this.mapPlanString(e.plan),features:e.features||this.getFreePlanFeatures(),validUntil:e.validUntil}}isInGracePeriod(e){return!!e&&new Date<e}fallbackValidation(){return{valid:!0,plan:J.FREE,features:this.getFreePlanFeatures(),reason:"fallback_mode"}}cacheResult(e,t){this.validationCache.set(e,{result:t,timestamp:n()()})}getFreePlanFeatures(){return{advancedAuth:!1,customRoles:!1,schemaOverrides:!1,apiAccess:!1,unlimitedUsers:!1,unlimitedStorage:!1,analytics:!1,auditLogs:!1,prioritySupport:!1,customBranding:!1,whiteLabel:!1}}getProPlanFeatures(){return{advancedAuth:!0,customRoles:!0,schemaOverrides:!0,apiAccess:!0,unlimitedUsers:!0,unlimitedStorage:!0,analytics:!0,auditLogs:!0,prioritySupport:!0,customBranding:!0,whiteLabel:!0}}mapPlanString(e){return"pro"===e.toLowerCase()?J.PRO:J.FREE}clearCache(){this.validationCache.clear()}}let z=null;const Y={validateLicense:async()=>(z||(z=new H),z.validateLicense()),clearCache(){z&&z.clearCache()}},X=(0,f.Router)({strict:!0}),Z=X;X.get("/auth/auth-providers",async(e,t)=>{try{const e=F().auth(),c={providers:{saml:[],oidc:[]},tenants:[],availableProviders:[],detectedSigninMethods:[]};if("function"==typeof e.listProviderConfigs)try{const t=await e.listProviderConfigs({type:"saml"});t&&I()(t.providerConfigs)&&(c.providers.saml=t.providerConfigs);const r=await e.listProviderConfigs({type:"oidc"});r&&I()(r.providerConfigs)&&(c.providers.oidc=r.providerConfigs)}catch(e){console.error("Error fetching provider configs:",e)}const l=[];try{"function"==typeof e.createUser&&(l.push({type:"SIGNIN_METHOD_EMAIL",signInWithEmailLink:!1,title:"Email & Password"}),l.push({type:"SIGNIN_METHOD_EMAIL",signInWithEmailLink:!0,title:"Email Link (Passwordless)"}))}catch(e){console.log("Email authentication detection failed:",e.message)}try{const e=process.env.FIREENGINE_WEBAPP_CONFIG?JSON.parse(process.env.FIREENGINE_WEBAPP_CONFIG):null;e?.authDomain&&l.push({type:"SIGNIN_METHOD_GOOGLE",title:"Google"})}catch(e){console.log("Google provider detection failed:",e.message)}var r,s;c.providers.saml.length>0&&_()(r=c.providers.saml).call(r,e=>{l.push({type:"SIGNIN_METHOD_SAML",providerId:e.providerId,title:e.displayName||e.providerId})}),c.providers.oidc.length>0&&_()(s=c.providers.oidc).call(s,e=>{l.push({type:"SIGNIN_METHOD_OIDC",providerId:e.providerId,title:e.displayName||e.providerId})}),c.detectedSigninMethods=l;try{var n;const t=[];if("function"==typeof e.createUser&&t.push("password"),"function"==typeof e.listProviderConfigs)try{const r=await e.listProviderConfigs({type:"saml"}),s=await e.listProviderConfigs({type:"oidc"});var i,o;r&&I()(r.providerConfigs)&&_()(i=r.providerConfigs).call(i,e=>{e.providerId&&t.push(e.providerId)}),s&&I()(s.providerConfigs)&&_()(o=s.providerConfigs).call(o,e=>{e.providerId&&t.push(e.providerId)})}catch(e){console.log("Error getting SAML/OIDC providers, using defaults:",e.message)}_()(n=["google.com","facebook.com","twitter.com","github.com","microsoft.com","apple.com"]).call(n,e=>{a()(t).call(t,e)||t.push(e)}),c.availableProviders=t}catch(e){console.error("Error getting available providers:",e)}try{if("function"==typeof e.tenantManager){const t=e.tenantManager();if(t&&"function"==typeof t.listTenants){const e=await t.listTenants();e&&I()(e.tenants)&&(c.tenants=e.tenants)}}}catch(e){console.log("Tenant manager not available:",e.message)}return t.json(c)}catch(e){return console.error("Error fetching auth providers:",e),t.status(500).json({error:"Failed to fetch auth providers",message:e.message})}}),X.get("/auth/detected-signin-methods",async(e,t)=>{try{if(!F().apps||0===F().apps.length)return t.status(503).json({error:"Firebase Admin SDK not initialized",message:"Please configure Firebase Admin credentials"});const e=F().auth(),a=[],o=B.webappConfig;try{if("function"==typeof e.listProviderConfigs){const t=await e.listProviderConfigs({type:"saml"});var s;t?.providerConfigs&&t.providerConfigs.length>0&&_()(s=t.providerConfigs).call(s,e=>{a.push({type:"SIGNIN_METHOD_SAML",providerId:e.providerId,title:e.displayName||e.providerId,enabled:e.enabled,metadata:{issuer:e.idpConfig?.idpEntityId,ssoUrl:e.idpConfig?.ssoUrl,certificates:e.idpConfig?.idpCertificates,requestUri:e.spConfig?.callbackUri}})});const r=await e.listProviderConfigs({type:"oidc"});var i;r?.providerConfigs&&r.providerConfigs.length>0&&_()(i=r.providerConfigs).call(i,e=>{a.push({type:"SIGNIN_METHOD_OIDC",providerId:e.providerId,title:e.displayName||e.providerId,enabled:e.enabled,metadata:{issuer:e.issuer,clientId:e.clientId,responseType:e.responseType,scopes:["openid","email","profile"],redirectUri:`https://${o?.authDomain}/__/auth/handler`}})})}}catch(e){}try{if("function"==typeof e.createUser&&o?.authDomain){let e=!1,t=!1;try{const{initializeApp:s,getApps:i}=await Promise.resolve().then(r.t.bind(r,253,23)),{getAuth:a,createUserWithEmailAndPassword:c,sendSignInLinkToEmail:l,deleteUser:d}=await Promise.resolve().then(r.t.bind(r,304,23));let u;i();const p=`test-auth-detection-${n()()}`;try{u=s(o,p);const r=a(u),i=`test-auth-${n()()}@fireengine-test.invalid`,f="TestPassword123!";try{const t=await c(r,i,f);if(e=!0,t.user)try{await d(t.user)}catch(e){}}catch(t){"auth/operation-not-allowed"===t.code&&(e=!1)}try{await l(r,i,{url:`https://${o.authDomain}`,handleCodeInApp:!0}),t=!0}catch(e){"auth/operation-not-allowed"===e.code&&(t=!1)}}finally{if(u)try{await u.delete()}catch(e){}}}catch(r){e=!1,t=!1}e&&t?a.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!0,supportsEmailLink:!0,title:"Email Authentication"}):e?a.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!0,supportsEmailLink:!1,signInWithEmailLink:!1,title:"Email & Password"}):t&&a.push({type:"SIGNIN_METHOD_EMAIL",supportsPassword:!1,supportsEmailLink:!0,signInWithEmailLink:!0,title:"Email Link (Passwordless)"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!0}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_PHONE",title:"Phone"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{const{initializeApp:t}=await Promise.resolve().then(r.t.bind(r,253,23)),{getAuth:s,GoogleAuthProvider:i,signInWithCredential:a,GoogleAuthProvider:c}=await Promise.resolve().then(r.t.bind(r,304,23));let l;const d=`test-google-detection-${n()()}`;try{l=t(o,d);const r=s(l);new i;try{const t=i.credential("fake_id_token","fake_access_token");await a(r,t),e=!1}catch(t){e="auth/operation-not-allowed"!==t.code&&("auth/invalid-credential"===t.code||"auth/argument-error"===t.code||"auth/invalid-id-token"===t.code)}}finally{if(l)try{await l.delete()}catch(e){}}}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_GOOGLE",title:"Google"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_MICROSOFT",title:"Microsoft"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_APPLE",title:"Apple"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_GITHUB",title:"GitHub"})}}catch(e){}try{let e=!1;if(o?.authDomain&&o?.apiKey){try{e=!1}catch(t){e=!1}e&&a.push({type:"SIGNIN_METHOD_FACEBOOK",title:"Facebook"})}}catch(e){}let c=a;try{const e=await Y.validateLicense();await K.installationService.getLicenseBinding(),e.valid&&e.features?.advancedAuth||(c=N()(a).call(a,e=>"SIGNIN_METHOD_EMAIL"===e.type))}catch(e){c=N()(a).call(a,e=>"SIGNIN_METHOD_EMAIL"===e.type)}return t.json({detectedMethods:c,detectedAt:(new Date).toISOString()})}catch(e){return console.error("Error detecting signin methods:",e),t.status(500).json({error:"Failed to detect signin methods",message:e.message})}});var Q=r(240),ee=r.n(Q),te=r(316),re=r.n(te);const se=require("@babel/runtime-corejs3/core-js-stable/instance/some");var ne=r.n(se);const ie=require("@babel/runtime-corejs3/core-js-stable/object/values");var ae=r.n(ie);const oe=require("@babel/runtime-corejs3/core-js-stable/instance/bind");var ce=r.n(oe);const le=require("@babel/runtime-corejs3/core-js-stable/instance/reduce");var de=r.n(le);const ue=require("@babel/runtime-corejs3/core-js-stable/instance/slice");var pe=r.n(ue);const fe=require("@babel/runtime-corejs3/core-js-stable/instance/find-index");var me=r.n(fe);const ge=require("@babel/runtime-corejs3/core-js-stable/instance/find");var he=r.n(ge);const Ee=require("@babel/runtime-corejs3/core-js-stable/set");var ve=r.n(Ee);const Ie=require("@babel/runtime-corejs3/core-js-stable/promise");var ye=r.n(Ie),_e=r(982),be=r.n(_e);const Ne=require("@babel/runtime-corejs3/core-js-stable/instance/sort");var we=r.n(Ne);const Fe=require("@babel/runtime-corejs3/core-js-stable/instance/index-of");var Ae=r.n(Fe);const je=require("@babel/runtime-corejs3/core-js-stable/instance/values");var Pe=r.n(je),Se=r(965);function Ce(e,t){var r=j()(e);if(S()){var s=S()(e);t&&(s=N()(s).call(s,function(t){return R()(e,t).enumerable})),r.push.apply(r,s)}return r}function Re(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?_()(r=Ce(Object(n),!0)).call(r,function(t){q()(e,t,n[t])}):O()?M()(e,O()(n)):_()(s=Ce(Object(n))).call(s,function(t){G()(e,t,R()(n,t))})}return e}let De=null,Oe={},Te={},Me={},Le=[];const Ge=e=>{var t;if(!e||!e.type)return e;const r={array:["validTypes","min","max"],string:["min","max","options"],number:["min","max"],assets:["min","max"],reference:["referencePath"],dropdown:["options"],editor:["min","max"],map:["fields"]},s=["name","type","title","required","width","default","validate",...r[e.type]||[]],n={};return _()(s).call(s,t=>{void 0!==e[t]&&(n[t]=e[t])}),_()(t=j()(e)).call(t,t=>{var i;a()(s).call(s,t)||n[t]||(ne()(i=ae()(r)).call(i,s=>{var n,i;return a()(s).call(s,t)&&!(null==(n=r[e.type])?void 0:ce()(i=Function.call).call(i,a()(n),n))?.(t)})||(n[t]=e[t]))}),n},Ue=()=>{De=null},qe=e=>{if("_customFields"===e||"_fireengineMeta"===e)return!0;if(0===Le.length)return!1;if(a()(Le).call(Le,e))return!0;const t=e.split("/");if(t.length>1)for(let e=1;e<t.length;e+=2){const r=pe()(t).call(t,0,e).join("/");if(a()(Le).call(Le,r))return!0}return!1},$e=async(e=!1)=>{const t=await(async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(r.bind(r,301)),t=await e(),{getFirestore:s}=await Promise.resolve().then(r.t.bind(r,965,23)),n=await Promise.resolve().then(r.t.bind(r,675,23)),i=t?s(n.default.app(),t):s(n.default.app()),a=await i.collection("_fireengineMeta").doc("schemaOverrides").get();if(a.exists){const e=a.data();return e?.overrides||{}}return{}}catch(e){return console.warn("Failed to load GUI schema overrides:",e.message),{}}})();Te=t;const s=j()(Oe).length>0||j()(Te).length>0;if(De&&!e&&((new Date).getTime()-De.lastUpdated.getTime())/1e3<De.ttl)return Be(De.schema);try{const e=await ke();return De={schema:e,lastUpdated:new Date,ttl:300},Be(e)}catch(e){return console.error("Error fetching schema from Firestore:",e),De?Be(De.schema):s?Be({}):{collections:{},meta:{},layers:{autoDetected:{},codeOverrides:{},guiOverrides:{}}}}},Be=e=>{var t,r;const s=JSON.parse(d()(e)),n=JSON.parse(d()(Oe)),i=JSON.parse(d()(Te)),a=JSON.parse(d()(e)),o=Re({},Oe);_()(t=j()(Te)).call(t,e=>{if(o[e]){const t=o[e],r=Te[e];let s=[],n={};I()(t)?s=t:t&&"object"==typeof t&&(s=t.fields||[],n={title:t.title,titleTemplate:t.titleTemplate,ignoreFields:t.ignoreFields||[],includeFields:t.includeFields||[]});let i=[],a={};I()(r)?i=r:r&&"object"==typeof r&&(i=r.fields||[],a={title:r.title,titleTemplate:r.titleTemplate,ignoreFields:r.ignoreFields||[],includeFields:r.includeFields||[]});const c=[...s];_()(i).call(i,e=>{const t=me()(c).call(c,t=>t.name===e.name);t>=0?c[t]=Re(Re({},c[t]),e):c.push(e)}),o[e]=Re(Re(Re({},n),a),{},{fields:c})}else o[e]=Te[e]}),_()(r=j()(o)).call(r,e=>{Te[e];const t=o[e];let r=[],s={};I()(t)?r=t:t&&"object"==typeof t&&(r=t.fields||[],s={title:t.title,titleTemplate:t.titleTemplate,ignoreFields:t.ignoreFields||[],includeFields:t.includeFields||[]}),a[e]||(a[e]={fields:[]});const n=a[e]?.fields||[];let i=[];r.length>0?(_()(r).call(r,e=>{const t=he()(n).call(n,t=>t.name===e.name);if(t){const r=Re(Re({},t),e);if(e.validate&&"function"==typeof e.validate&&(r.validate=e.validate.toString()),"array"===r.type){const s=t.validTypes||[],n=e.validTypes||[];n.length>0?r.validTypes=[...new(ve())(n)]:s.length>0&&(r.validTypes=[...new(ve())(s)])}else delete r.validTypes;const s=Ge(r);if(void 0!==e.width){const t=Number(e.width);isNaN(t)||(s.width=Math.max(.08333333,Math.min(1,t)))}i.push(s)}else if(e.type){const t=Re({},e);e.validate&&"function"==typeof e.validate&&(t.validate=e.validate.toString());const r=Ge(t);if(void 0!==r.width){const e=Number(r.width);isNaN(e)||(r.width=Math.max(.08333333,Math.min(1,e)))}i.push(r)}else console.warn(`Override field '${e.name}' has no type and no auto-detected field found. Skipping.`)}),_()(n).call(n,e=>{const t=ne()(r).call(r,t=>t.name===e.name);t||i.push(e)})):i=[...n],a[e]=Re(Re({},a[e]),{},{fields:i},s)}),j()(Me).length>0&&(a._customFields=Me);const c={},l={};for(const[e,t]of re()(a))"_customFields"===e||"_fireengineMeta"===e?l[e]=t:c[e]=t;return{collections:c,meta:l,layers:{autoDetected:s,codeOverrides:n,guiOverrides:i}}},ke=async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(r.bind(r,301)),t=await e(),s=t?(0,Se.getFirestore)(F().app(),t):(0,Se.getFirestore)(F().app()),n=await s.listCollections();if(0===n.length)return{};const i=N()(n).call(n,e=>!qe(e.id)),a=await ye().all(be()(i).call(i,xe()));return We(a)}catch(e){throw console.error("Error fetching schema from Firestore:",e),e}},xe=e=>async t=>{try{let r;const s=["createdAt","created_at","dateCreated","timestamp","_createdAt"];for(const e of s)try{if(r=await t.orderBy(e,"asc").limit(1).get(),!r.empty)break}catch(e){continue}if(!r||r.empty){const r=await t.limit(5).get();if(r.empty)return ye().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[]}});const s={},n=r.docs[0]?.ref;for(const e of r.docs){const t=e._fieldsProto;if(t)for(const[e,r]of re()(t))if(s[e]){if(s[e].valueType!==r.valueType){const t={referenceValue:5,timestampValue:4,integerValue:3,doubleValue:3,stringValue:2,booleanValue:1,nullValue:0},n=t[s[e].valueType]||0;(t[r.valueType]||0)>n&&(s[e]=r)}}else s[e]=r}const i=j()(s).length>0?Ve(s):null,a=n?await n.listCollections():[],o=N()(a).call(a,r=>{const s=`${e?`${e}/`:""}${t.id}/${r.id}`;return!qe(s)}),c=await ye().all(be()(o).call(o,xe(`${e?`${e}/`:""}${t.id}`)));return ye().resolve(Re({[`${e?`${e}/`:""}${t.id}`]:i?{fields:i}:null},We(c)))}if(r.empty)return ye().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[]}});const n=r.docs[0]?._fieldsProto,i=r.docs[0]?.ref,a=i?await i.listCollections():[],o=N()(a).call(a,r=>{const s=`${e?`${e}/`:""}${t.id}/${r.id}`;return!qe(s)}),c=await ye().all(be()(o).call(o,xe(`${e?`${e}/`:""}${t.id}`))),l=n?Ve(n):null;return ye().resolve(Re({[`${e?`${e}/`:""}${t.id}`]:l?{fields:l}:null},We(c)))}catch(r){return console.error(`Error processing collection ${t.id}:`,r),ye().resolve({[`${e?`${e}/`:""}${t.id}`]:{fields:[],error:r.message}})}},Ve=e=>{try{var t;const r=we()(t=j()(e)).call(t,(e,t)=>{const r=["id","name","title"],s=Ae()(r).call(r,e),n=Ae()(r).call(r,t);return-1!==s&&-1!==n?s-n:-1!==s?-1:-1!==n?1:e.localeCompare(t)});return be()(r).call(r,t=>{var r;let s;if("referenceValue"===e[t].valueType){const r=e[t].referenceValue;let n;if(a()(r).call(r,"databases/(default)/documents/")){const e=r.split("databases/(default)/documents/");n=e.length>1?e[e.length-1]:void 0}else if(a()(r).call(r,"documents/")){const e=r.split("documents/");n=e.length>1?e[e.length-1]:void 0}else a()(r).call(r,"/")&&(n=r);if(n){const e=n.split("/");s=N()(e).call(e,(e,t)=>t%2==0).join("/")}}const n=Re(Re(Re({name:t,type:Ke(e[t].valueType)},"mapValue"===e[t].valueType&&{fields:Ve(e[t].mapValue.fields)}),"arrayValue"===e[t].valueType&&Pe()(e[t].arrayValue)&&{validTypes:be()(r=Pe()(e[t].arrayValue)).call(r,e=>Ke(e.valueType))}),s&&{referencePath:s});return Ge(n)})}catch(e){return console.error("Error processing fields:",e),[]}},We=e=>{try{return de()(e).call(e,(e,t)=>Re(Re({},e),t),{})}catch(e){return console.error("Error combining collections:",e),{}}},Ke=e=>"geoPointValue"===e?"geoPoint":"referenceValue"===e?"reference":e.replace("Value","");function Je(e,t){var r=j()(e);if(S()){var s=S()(e);t&&(s=N()(s).call(s,function(t){return R()(e,t).enumerable})),r.push.apply(r,s)}return r}const He=async(e,t,r)=>{try{const s=e.headers.authorization;if(!s||!c()(s).call(s,"Bearer "))return t.status(401).json({error:"No valid authorization token provided"});const n=s.split("Bearer ")[1],i=await F().auth().verifyIdToken(n);e.user=function(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?_()(r=Je(Object(n),!0)).call(r,function(t){q()(e,t,n[t])}):O()?M()(e,O()(n)):_()(s=Je(Object(n))).call(s,function(t){G()(e,t,R()(n,t))})}return e}({uid:i.uid,email:i.email,email_verified:i.email_verified,role:i.role||i.customClaims?.role||""},i),r()}catch(e){return console.error("Authentication error:",e),t.status(401).json({error:"Invalid or expired token"})}},ze=(e,t)=>Boolean(t&&e===t),Ye=(e,t)=>e?ze(e.email||"",t)?"admin":e.role||"":"",Xe=(0,f.Router)({strict:!0}),Ze=Xe;Xe.get("/schema",He,async(e,t)=>{try{const r=process.env.FIREENGINE_OWNER_EMAIL;if(!ze(e.user?.email||"",r)){const s=Ye(e.user,r);if(!s||""===ee()(s).call(s))return t.status(403).json({error:"Access denied",message:"User role required to access schema"})}const s="true"===e.query.refresh,n=await $e(s);return t.json(n)}catch(e){return console.error("Error fetching schema:",e),t.status(500).json({error:"Failed to fetch schema",message:e.message})}}),Xe.post("/schema/refresh",He,async(e,t)=>{try{const r=process.env.FIREENGINE_OWNER_EMAIL;if(!ze(e.user?.email||"",r)){const s=Ye(e.user,r);if(!s||""===ee()(s).call(s))return t.status(403).json({error:"Access denied",message:"User role required to refresh schema"})}Ue();const s=await $e(!0);return t.json({success:!0,message:"Schema cache cleared and refreshed",schema:s})}catch(e){return console.error("Error refreshing schema:",e),t.status(500).json({error:"Failed to refresh schema",message:e.message})}}),Xe.post("/schema-overrides",He,async(e,t)=>{try{const s=process.env.FIREENGINE_OWNER_EMAIL;if(!ze(e.user?.email||"",s)){const r=Ye(e.user,s);if(!r||""===ee()(r).call(r))return t.status(403).json({error:"Access denied",message:"User role required to save schema overrides"})}const{overrides:n}=e.body;if(!n||"object"!=typeof n)return t.status(400).json({error:"Invalid overrides data"});const{getFirestoreDatabaseName:i}=await Promise.resolve().then(r.bind(r,301)),a=await i(),o=a?(0,Se.getFirestore)(F().app(),a):(0,Se.getFirestore)(F().app());return await o.collection("_fireengineMeta").doc("schemaOverrides").set({overrides:n,updatedAt:F().firestore.FieldValue.serverTimestamp(),updatedBy:e.user?.uid||"system"}),(e=>{Te=e||{}})(n),Ue(),t.json({success:!0,message:"Schema overrides saved successfully"})}catch(e){return console.error("Error saving GUI schema overrides:",e),t.status(500).json({error:"Failed to save GUI schema overrides",message:e.message})}});const Qe=async(e,t,s,n)=>{if(!e)return!1;if(ze(e.email||"",n))return!0;const i=Ye(e,n);if(!i||""===ee()(i).call(i))return console.log("Permission denied: User has no role assigned",{user:e.email,uid:e.uid,role:e.role}),!1;const a=await(async(e,t)=>{if(!e)return null;const s=Ye(e,t);if(!s)return null;const n=await(async()=>{try{const{getFirestoreDatabaseName:e}=await Promise.resolve().then(r.bind(r,301)),t=await e(),s=t?(0,Se.getFirestore)(w.app(),t):(0,Se.getFirestore)(w.app()),n=await s.collection("_fireengineMeta").doc("roles").get(),i=[{id:"admin",name:"Admin",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!0,write:!0},settings:{read:!0,write:!0}},predefined:!0},{id:"editor",name:"Editor",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0},{id:"viewer",name:"Viewer",permissions:{content:{},assets:{read:!0,write:!1},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0}];if(n.exists){const e=n.data(),t=e?.customRoles||[];return[...i,...t]}return i}catch(e){return console.error("Error loading roles:",e),[{id:"admin",name:"Admin",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!0,write:!0},settings:{read:!0,write:!0}},predefined:!0},{id:"editor",name:"Editor",permissions:{content:{},assets:{read:!0,write:!0},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0},{id:"viewer",name:"Viewer",permissions:{content:{},assets:{read:!0,write:!1},users:{read:!1,write:!1},settings:{read:!1,write:!1}},predefined:!0}]}})(),i=he()(n).call(n,e=>e.id===s);return i?.permissions||null})(e,n);if(!a&&"admin"===e.role)return!0;if(!a)return!1;if("system:users"===t||"system:assets"===t||"system:settings"===t){const e=a[t.replace("system:","")];return e?.[s]||!1}let o=a.content[t]?.[s]||!1;if(!o){const t=Ye(e,n);("admin"===t||"editor"===t||"viewer"===t&&"read"===s)&&(o=!0)}return o},et=e=>async(t,r,s)=>{try{const n=k(),i=x();if(!0===n.useFirestoreAccessRules)return s();if(!t.user)return r.status(401).json({error:"Authentication required"});if(!await Qe(t.user,e,"read",i))return r.status(403).json({error:"Insufficient permissions",message:`Read access denied for resource: ${e}`});s()}catch(e){return console.error("Permission check error:",e),r.status(500).json({error:"Internal server error"})}},tt=e=>async(t,r,s)=>{try{const n=k(),i=x();if(!0===n.useFirestoreAccessRules)return s();if(!t.user)return r.status(401).json({error:"Authentication required"});if(!await Qe(t.user,e,"write",i))return r.status(403).json({error:"Insufficient permissions",message:`Write access denied for resource: ${e}`});s()}catch(e){return console.error("Permission check error:",e),r.status(500).json({error:"Internal server error"})}},rt=e=>async(t,r,s)=>{try{const n=k(),i=x();if(!0===n.useFirestoreAccessRules)return s();if(!t.user)return r.status(401).json({error:"Authentication required"});const a=t.query.collectionPath||t.body.collectionPath;if(!a||"string"!=typeof a)return r.status(400).json({error:"Collection path is required"});if(c()(a).call(a,"_fireengine"))return s();if(!await Qe(t.user,a,e,i))return r.status(403).json({error:"Insufficient permissions",message:`${e} access denied for collection: ${a}`});s()}catch(e){return console.error("Permission check error:",e),r.status(500).json({error:"Internal server error"})}},st=(0,f.Router)({strict:!0}),nt=st;st.get("/users",He,et("system:users"),async(e,t)=>{try{const e=await it();return t.json(e)}catch(e){return console.error("Error fetching users:",e),t.status(500).json({error:"Failed to fetch users",message:e.message})}}),st.put("/users/:uid",He,tt("system:users"),async(e,t)=>{try{const{uid:r}=e.params,{email:s,displayName:n,disabled:i,emailVerified:a,customClaims:o}=e.body,c={};void 0!==s&&(c.email=s),void 0!==n&&(c.displayName=n),void 0!==i&&(c.disabled=i),void 0!==a&&(c.emailVerified=a);const l=await F().auth().updateUser(r,c);if(void 0!==o){await F().auth().setCustomUserClaims(r,o);const e=await F().auth().getUser(r);return t.json(e)}return t.json(l)}catch(e){return console.error("Error updating user:",e),t.status(500).json({error:"Failed to update user",message:e.message})}}),st.delete("/users/:uid",He,tt("system:users"),async(e,t)=>{try{const{uid:r}=e.params;return await F().auth().deleteUser(r),t.json({success:!0,message:"User deleted successfully"})}catch(e){return console.error("Error deleting user:",e),t.status(500).json({error:"Failed to delete user",message:e.message})}}),st.post("/users",He,tt("system:users"),async(e,t)=>{try{const{email:r,password:s,displayName:n,emailVerified:i=!1,disabled:a=!1,customClaims:o}=e.body;if(!r)return t.status(400).json({error:"Email is required"});const c={email:r,emailVerified:i,disabled:a};s&&(c.password=s),n&&(c.displayName=n);const l=await F().auth().createUser(c);if(o&&j()(o).length>0){await F().auth().setCustomUserClaims(l.uid,o);const e=await F().auth().getUser(l.uid);return t.json(e)}return t.json(l)}catch(e){return console.error("Error creating user:",e),t.status(500).json({error:"Failed to create user",message:e.message})}});const it=async e=>{try{const t=await F().auth().listUsers(1e3,e),r=t.users||[];if(t.pageToken){const e=await it(t.pageToken);return[...r,...e]}return r}catch(e){throw console.error("Error in listAllUsers:",e),e}},at=require("@babel/runtime-corejs3/helpers/objectWithoutProperties");var ot=r.n(at);const ct=require("@babel/runtime-corejs3/core-js-stable/parse-int");var lt=r.n(ct);const dt=["id"];function ut(e,t){var r=j()(e);if(S()){var s=S()(e);t&&(s=N()(s).call(s,function(t){return R()(e,t).enumerable})),r.push.apply(r,s)}return r}function pt(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?_()(r=ut(Object(n),!0)).call(r,function(t){q()(e,t,n[t])}):O()?M()(e,O()(n)):_()(s=ut(Object(n))).call(s,function(t){G()(e,t,R()(n,t))})}return e}const ft=(0,f.Router)({strict:!0}),mt=ft,gt=e=>{if(null==e)return e;const{id:t}=e;return ot()(e,dt)},ht=(e,t)=>{if(null==e)return e;if(I()(e))return be()(e).call(e,e=>ht(e,t));if("object"==typeof e){if(e._path&&e._path.segments&&I()(e._path.segments)&&e.id){const r=e._path.segments;if(r.length>=2&&r.length%2==0)try{const e=pe()(r).call(r,0,-1).join("/"),s=r[r.length-1];return t.collection(e).doc(s)}catch(t){return console.warn("Failed to convert reference-like object to DocumentReference:",t),e}}if(void 0!==e.latitude&&void 0!==e.longitude||void 0!==e._latitude&&void 0!==e._longitude)try{const t=void 0!==e.latitude?e.latitude:e._latitude,s=void 0!==e.longitude?e.longitude:e._longitude,{GeoPoint:n}=r(965);return new n(t,s)}catch(t){return console.warn("Failed to convert GeoPoint-like object:",t),e}if(void 0!==e.seconds&&void 0!==e.nanoseconds||void 0!==e._seconds&&void 0!==e._nanoseconds)try{const t=void 0!==e.seconds?e.seconds:e._seconds,s=void 0!==e.nanoseconds?e.nanoseconds:e._nanoseconds,{Timestamp:n}=r(965);return new n(t,s)}catch(t){return console.warn("Failed to convert Timestamp-like object:",t),e}if(e instanceof Date||"string"==typeof e&&!isNaN(Date.parse(e)))try{const t=e instanceof Date?e:new Date(e),{Timestamp:s}=r(965);return s.fromDate(t)}catch(t){return console.warn("Failed to convert Date to Timestamp:",t),e}const s={};for(const[r,n]of re()(e))s[r]=ht(n,t);return s}return e};ft.get("/firestore/documents",He,rt("read"),async(e,t)=>{try{const n=e.query.collectionPath,i=e.query.search||"",o=e.query.limit?lt()(e.query.limit.toString(),10):null,c=e.query.offset?lt()(e.query.offset.toString(),10):0;if(!n)return t.status(400).json({error:"Missing collectionPath parameter"});const l=await zt(),d=l?(0,Se.getFirestore)(F().app(),l):(0,Se.getFirestore)(F().app());try{var r;const e=d.collection(n.toString()),l=await e.get();if(l.empty)return t.status(200).json({documents:[],totalCount:0,hasMore:!1});let u=be()(r=l.docs).call(r,e=>pt({id:e.id},e.data()));if(i&&ee()(i).call(i)){var s;const e=ee()(s=i.toLowerCase()).call(s);u=N()(u).call(u,t=>{var r;const s=["title","name","displayName","text","content","description","email","firstName","lastName","subject","body","message"];return ne()(s).call(s,r=>{const s=t[r];var n;return"string"==typeof s&&a()(n=s.toLowerCase()).call(n,e)})||a()(r=t.id.toLowerCase()).call(r,e)})}const p=u.length;let f=u;if(null!==o){const e=c||0,t=e+o;f=pe()(u).call(u,e,t)}const m=null!==o&&c+o<p;return t.status(200).json({documents:f,totalCount:p,hasMore:m,searchTerm:i||null})}catch(e){return t.status(200).json({documents:[],totalCount:0,hasMore:!1})}}catch(e){return console.error("Error fetching documents:",e),t.status(500).json({error:"Failed to fetch documents",message:e.message||"Unknown error"})}}),ft.get("/firestore/document",He,rt("read"),async(e,t)=>{try{const{collectionPath:r,documentId:s}=e.query;if(!r||!s)return t.status(400).json({error:"Missing required parameters"});const n=await zt(),i=(n?(0,Se.getFirestore)(F().app(),n):(0,Se.getFirestore)(F().app())).collection(r.toString()).doc(s.toString()),a=await i.get();return a.exists?t.json(pt({id:a.id},a.data())):t.status(404).json({error:"Document not found"})}catch(e){return console.error("Error fetching document:",e),t.status(500).json({error:"Failed to fetch document",message:e.message})}}),ft.post("/firestore/document",He,rt("write"),async(e,t)=>{try{const{collectionPath:r,data:s,documentId:n}=e.body;if(!r||!s)return t.status(400).json({error:"Missing required parameters"});const i=await Et(r,s);if(!i.isValid)return t.status(400).json({error:"Validation failed",errors:i.errors});const a=await zt(),o=F().app().options.projectId,c=F().app().options.credential;let l,d=null;if(c&&(c._certificate&&c._certificate.client_email?d=c._certificate.client_email:c.certificate&&c.certificate.client_email?d=c.certificate.client_email:c.clientEmail?d=c.clientEmail:c.client_email&&(d=c.client_email)),d){const e=`firebase-adminsdk-.*@${o}\\.iam\\.gserviceaccount\\.com`;new RegExp(e).test(d)}if(a)try{l=(0,Se.getFirestore)(F().app(),a)}catch(e){throw new Error(`Unable to connect to Firestore database: ${a}`)}else l=(0,Se.getFirestore)(F().app());try{const e=gt(s),i=ht(e,l);let a,o;return n?(a=l.collection(r).doc(n),await a.set(i),o=n):(a=await l.collection(r).add(i),o=a.id),t.json({id:o,success:!0})}catch(e){if(console.error(`Error adding document to ${r}:`,e),5===e.code||"NOT_FOUND"===e.code)return t.status(404).json({error:"Collection or database not found",message:"This might be due to Firestore security rules, invalid project configuration, or authentication issues",details:e.message});if(7===e.code||"PERMISSION_DENIED"===e.code)return t.status(403).json({error:"Permission denied",message:"Firestore security rules are blocking this write operation",details:e.message});throw e}}catch(e){return console.error("Error adding document:",e),t.status(500).json({error:"Failed to add document",message:e.message||"Unknown error",code:e.code||"UNKNOWN"})}});const Et=async(e,t)=>{const r={};try{const s=(await $e()).collections[e];if(!s||!s.fields)return{isValid:!0,errors:{}};for(const e of s.fields){const s=t[e.name];if(!e.required||null!=s&&""!==s){if(e.validate&&"string"==typeof e.validate)try{const t=new Function("value",`\n            const validate = ${e.validate};\n            return validate(value);\n          `)(s);null!=t&&!0!==t&&(r[e.name]=String(t))}catch(t){console.error(`Error executing validation for field ${e.name}:`,t),r[e.name]="Validation error"}else{const t=schema.meta._customFields||{};if(e.type&&t[e.type]&&t[e.type].validate)try{const n=t[e.type],i=new Function("value",`\n              const validate = ${n.validate};\n              return validate(value);\n            `)(s);!0!==i&&(r[e.name]=String(i))}catch(t){console.error(`Error executing custom field validation for ${e.name}:`,t),r[e.name]="Custom field validation error"}}if("array"===e.type&&null!=s){const t=I()(s)?s:[];e.min&&t.length<e.min&&(r[e.name]=`Minimum ${e.min} items required`),e.max&&t.length>e.max&&(r[e.name]=`Maximum ${e.max} items allowed`)}}else r[e.name]="This field is required"}return{isValid:0===j()(r).length,errors:r}}catch(e){return console.error("Error during validation:",e),{isValid:!0,errors:{}}}};ft.put("/firestore/document",He,rt("write"),async(e,t)=>{try{const{collectionPath:r,documentId:s,data:n}=e.body;if(!r||!s||!n)return t.status(400).json({error:"Missing required parameters"});const i=await Et(r,n);if(!i.isValid)return t.status(400).json({error:"Validation failed",errors:i.errors});const a=await zt(),o=a?(0,Se.getFirestore)(F().app(),a):(0,Se.getFirestore)(F().app()),c=gt(n),l=ht(c,o),d=o.collection(r).doc(s);return await d.update(l),t.json({id:s,success:!0})}catch(e){return console.error("Error updating document:",e),t.status(500).json({error:"Failed to update document",message:e.message})}}),ft.delete("/firestore/document",He,rt("write"),async(e,t)=>{try{const{collectionPath:r,documentId:s}=e.query;if(!r||!s)return t.status(400).json({error:"Missing required parameters"});const n=await zt(),i=(n?(0,Se.getFirestore)(F().app(),n):(0,Se.getFirestore)(F().app())).collection(r.toString()).doc(s.toString());return await i.delete(),t.json({success:!0})}catch(e){return console.error("Error deleting document:",e),t.status(500).json({error:"Failed to delete document",message:e.message})}}),ft.get("/firestore/test-connection",He,async(e,t)=>{try{const e=await zt(),r=(e?(0,Se.getFirestore)(F().app(),e):(0,Se.getFirestore)(F().app())).collection("_test_connection");return await r.limit(1).get(),t.json({success:!0,message:"Firebase Admin SDK connection is working",projectId:F().app().options.projectId||"unknown",credentialType:F().app().options.credential?.constructor?.name||"unknown"})}catch(e){return console.error("Firebase Admin SDK connection test failed:",e),t.status(500).json({success:!1,error:"Firebase connection failed",message:e.message||"Unknown error",code:e.code||"UNKNOWN",details:"This indicates an issue with Firebase Admin SDK credentials or project configuration"})}});const vt=require("firebase-admin/storage"),It=require("multer");var yt=r.n(It);const _t=require("stream"),bt=yt()({storage:yt().memoryStorage(),limits:{fileSize:52428800}}),Nt=()=>{try{return(0,vt.getStorage)().bucket()}catch(e){throw console.error("Error getting storage bucket:",e),new Error("Storage not configured")}},wt=[bt.array("files",10),async(e,t)=>{try{const{path:r=""}=e.body,s=e.files;if(!s||0===s.length)return t.status(400).json({success:!1,error:"No files provided"});const n=Nt(),i=[];for(const e of s)try{const t=e.originalname,s=r?`${r}/${t}`:t;console.log(`Uploading file: ${s}`);const a=n.file(s),o=new _t.Readable;o.push(e.buffer),o.push(null),await new(ye())((t,r)=>{const s=a.createWriteStream({metadata:{contentType:e.mimetype}});s.on("error",r),s.on("finish",t),o.pipe(s)}),i.push({name:t,path:s,success:!0})}catch(t){console.error(`Error uploading ${e.originalname}:`,t),i.push({name:e.originalname,success:!1,error:t.message})}t.json({success:!0,results:i})}catch(e){console.error("Error uploading files:",e),t.status(500).json({success:!1,error:e.message||"Failed to upload files"})}}],Ft=(0,f.Router)();Ft.get("/storage/list",He,et("system:assets"),async(e,t)=>{try{const{path:r=""}=e.query,s=Nt();console.log(`Listing files in path: ${r}`);const[i]=await s.getFiles({prefix:r?`${r}/`:"",delimiter:"/"}),o={prefix:r?`${r}/`:"",delimiter:"/"},[,,c]=await s.getFiles(o),l=c?.prefixes||[],d=be()(l).call(l,e=>({name:e.replace(r?`${r}/`:"","").replace(/\/$/,""),fullPath:e.replace(/\/$/,""),isFolder:!0})),u=[];for(const e of i){const t=e.name.replace(r?`${r}/`:"","");if(!a()(t).call(t,"/"))try{const[r]=await e.getMetadata(),[s]=await e.getSignedUrl({action:"read",expires:n()()+36e5});u.push({name:t,fullPath:e.name,isFolder:!1,size:lt()(r.size||"0"),timeCreated:r.timeCreated,contentType:r.contentType,downloadURL:s})}catch(r){console.error(`Error getting metadata for ${e.name}:`,r),u.push({name:t,fullPath:e.name,isFolder:!1})}}const p=[...d,...u];t.json({success:!0,items:p})}catch(e){console.error("Error listing files:",e),t.status(500).json({success:!1,error:e.message||"Failed to list files"})}}),Ft.post("/storage/upload",He,tt("system:assets"),...wt),Ft.delete("/storage/file",He,tt("system:assets"),async(e,t)=>{try{const{filePath:r}=e.body;if(!r)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Deleting file: ${r}`);const s=Nt().file(r);await s.delete(),t.json({success:!0,message:"File deleted successfully"})}catch(e){console.error("Error deleting file:",e),t.status(500).json({success:!1,error:e.message||"Failed to delete file"})}}),Ft.get("/storage/download-url",He,et("system:assets"),async(e,t)=>{try{const{filePath:r}=e.query;if(!r)return t.status(400).json({success:!1,error:"File path is required"});const s=Nt().file(r),[i]=await s.getSignedUrl({action:"read",expires:n()()+36e5});t.json({success:!0,downloadURL:i})}catch(e){console.error("Error getting download URL:",e),t.status(500).json({success:!1,error:e.message||"Failed to get download URL"})}}),Ft.get("/storage/metadata",He,et("system:assets"),async(e,t)=>{try{const{filePath:r}=e.query;if(!r)return t.status(400).json({success:!1,error:"File path is required"});console.log(`Getting metadata for: ${r}`);const s=Nt().file(r),[n]=await s.getMetadata();t.json({success:!0,metadata:{name:n.name,size:lt()(n.size||"0"),timeCreated:n.timeCreated,contentType:n.contentType,etag:n.etag}})}catch(e){console.error("Error getting file metadata:",e),t.status(500).json({success:!1,error:e.message||"Failed to get file metadata"})}}),Ft.post("/storage/folder",He,tt("system:assets"),async(e,t)=>{try{const{folderPath:r}=e.body;if(!r)return t.status(400).json({success:!1,error:"Folder path is required"});console.log(`Creating folder: ${r}`);const s=Nt(),n=`${r}/.fireengine-folder`,i=s.file(n);await i.save("",{metadata:{contentType:"text/plain"}}),t.json({success:!0,message:"Folder created successfully",folderPath:r})}catch(e){console.error("Error creating folder:",e),t.status(500).json({success:!1,error:e.message||"Failed to create folder"})}}),Ft.post("/storage/move",He,tt("system:assets"),async(e,t)=>{try{const{sourcePath:r,destinationPath:s}=e.body;if(!r||!s)return t.status(400).json({success:!1,error:"Source path and destination path are required"});console.log(`Moving from: ${r} to: ${s}`);const n=Nt(),i=n.file(r),[a]=await i.exists();if(a){const e=n.file(s);return await i.copy(e),await i.delete(),void t.json({success:!0,message:"File moved successfully",sourcePath:r,destinationPath:s})}const[o]=await n.getFiles({prefix:r+"/"});if(0===o.length)return t.status(404).json({success:!1,error:"Source file or folder not found"});console.log(`Moving folder with ${o.length} files`);let c=0;for(const e of o)try{const t=s+"/"+e.name.replace(r+"/",""),i=n.file(t);await e.copy(i),await e.delete(),c++}catch(t){console.error(`Error moving file ${e.name}:`,t)}t.json({success:!0,message:`Folder moved successfully (${c} files)`,sourcePath:r,destinationPath:s})}catch(e){console.error("Error moving file/folder:",e),t.status(500).json({success:!1,error:e.message||"Failed to move file/folder"})}}),Ft.post("/storage/move-bulk",He,tt("system:assets"),async(e,t)=>{try{const{moves:r}=e.body;if(!r||!I()(r)||0===r.length)return t.status(400).json({success:!1,error:"Moves array is required"});console.log(`Moving ${r.length} files`);const s=Nt(),n=[];for(const e of r)try{const{sourcePath:t,destinationPath:r}=e;if(!t||!r){n.push({sourcePath:t,destinationPath:r,success:!1,error:"Source path and destination path are required"});continue}const i=s.file(t),a=s.file(r),[o]=await i.exists();if(!o){n.push({sourcePath:t,destinationPath:r,success:!1,error:"Source file not found"});continue}await i.copy(a),await i.delete(),n.push({sourcePath:t,destinationPath:r,success:!0})}catch(t){console.error(`Error moving file ${e.sourcePath}:`,t),n.push({sourcePath:e.sourcePath,destinationPath:e.destinationPath,success:!1,error:t.message||"Failed to move file"})}const i=N()(n).call(n,e=>e.success).length,a=n.length-i;t.json({success:0===a,message:0===a?`All ${i} files moved successfully`:`${i} files moved successfully, ${a} failed`,results:n})}catch(e){console.error("Error moving files:",e),t.status(500).json({success:!1,error:e.message||"Failed to move files"})}});const At=Ft;var jt=r(575);function Pt(e,t){var r=j()(e);if(S()){var s=S()(e);t&&(s=N()(s).call(s,function(t){return R()(e,t).enumerable})),r.push.apply(r,s)}return r}function St(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?_()(r=Pt(Object(n),!0)).call(r,function(t){q()(e,t,n[t])}):O()?M()(e,O()(n)):_()(s=Pt(Object(n))).call(s,function(t){G()(e,t,R()(n,t))})}return e}const Ct=(0,f.Router)();Ct.post("/billing/create-checkout",He,async(e,t)=>{try{const{priceId:r}=e.body;if(!r)return t.status(400).json({error:"Price ID is required"});const s=await K.installationService.getInstallation(),n=`${e.protocol}://${e.get("host")}/settings/account`,i=`${jt.PADDLE_CONFIG.licenseApiUrl}/checkout`,a={priceId:r,installationId:s.installationId,domain:s.domain,userEmail:e.user?.email,userDisplayName:e.user?.name||e.user?.displayName,environment:s.environment,version:s.version,returnUrl:n},o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Origin:`${e.protocol}://${e.get("host")}`},body:d()(a)});if(!o.ok){const e=await o.json();throw new Error(e.error||"Checkout worker request failed")}const c=await o.json();t.json({checkoutUrl:c.checkoutUrl,transactionId:c.transactionId,environment:c.environment,returnUrl:n})}catch(e){t.status(500).json({error:"Failed to create checkout session",message:e instanceof Error?e.message:"Unknown error"})}}),Ct.post("/billing/checkout-success",He,async(e,t)=>{try{const{sessionId:r,subscriptionId:s}=e.body;if(!r&&!s&&!e.body.provider)return t.status(400).json({error:"Session ID, Subscription ID, or provider is required"});const i=await K.installationService.getInstallation();let a=s;if(r&&!s)try{const t={sessionId:r,installationId:i.installationId,domain:i.domain,version:i.version},s=`${jt.PADDLE_CONFIG.licenseApiUrl}/session`,n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Origin:`${e.protocol}://${e.get("host")}`},body:d()(t)});n.ok?a=(await n.json()).subscriptionId:(console.warn("Could not retrieve subscription ID from session, using session ID as fallback"),a=r)}catch(e){console.warn("Error retrieving subscription ID from session:",e),a=r}if("paddle"===e.body.provider){const{transactionId:t,customerId:r}=e.body;a=!s||"{subscription_id}"===s||"{{subscription_id}}"===s||c()(s).call(s,"pending_")?t||`paddle_temp_${n()()}`:s}const o="paddle"===e.body.provider&&(c()(a).call(a,"paddle_temp_")||c()(a).call(a,"txn_")),l={installationId:i.installationId,subscriptionId:a,plan:o?"pro":"pending",status:"active",lastValidated:new Date,features:o?{unlimitedUsers:!0,schemaOverrides:!0,customRoles:!0,advancedAuth:!0}:{},checkoutSessionId:r,provider:e.body.provider||"paddle",transactionId:e.body.transactionId,customerId:e.body.customerId};await K.installationService.updateLicenseBinding(l),t.json({success:!0,message:"Subscription activated successfully!",subscriptionId:a})}catch(e){console.error("Checkout success handling failed:",e),t.status(500).json({error:"Failed to process successful checkout",message:e instanceof Error?e.message:"Unknown error"})}}),Ct.get("/billing/subscription",He,async(e,t)=>{try{const e=await K.installationService.getLicenseBinding(),r=await K.installationService.getInstallation();let s=e;if(e.subscriptionId)try{const t={subscriptionId:e.subscriptionId,installationId:r.installationId,domain:r.domain,version:r.version},n=await fetch(jt.PADDLE_CONFIG.licenseApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(t)});if(n.ok){const t=await n.json();if(t.valid){const r=St(St({},e),{},{subscriptionId:t.subscriptionId||e.subscriptionId,plan:t.plan,status:"active",features:t.features||{},validUntil:t.validUntil?new Date(t.validUntil):null,gracePeriodEnd:t.gracePeriodEnd?new Date(t.gracePeriodEnd):null,lastValidated:new Date});t.subscriptionId&&(t.subscriptionId,e.subscriptionId),await K.installationService.updateLicenseBinding(r),s=r}else{const t=St(St({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await K.installationService.updateLicenseBinding(t),s=t}}else{const t=await n.text();console.error("Worker validation failed:",n.status,t);const r=St(St({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await K.installationService.updateLicenseBinding(r),s=r}}catch(t){console.error("Error validating license with worker:",t);const r=St(St({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null,lastValidated:new Date});await K.installationService.updateLicenseBinding(r),s=r}else s=St(St({},e),{},{plan:"free",status:"inactive",features:{},validUntil:null,gracePeriodEnd:null});const n={subscription:s.subscriptionId?{id:s.subscriptionId,status:s.status,plan:s.plan,validUntil:s.validUntil,lastValidated:s.lastValidated}:null};t.json(n)}catch(e){console.error("Subscription status error:",e),t.status(500).json({error:"Failed to get subscription status"})}}),Ct.post("/billing/customer-portal",He,async(e,t)=>{try{if(!e.user)return t.status(401).json({error:"Unauthorized"});const r=(await K.installationService.getLicenseBinding()).subscriptionId;if(!r)return console.error("No subscription ID in license data"),t.status(404).json({error:"No subscription ID found"});if(c()(r).call(r,"txn_"))return t.status(202).json({error:"Subscription still being created",message:"Your subscription is being set up. The billing portal will be available shortly. Please try again in a few minutes.",transactionId:r,retryAfter:300});const s={subscriptionId:r,returnUrl:`${e.protocol}://${e.get("host")}/settings/account`},n=await fetch(`${jt.PADDLE_CONFIG.licenseApiUrl}/customer-portal`,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(s)});if(!n.ok){const e=await n.json().catch(()=>({message:"Failed to create portal session"}));return console.error("Worker portal session error:",e),t.status(n.status).json({error:e.message||"Failed to create customer portal session"})}const i=await n.json();t.json(i)}catch(e){console.error("Customer portal error:",e),t.status(500).json({error:"Failed to access customer portal"})}});const Rt=Ct;function Dt(e,t){var r=j()(e);if(S()){var s=S()(e);t&&(s=N()(s).call(s,function(t){return R()(e,t).enumerable})),r.push.apply(r,s)}return r}function Ot(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?_()(r=Dt(Object(n),!0)).call(r,function(t){q()(e,t,n[t])}):O()?M()(e,O()(n)):_()(s=Dt(Object(n))).call(s,function(t){G()(e,t,R()(n,t))})}return e}const Tt=(0,f.Router)();Tt.get("/license/status",He,async(e,t)=>{try{const e=await K.installationService.getInstallation(),r=await K.installationService.getLicenseBinding(),s=await Y.validateLicense();t.json({installation:{id:e.installationId,domain:e.domain,environment:e.environment,createdAt:e.createdAt,version:e.version},license:{plan:r.plan,status:r.status,validUntil:r.validUntil,lastValidated:r.lastValidated,subscriptionId:r.subscriptionId},validation:{valid:s.valid,reason:s.reason,checkedAt:new Date}})}catch(e){console.error("License status error:",e),t.status(500).json({error:"Failed to get license status"})}}),Tt.get("/installation/info",He,async(e,t)=>{try{const e=await K.installationService.getInstallationSummary();t.json(e)}catch(e){console.error("Installation info error:",e),t.status(500).json({error:"Failed to get installation info"})}}),Tt.get("/license/debug",He,async(e,t)=>{try{const e=await K.installationService.getInstallation(),r=await K.installationService.getLicenseBinding(),s=await Y.validateLicense(),n=e.ownerEmail&&process.env.FIREENGINE_OWNER_EMAIL===e.ownerEmail;t.json({debug:{database:{installation:{installationId:e.installationId,ownerEmail:e.ownerEmail,domain:e.domain,environment:e.environment},license:{subscriptionId:r.subscriptionId,plan:r.plan,status:r.status,validUntil:r.validUntil,lastValidated:r.lastValidated,features:r.features}},environment:{FIREENGINE_OWNER_EMAIL:process.env.FIREENGINE_OWNER_EMAIL,NODE_ENV:"production"},computed:{isOwner:n,ownerStatus:n?"OWNER EMAIL MATCH - ADMIN PERMISSIONS ONLY":"Not owner"},validation:{valid:s.valid,plan:s.plan,reason:s.reason,features:s.features}}})}catch(e){console.error("License debug error:",e),t.status(500).json({error:"Failed to get license debug info"})}}),Tt.post("/license/transfer-from-default",He,async(e,t)=>{try{const{getFirestore:s}=await Promise.resolve().then(r.t.bind(r,965,23)),n=await Promise.resolve().then(r.t.bind(r,675,23));await K.installationService.getInstallation(),console.log(" Attempting license transfer from default to configured database");const i=n.default.firestore().collection("_fireengineMeta").doc("license"),a=await i.get();if(!a.exists)return t.json({success:!1,message:"No license document found in default database"});const o=a.data();console.log(" Found license in default database:",o),await K.installationService.updateLicenseBinding(o),!0===e.body.deleteFromDefault&&(await i.delete(),console.log(" Deleted license from default database")),t.json({success:!0,message:"License transferred successfully",licenseData:o})}catch(e){console.error("License transfer error:",e),t.status(500).json({error:"Failed to transfer license"})}}),Tt.post("/license/validate-now",He,async(e,t)=>{try{const{installationService:e}=await Promise.resolve().then(r.bind(r,615)),{PADDLE_CONFIG:s}=await Promise.resolve().then(r.bind(r,575)),n=await e.getInstallation(),i=await e.getLicenseBinding();if(!i.subscriptionId)return t.json({error:"No subscription ID found"});const a={subscriptionId:i.subscriptionId,installationId:n.installationId,domain:n.domain,version:n.version};console.log(" Manual validation request:",a);const o=await fetch(s.licenseApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:d()(a)}),c=await o.json();if(console.log(" Manual validation result:",c),o.ok&&c.valid){const r=Ot(Ot({},i),{},{plan:c.plan,features:c.features||i.features,validUntil:c.validUntil?new Date(c.validUntil):i.validUntil,lastValidated:new Date});return await e.updateLicenseBinding(r),t.json({success:!0,before:i,after:r,validationResult:c})}t.json({success:!1,validationResult:c,responseStatus:o.status})}catch(e){console.error(" Manual validation failed:",e),t.status(500).json({error:e.message})}}),Tt.post("/license/update-plan",He,async(e,t)=>{try{const{plan:r,features:s,validUntil:n,gracePeriodEnd:i}=e.body;if(!r)return t.status(400).json({error:"Plan is required"});const a=await K.installationService.getLicenseBinding(),o=Ot(Ot({},a),{},{plan:r,features:s||a.features,validUntil:n?new Date(n):a.validUntil,gracePeriodEnd:i?new Date(i):a.gracePeriodEnd,lastValidated:new Date});await K.installationService.updateLicenseBinding(o),t.json({success:!0,message:"License plan updated successfully",plan:o.plan})}catch(e){console.error("License plan update error:",e),t.status(500).json({error:"Failed to update license plan"})}}),Tt.post("/license/clear-cache",He,async(e,t)=>{try{return t.status(403).json({error:"Not allowed in production"})}catch(e){console.error("Clear cache error:",e),t.status(500).json({error:"Failed to clear cache"})}});const Mt=Tt,Lt=(0,E.compose)([Z,Ze,nt,mt,At,Rt,Mt]);var Gt=r(896);const Ut=require("zlib");var qt=r(128),$t=r(139);const Bt=require("@babel/runtime-corejs3/core-js-stable/parse-float");var kt=r.n(Bt);const xt=require("@babel/runtime-corejs3/core-js-stable/instance/ends-with");var Vt=r.n(xt);const Wt=e=>{var t;const r=ee()(t=e.toString()).call(t).toUpperCase(),s=kt()(r);return Vt()(r).call(r,"GB")?Math.round(1024*s*1024*1024):Vt()(r).call(r,"MB")?Math.round(1024*s*1024):Vt()(r).call(r,"KB")?Math.round(1024*s):(Vt()(r).call(r,"B"),Math.round(s))},Kt=e=>{const t=(e=>{const t=[],s=[],n=(e=>{const t=[];if(!e)return t.push("Firebase Admin SDK credentials are required"),{isValid:!1,errors:t};if("object"==typeof e){var s,n;const r=["project_id","private_key","client_email"],i=N()(r).call(r,t=>!e[t]);i.length>0&&t.push(`Missing required Admin SDK fields: ${i.join(", ")}`),e.private_key&&!a()(s=e.private_key).call(s,"BEGIN PRIVATE KEY")&&t.push("Invalid private key format - should be a PEM private key"),e.client_email&&!a()(n=e.client_email).call(n,"@")&&t.push("Invalid client_email format")}else if("string"==typeof e){Vt()(e).call(e,".json")||t.push("Admin credentials file path should point to a .json file");try{const s=r(896);if(s.existsSync(e))try{const r=s.readFileSync(e,"utf8"),n=JSON.parse(r),i=["project_id","private_key","client_email"],a=N()(i).call(i,e=>!n[e]);a.length>0&&t.push(`Admin credentials file is missing required fields: ${a.join(", ")}`)}catch(e){t.push("Admin credentials file contains invalid JSON")}else t.push(`Admin credentials file does not exist: ${e}`)}catch(e){t.push("Unable to verify admin credentials file existence")}}else t.push("Admin credentials should be an object or file path string");return{isValid:0===t.length,errors:t}})(e.adminCredentials),i=n.isValid;i||(t.push(...n.errors),s.push("Firebase Admin SDK credentials"));const o=(e=>{const t=[];if(!e)return t.push("Firebase Web App configuration is required"),{isValid:!1,errors:t};if("object"==typeof e){var s,n;const r=["apiKey","authDomain"],i=N()(r).call(r,t=>!e[t]);i.length>0&&t.push(`Missing required Web App config fields: ${i.join(", ")}`),e.apiKey&&(!c()(s=e.apiKey).call(s,"AIza")||e.apiKey.length<30)&&t.push("Invalid API key format"),e.authDomain&&!a()(n=e.authDomain).call(n,".")&&t.push("Invalid auth domain format")}else if("string"==typeof e){Vt()(e).call(e,".json")||t.push("Web app config file path should point to a .json file");try{const s=r(896);if(s.existsSync(e))try{var i,o;const r=s.readFileSync(e,"utf8"),n=JSON.parse(r),l=["apiKey","authDomain"],d=N()(l).call(l,e=>!n[e]);d.length>0&&t.push(`Web app config file is missing required fields: ${d.join(", ")}`),n.apiKey&&(!c()(i=n.apiKey).call(i,"AIza")||n.apiKey.length<30)&&t.push("Invalid API key format in config file"),n.authDomain&&!a()(o=n.authDomain).call(o,".")&&t.push("Invalid auth domain format in config file")}catch(e){t.push("Web app config file contains invalid JSON")}else t.push(`Web app config file does not exist: ${e}`)}catch(e){t.push("Unable to verify web app config file existence")}}else t.push("Web app config should be an object or file path string");return{isValid:0===t.length,errors:t}})(e.webappConfig,e.adminCredentials),l=o.isValid;l||(t.push(...o.errors),s.push("Firebase Web App configuration"));const d=(e=>{const t=[];return e?(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)||t.push("Invalid owner email format"),{isValid:0===t.length,errors:t}):(t.push("Owner email is required for initial admin access"),{isValid:!1,errors:t})})(e.ownerEmail||""),u=d.isValid;u||(t.push(...d.errors),s.push("Owner email address"));const p=i&&l&&u,f=(e=>{const t={};if(e.adminCredentials){if(e.adminCredentials){const s=[];if("string"==typeof e.adminCredentials)try{const t=r(896),n=r(928).resolve(e.adminCredentials),i=t.readFileSync(n,"utf8"),a=JSON.parse(i);a.project_id||process.env.FIREENGINE_FIREBASE_PROJECT_ID||s.push("FIREENGINE_FIREBASE_PROJECT_ID (or project_id in credentials file)"),a.client_email||s.push("FIREENGINE_FIREBASE_CLIENT_EMAIL"),a.private_key||s.push("FIREENGINE_FIREBASE_PRIVATE_KEY")}catch(e){s.push("FIREENGINE_ADMIN_CREDENTIALS_FILE (invalid or missing file)")}else"object"==typeof e.adminCredentials&&(e.adminCredentials.project_id||process.env.FIREENGINE_FIREBASE_PROJECT_ID||s.push("FIREENGINE_FIREBASE_PROJECT_ID (or project_id in credentials file)"),e.adminCredentials.client_email||s.push("FIREENGINE_FIREBASE_CLIENT_EMAIL"),e.adminCredentials.private_key||s.push("FIREENGINE_FIREBASE_PRIVATE_KEY"));s.length>0&&(t.adminCredentials=s)}}else t.adminCredentials=["FIREENGINE_ADMIN_CREDENTIALS_FILE (path to JSON file)","OR individual variables:","  - FIREENGINE_FIREBASE_PROJECT_ID","  - FIREENGINE_FIREBASE_CLIENT_EMAIL","  - FIREENGINE_FIREBASE_PRIVATE_KEY"];if(e.webappConfig){if(e.webappConfig){const s=[];if("string"==typeof e.webappConfig)try{const t=r(896),n=r(928).resolve(e.webappConfig),i=t.readFileSync(n,"utf8"),a=JSON.parse(i);a.apiKey||s.push("FIREENGINE_WEBAPP_API_KEY"),a.authDomain||s.push("FIREENGINE_WEBAPP_AUTH_DOMAIN")}catch(e){s.push("FIREENGINE_WEBAPP_CONFIG_FILE (invalid or missing file)")}else"object"==typeof e.webappConfig&&(e.webappConfig.apiKey||s.push("FIREENGINE_WEBAPP_API_KEY"),e.webappConfig.authDomain||s.push("FIREENGINE_WEBAPP_AUTH_DOMAIN"));s.length>0&&(t.webappConfig=s)}}else t.webappConfig=["FIREENGINE_WEBAPP_CONFIG_FILE (path to JSON file)","OR individual variables:","  - FIREENGINE_WEBAPP_API_KEY","  - FIREENGINE_WEBAPP_AUTH_DOMAIN"];return e.ownerEmail||(t.ownerEmail=["FIREENGINE_OWNER_EMAIL"]),j()(t).length>0?t:void 0})(e);return{isValid:p,missingItems:s,configStatus:{adminCredentials:i,webappConfig:l,ownerEmail:u},errors:t,missingEnvVars:f}})(e);return{isConfigured:t.isValid,configStatus:t.configStatus,missingItems:t.missingItems,errors:t.errors,missingEnvVars:t.missingEnvVars,canProceed:t.configStatus.adminCredentials&&t.configStatus.webappConfig}};let Jt;(new Date).toISOString();let Ht=!1;const zt=async()=>{if(Jt)return Jt;if(!Ht){Ht=!0;try{const e=await(async()=>{try{return}catch(e){return}})();return Jt=e,e}catch(e){return}}return Jt},Yt=(e={})=>{const t=m()(),s=(0,qt._m)(e);(0,qt.Jk)();const n=Kt(s);if(s.adminCredentials&&!F().apps.length)try{let e;if("string"==typeof s.adminCredentials){const t=r(896),n=r(928).resolve(s.adminCredentials);if(console.log(" Loading admin credentials from file:",n),!t.existsSync(n))throw new Error(`Admin credentials file not found: ${n}`);const i=t.readFileSync(n,"utf8");e=JSON.parse(i)}else e=s.adminCredentials;if(e&&!e.project_id){const t=s.webappConfig?.projectId||process.env.FIREENGINE_FIREBASE_PROJECT_ID;if(!t)throw new Error("project_id is required in admin credentials or FIREENGINE_FIREBASE_PROJECT_ID environment variable");e.project_id=t}const t={credential:e?F().credential.cert(e):F().credential.applicationDefault(),projectId:s.webappConfig?.projectId,storageBucket:s.webappConfig?.storageBucket};F().initializeApp(t),(0,$t._A)(s.firestoreDatabase)}catch(e){console.error(" Error initializing Firebase Admin SDK:",e),console.log(" Configuration validation will handle incomplete setup")}else s.adminCredentials||(console.log("  Firebase Admin SDK not initialized - admin credentials not configured"),n.isConfigured||(console.log(" Missing items:",n.missingItems.join(", ")),console.log(" Onboarding page will be shown to configure the system")));Jt=s.firestoreDatabase;const i=(e=>{const t=5368709120,r=t;if(void 0!==e){const r="string"==typeof e?Wt(e):e;if(r>0&&r<=t)return r;if(r>t)return t}const s=process.env.FIREENGINE_STORAGE_MAX_UPLOAD_SIZE;if(s)try{const e=Wt(s);if(e>0&&e<=t)return e;if(e>t)return t}catch(e){}const n=(()=>{const e=process.env.NODE_OPTIONS;if(!e)return;const t=e.match(/--max-old-space-size[=\s](\d+)/);return t&&t[1]?lt()(t[1],10):void 0})();if(n&&n>0){const e=Math.round(1024*n*1024*.8);if(e<t)return e}return r})(s.storageMaxUploadSize);var o,l;return(e=>{B=function(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?_()(r=$(Object(n),!0)).call(r,function(t){q()(e,t,n[t])}):O()?M()(e,O()(n)):_()(s=$(Object(n))).call(s,function(t){G()(e,t,R()(n,t))})}return e}({},e)})({ownerEmail:s.ownerEmail,useFirestoreAccessRules:!0===s.useFirestoreAccessRules,webappConfig:s.webappConfig,storageMaxUploadSizeBytes:i}),K.installationService.setConfig(s),s.schemaOverrides&&(o=s.schemaOverrides,Oe=o||{}),s.customFields&&(e=>{var t;const r=e?de()(t=re()(e)).call(t,(e,[t,r])=>(e[t]=Re(Re({},r),{},{name:r.name||t,render:"function"==typeof r.render?r.render.toString():r.render,renderInput:"function"==typeof r.renderInput?r.renderInput.toString():r.renderInput,renderOutput:"function"==typeof r.renderOutput?r.renderOutput.toString():r.renderOutput,validate:r.validate&&"function"==typeof r.validate?r.validate.toString():r.validate}),e),{}):{};Me=r})(s.customFields),s.ignoreCollections&&(l=s.ignoreCollections,Le=l||[]),t.use(m().json()),t.use(m().urlencoded({extended:!0})),t.use("/api",Lt),t.get("/admin.js*",(e,t)=>{const r=p().join(__dirname,"admin/index.js");try{var s;const n=(0,Gt.statSync)(r),i=`"${n.size}-${n.mtime.getTime()}"`;if(e.headers["if-none-match"]===i)return t.status(304).end();if(e.headers["accept-encoding"]&&a()(s=e.headers["accept-encoding"]).call(s,"gzip")){t.set({"Content-Type":"application/javascript","Content-Encoding":"gzip","Cache-Control":"public, max-age=31536000, immutable",ETag:i,Vary:"Accept-Encoding"});const e=(0,Gt.createReadStream)(r),s=(0,Ut.createGzip)({level:6});e.pipe(s).pipe(t)}else t.set({"Content-Type":"application/javascript","Cache-Control":"public, max-age=31536000, immutable",ETag:i}),t.sendFile(r)}catch(e){console.error("Error serving admin.js:",e),t.status(500).send("Error loading admin script")}}),t.get("/locales/*.json",(e,t)=>{t.sendFile(p().join(__dirname,`locales/${e.originalUrl.split("/").pop()}`))}),t.get("*",async(e,t,n)=>{var a;if(c()(a=e.path).call(a,"/api/"))return n();const o=Kt(s);let l=s.webappConfig;if("string"==typeof l)try{const e=r(896),t=r(928).resolve(l);if(console.log(" Loading webapp config from file:",t),e.existsSync(t)){const r=e.readFileSync(t,"utf8");l=JSON.parse(r),console.log(" Successfully loaded webapp config from file")}else console.error(` Webapp config file not found: ${t}`),l=null}catch(e){console.error(" Error loading webapp config file:",e),l=null}const u={webappConfig:l,basePath:e.baseUrl||"",googleMapsApiKey:s.googleMapsApiKey||"",googleMapsOptions:s.googleMapsOptions||{},ignoreCollections:s.ignoreCollections||[],useFirestoreAccessRules:!0===s.useFirestoreAccessRules,ownerEmail:s.ownerEmail||null,storageMaxUploadSizeBytes:i,isConfigured:o.isConfigured,configStatus:o.configStatus,missingItems:o.missingItems,configErrors:o.errors,missingEnvVars:o.missingEnvVars},p=h().replace("{fireenging-base-path}",e.baseUrl).replace('src="admin.js"','src="admin.js?v=1.0.11"').replace("{fireengine-config}",d()(u));t.send(p)}),t}},304:e=>{"use strict";e.exports=require("firebase/auth")},316:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/entries")},323:e=>{e.exports='<!DOCTYPE html> <html lang="en"> <head> <base href="{fireenging-base-path}/"> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1"/> <title>FireEngine</title> <link rel="icon" href="data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><text y=\'0.9em\' font-size=\'90\'></text></svg>"> </head> <body> <noscript>You need to enable JavaScript to run this app.</noscript> <div id="root"></div> <script> var fireengineConfig = {fireengine-config}; <\/script> <script src="admin.js"><\/script> </body> </html> '},335:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/for-each")},405:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor")},464:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/json/stringify")},471:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/define-property")},497:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols")},575:(e,t,r)=>{"use strict";r.d(t,{PADDLE_CONFIG:()=>s});const s={licenseApiUrl:(()=>{try{return"https://license.fireengine.dev"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_LICENSE_API_URL||"https://license.fireengine.dev"})(),clientToken:(()=>{try{return"live_2cb28d6b5be3b98a622666387b4"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_CLIENT_TOKEN||"MISSING_PADDLE_CLIENT_TOKEN"})(),environment:"undefined"!=typeof process?"production":"sandbox",prices:{pro_monthly:(()=>{try{return"pri_01k2men96wsraycwnkr2682pky"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_PRICE_PRO_MONTHLY||"MISSING_PADDLE_PRICE_MONTHLY"})(),pro_annual:(()=>{try{return"pri_01k2meq2g0ye64acqynetdsef2"}catch{}return"undefined"!=typeof process&&process.env&&process.env.REACT_APP_PADDLE_PRICE_PRO_ANNUAL||"MISSING_PADDLE_PRICE_ANNUAL"})()},products:{pro:{name:"FireEngine Pro",description:"Complete solution for growing teams and organizations",features:["Unlimited users","Advanced authentication (SAML, OIDC, Phone)","Custom roles and permissions","Schema customization","Unlimited storage","Analytics and audit logs","API access and webhooks","Custom branding","Priority support"],pricing:{monthly:{amount:54,currency:"USD"},annual:{amount:49,currency:"USD",totalAmount:588}}}}}},615:(e,t,r)=>{"use strict";r.d(t,{installationService:()=>U});var s=r(497),n=r.n(s),i=r(86),a=r.n(i),o=r(405),c=r.n(o),l=r(335),d=r.n(l),u=r(718),p=r.n(u),f=r(691),m=r.n(f),g=r(471),h=r.n(g),E=r(668),v=r.n(E),I=r(16),y=r.n(I),_=r(464),b=r.n(_),N=r(41),w=r.n(N),F=r(316),A=r.n(F),j=r(875),P=r.n(j);const S=require("uuid"),C=require("os"),R=require("crypto");var D=r(139);var O=r(128);function T(e,t){var r=y()(e);if(n()){var s=n()(e);t&&(s=a()(s).call(s,function(t){return c()(e,t).enumerable})),r.push.apply(r,s)}return r}function M(e){for(var t=1;t<arguments.length;t++){var r,s,n=null!=arguments[t]?arguments[t]:{};t%2?d()(r=T(Object(n),!0)).call(r,function(t){v()(e,t,n[t])}):p()?m()(e,p()(n)):d()(s=T(Object(n))).call(s,function(t){h()(e,t,c()(n,t))})}return e}class L{constructor(){v()(this,"installationCache",null),v()(this,"licenseCache",null),v()(this,"config",null)}getDb(){return(0,D.xL)()}setConfig(e){this.config=(0,O._m)(e||{})}async getInstallation(){if(this.installationCache)return this.installationCache;const e=this.getDb().collection("_fireengineMeta").doc("installation"),t=await e.get();if(t.exists){const e=M(M({},t.data()),{},{createdAt:t.data().createdAt.toDate()});return this.installationCache=e,e}const r=await this.createInstallation();return this.installationCache=r,r}async createInstallation(){const e=(0,S.v4)(),t=this.generateServerFingerprint(),r=this.detectDomain(),s=this.detectEnvironment(r),n={installationId:e,domain:r,createdAt:new Date,serverFingerprint:t,ownerEmail:this.config?.ownerEmail||"",version:"1.0.11",environment:s},i=this.getDb().collection("_fireengineMeta").doc("installation");return await i.set(n),n}generateServerFingerprint(){const e={hostname:C.hostname(),platform:C.platform(),arch:C.arch(),networkInterfaces:y()(C.networkInterfaces()),cpus:C.cpus().length};return R.createHash("sha256").update(b()(e)).digest("hex").substring(0,16)}detectDomain(){return process.env.FIREENGINE_DOMAIN||C.hostname()}detectEnvironment(e){return w()(e).call(e,"localhost")||w()(e).call(e,"127.0.0.1")?"development":w()(e).call(e,"staging")||w()(e).call(e,"dev")||w()(e).call(e,"test")?"staging":"production"}async getLicenseBinding(){if(this.licenseCache)return this.licenseCache;const e=this.getDb().collection("_fireengineMeta").doc("license"),t=await e.get();if(t.exists){const e=M(M({},t.data()),{},{lastValidated:t.data().lastValidated.toDate(),validUntil:t.data().validUntil?.toDate(),gracePeriodEnd:t.data().gracePeriodEnd?.toDate()});return this.licenseCache=e,e}const r={installationId:(await this.getInstallation()).installationId,plan:"free",status:"active",lastValidated:new Date,features:{advancedAuth:!1,customRoles:!1,schemaOverrides:!1,apiAccess:!1,unlimitedUsers:!1,unlimitedStorage:!1}};return await this.updateLicenseBinding(r),r}async updateLicenseBinding(e){const t={};for(const[r,s]of A()(e))void 0!==s&&(t[r]=s);const r=this.getDb().collection("_fireengineMeta").doc("license");await r.set(t),this.licenseCache=e}async canTransferInstallation(){const e=await this.getInstallation(),t=await this.getLicenseBinding();return P()()-e.createdAt.getTime()<864e5||"inactive"===t.status}async validateInstallation(){try{const e=await this.getInstallation(),t=this.generateServerFingerprint();return e.serverFingerprint!==t&&console.warn("  Server fingerprint changed - this might indicate installation transfer"),{valid:!0}}catch(e){return console.error("Installation validation failed:",e),{valid:!1,reason:"validation_error"}}}async getInstallationSummary(){const e=await this.getInstallation(),t=await this.getLicenseBinding();return{installationId:e.installationId,domain:e.domain,environment:e.environment,createdAt:e.createdAt,version:e.version,plan:t.plan,status:t.status,lastValidated:t.lastValidated,validUntil:t.validUntil}}clearCache(){this.installationCache=null,this.licenseCache=null}}let G=null;const U={setConfig:e=>{G||(G=new L),G.setConfig(e)},getInstallation:async()=>(G||(G=new L),G.getInstallation()),getLicenseBinding:async()=>(G||(G=new L),G.getLicenseBinding()),updateLicenseBinding:async e=>(G||(G=new L),G.updateLicenseBinding(e)),canTransferInstallation:async()=>(G||(G=new L),G.canTransferInstallation()),validateInstallation:async()=>(G||(G=new L),G.validateInstallation()),getInstallationSummary:async()=>(G||(G=new L),G.getInstallationSummary()),clearCache:()=>(G||(G=new L),G.clearCache())}},668:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/helpers/defineProperty")},675:e=>{"use strict";e.exports=require("firebase-admin")},691:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/define-properties")},718:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors")},875:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/date/now")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")},965:e=>{"use strict";e.exports=require("firebase-admin/firestore")},982:e=>{"use strict";e.exports=require("@babel/runtime-corejs3/core-js-stable/instance/map")}},s={};function n(e){var t=s[e];if(void 0!==t)return t.exports;var i=s[e]={exports:{}};return r[e](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(r,s){if(1&s&&(r=this(r)),8&s)return r;if("object"==typeof r&&r){if(4&s&&r.__esModule)return r;if(16&s&&"function"==typeof r.then)return r}var i=Object.create(null);n.r(i);var a={};e=e||[null,t({}),t([]),t(t)];for(var o=2&s&&r;("object"==typeof o||"function"==typeof o)&&!~e.indexOf(o);o=t(o))Object.getOwnPropertyNames(o).forEach(e=>a[e]=()=>r[e]);return a.default=()=>r,n.d(i,a),i},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i=n(301);module.exports=i.default})();